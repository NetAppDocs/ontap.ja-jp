---
permalink: consistency-groups/protect-task.html 
sidebar: sidebar 
keywords: application protection, two-phase commit, 2 phase, smbc, async snapmirror, local, remote, snapshot, asynchronous, svm disaster recovery, snapmirror 
summary: 整合性グループを使用して、ローカル スナップショット、SnapMirror 非同期、SnapMirror アクティブ シンク、および SVM ディザスタ リカバリを使用してデータを保護します。 
---
= ONTAPコンシステンシグループを保護する
:hardbreaks:
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
整合性グループを使用すると、複数のボリュームにまたがるSAN、NAS、NVMeのアプリケーションのローカルとリモートの保護を簡単に管理できます。

整合性グループを作成しても、保護が自動的に有効になるわけではありません。保護ポリシーは、整合性グループの作成時または作成後に設定できます。整合性グループは次の方法で保護できます。

* ローカル Snapshot
* SnapMirrorアクティブ同期（9.15.1より前のONTAPバージョンではSnapMirrorビジネス継続性と呼ばれます）
* xref:index.html#mcc[MetroCluster（9.11.1以降）]
* SnapMirror非同期（9.13.1以降）
* 非同期SVMディザスタ リカバリ（9.14.1以降）


ネストされた整合性グループを使用している場合は、親整合性グループと子整合性グループに別々の保護ポリシーを設定できます。

ONTAP 9.11.1以降、整合グループは<<two-phase,2フェーズ整合性グループSnapshotの作成>>を提供します。2フェーズのSnapshotオペレーションでは事前チェックが実行され、Snapshotが正常にキャプチャされたことが確認されます。

リカバリは、コンシステンシ・グループ全体、階層構成内の単一のコンシステンシ・グループ、またはコンシステンシ・グループ内の個々のボリュームに対して実行できます。リカバリは、リカバリ元のコンシステンシ・グループを選択し、スナップショットの種類を選択し、復元のベースとなるスナップショットを特定することで実行できます。このプロセスの詳細については、link:../task_dp_restore_from_vault.html["以前のスナップショットからボリュームをリストアする"]を参照してください。



== ローカルスナップショットポリシーを設定する

ローカルのSnapshot保護ポリシーを設定すると、整合性グループ内のすべてのボリュームに適用するポリシーを作成できます。

.タスク概要
整合性グループでサポートされる最小スナップショットスケジュールは30分です。これはlink:https://www.netapp.com/media/12385-tr4571.pdf["FlexGroupボリュームのテスト"^]に基づいています。整合性グループと同じSnapshotインフラストラクチャを共有しています。

[role="tabbed-block"]
====
.System Manager
--
.手順
. *Storage > Consistency groups*を選択します。
. 整合性グループ メニューから作成した整合性グループを選択します。
. 整合性グループの概要ページの右上で、*編集*を選択します。
. *Schedule Snapshots (local)* の横にあるボックスをオンにします。
. スナップショットポリシーを選択します。新しいカスタムポリシーを設定するには、link:../task_dp_create_custom_data_protection_policies.html["カスタムデータ保護ポリシーを作成する"]を参照してください。
. *保存*を選択します。
. 整合性グループの概要メニューに戻ります。左側の列の*スナップショット（ローカル）*の下のimage:../media/icon_shield.png["盾アイコン"]の横に、ステータスが「保護」と表示されます。


--
.CLI
--
ONTAP 9.14.1以降では、CLIを使用して整合性グループの保護ポリシーを変更できます。

.開始する前に
* このタスクを実行するには、admin権限レベルが必要です。
* ONTAP 9.15.1以降では、admin権限レベルのすべてのユーザがこのタスクを実行できます。ONTAP 9.14.1では、このタスクを実行するには、クラスタ管理者またはSVMの管理者である必要があります。


.手順
. 次のコマンドを実行して、保護ポリシーを設定または変更します。
+
子整合性グループの保護ポリシーを変更する場合は、 `-parent-consistency-group _parent_consistency_group_name_`パラメータを使用して親整合性グループを識別する必要があります。

+
`consistency-group modify -vserver _svm_name_ -consistency-group _consistency_group_name_ -snapshot-policy _policy_name_`



--
====


== オンデマンドスナップショットを作成する

通常のスケジュールされたポリシー以外で整合性グループのスナップショットを作成する必要がある場合は、オンデマンドで作成できます。

[role="tabbed-block"]
====
.System Manager
--
.手順
. *ストレージ* > *整合性グループ* に移動します。
. オンデマンド スナップショットを作成する整合性グループを選択します。
. *Snapshot コピー* タブに切り替えて、*+ 追加* を選択します。
. *名前*と*SnapMirrorラベル*を入力します。*一貫性*のドロップダウンメニューで、*アプリケーション一貫性*または*クラッシュ一貫性*を選択します。
. *保存*を選択します。


--
.CLI
--
ONTAP 9.14.1 以降では、CLI を使用してコンシステンシー グループのオンデマンド スナップショットを作成できます。

.開始する前に
* このタスクを実行するには、admin権限レベルが必要です。
* ONTAP 9.15.1以降では、admin権限レベルのすべてのユーザがこのタスクを実行できます。ONTAP 9.14.1では、このタスクを実行するには、クラスタ管理者またはSVMの管理者である必要があります。


.手順
. Snapshotを作成します：
+
デフォルトでは、スナップショットの種類は「crash consistent state（障害など予期しないシャットダウン時と同様）」の状態です。オプションの `-type`パラメータを使用してスナップショットの種類を変更できます。

+
`consistency-group snapshot create -vserver _svm_name_ -consistency-group _consistency_group_name_ -snapshot _snapshot_name_`



--
====


== 2フェーズでの整合性グループのSnapshot作成

ONTAP 9.11.1以降、整合性グループでは、整合性グループ（CG）Snapshotコピーの作成時に2フェーズコミットがサポートされます。これにより、Snapshotコピーをコミットする前に事前チェックが実行されます。この機能は、ONTAP REST APIでのみ使用できます。

2フェーズCGスナップショット作成は、スナップショット作成にのみ使用でき、整合性グループのプロビジョニングや整合性グループの復元には使用できません。

2フェーズCGスナップショットでは、スナップショット作成プロセスが2つのフェーズに分割されます。

. 最初のフェーズでは、APIは事前チェックを実行し、Snapshotの作成をトリガーします。最初のフェーズには、Snapshotが正常にコミットされるまでの時間を指定するタイムアウト パラメータが含まれています。
. フェーズ1の要求が正常に完了した場合、最初のフェーズから指定された間隔内に2番目のフェーズを呼び出して、Snapshotを適切なエンドポイントにコミットできます。


.開始する前に
* 2フェーズCGスナップショット作成を使用するには、クラスタ内のすべてのノードでONTAP 9.11.1以降が実行されている必要があります。
* 整合性グループインスタンスでは、1フェーズまたは2フェーズを問わず、一度に1つのアクティブな整合性グループスナップショット操作の呼び出しのみがサポートされます。別のスナップショット操作の実行中にスナップショット操作を呼び出そうとすると、失敗します。
* スナップショット作成を呼び出す際に、5～120秒のタイムアウト値を任意で設定できます。タイムアウト値を指定しない場合、操作はデフォルトの7秒でタイムアウトします。APIでは、 `action_timeout`パラメータを使用してタイムアウト値を設定します。CLIでは、 `-timeout`フラグを使用します。


.手順
2フェーズスナップショットはREST API、またはONTAP 9.14.1以降ではONTAP CLIを使用して実行できます。この操作はSystem Managerではサポートされていません。


NOTE: APIを使用してスナップショットの作成を呼び出した場合は、APIを使用してスナップショットをコミットする必要があります。CLIを使用してスナップショットの作成を呼び出した場合は、CLIを使用してスナップショットをコミットする必要があります。これらのメソッドを混在させることはサポートされていません。

[role="tabbed-block"]
====
.CLI
--
ONTAP 9.14.1 以降では、CLI を使用して 2 フェーズ スナップショットを作成できます。

.開始する前に
* このタスクを実行するには、admin権限レベルが必要です。
* ONTAP 9.15.1以降では、admin権限レベルのすべてのユーザがこのタスクを実行できます。ONTAP 9.14.1では、このタスクを実行するには、クラスタ管理者またはSVMの管理者である必要があります。


.手順
. Snapshotを開始します：
+
`consistency-group snapshot start -vserver _svm_name_ -consistency-group _consistency_group_name_ -snapshot _snapshot_name_ [-timeout _time_in_seconds_ -write-fence {true|false}]`

. Snapshotが取得されたことを確認します：
+
`consistency-group snapshot show`

. Snapshotをコミットします：
+
`consistency-group snapshot commit _svm_name_ -consistency-group _consistency_group_name_ -snapshot _snapshot_name_`



--
.API
--
. スナップショットの作成を呼び出します。 `action=start`パラメータを使用して、整合性グループのエンドポイントにPOSTリクエストを送信します。
+
[source, curl]
----
curl -k -X POST 'https://<IP_address>/application/consistency-groups/<cg-uuid>/snapshots?action=start&action_timeout=7' -H "accept: application/hal+json" -H "content-type: application/json" -d '
{
  "name": "<snapshot_name>",
  "consistency_type": "crash",
  "comment": "<comment>",
  "snapmirror_label": "<SnapMirror_label>"
}'
----
. POSTリクエストが成功した場合、出力にはスナップショットのUUIDが含まれます。そのUUIDを使用してPATCHリクエストを送信し、スナップショットをコミットします。
+
[source, curl]
----
curl -k -X PATCH 'https://<IP_address>/application/consistency-groups/<cg_uuid>/snapshots/<snapshot_id>?action=commit' -H "accept: application/hal+json" -H "content-type: application/json"

For more information about the ONTAP REST API, see link:https://docs.netapp.com/us-en/ontap-automation/reference/api_reference.html[API reference^] or the link:https://devnet.netapp.com/restapi.php[ONTAP REST API page^] at the NetApp Developer Network for a complete list of API endpoints.
----


--
====


== 整合性グループに対するリモート保護の設定

整合性グループは、SnapMirrorアクティブ同期のほか、ONTAP 9.13.1以降ではSnapMirror非同期によってリモート保護を提供します。



=== SnapMirrorアクティブ同期による保護の設定

SnapMirror Active Syncを使用すると、整合性グループ上に作成された整合性グループのSnapshotが宛先にコピーされることを確認できます。SnapMirror Active Syncの詳細、またはCLIを使用してSnapMirror Active Syncを設定する方法については、xref:../task_san_configure_protection_for_business_continuity.html[ビジネス継続性のための保護の設定]を参照してください。

.開始する前に
* NASアクセス用にマウントされたボリュームではSnapMirrorアクティブ同期関係を確立できません。
* ソース クラスタとデスティネーション クラスタのポリシー ラベルが一致している必要があります。
* SnapMirror Active Syncは、SnapMirrorラベル付きのルールが定義済み `AutomatedFailOver`ポリシーに追加され、そのラベルを使用してSnapshotが作成されない限り、デフォルトでSnapshotを複製しません。
+
このプロセスの詳細については、link:../task_san_configure_protection_for_business_continuity.html["SnapMirrorアクティブ同期による保護"]を参照してください。

* xref:../data-protection/supported-deployment-config-concept.html[カスケード展開] はSnapMirrorアクティブ同期ではサポートされません。
* ONTAP 9.13.1以降では、アクティブなSnapMirror Active Sync関係を使用して、無停止でxref:modify-task.html#add-volumes-to-a-consistency-group[整合性グループにボリュームを追加する]できます。コンシステンシーグループにその他の変更を加える場合は、SnapMirror Active Sync関係を解除し、コンシステンシーグループを変更した上で、関係を再確立して再同期する必要があります。



TIP: CLIを使用してSnapMirrorアクティブ同期を設定するには、xref:../task_san_configure_protection_for_business_continuity.html[SnapMirrorアクティブ同期による保護]を参照してください。

.System Managerでの手順
. link:../snapmirror-active-sync/prerequisites-reference.html["SnapMirrorアクティブ同期を使用するための前提条件"]を満たしていることを確認してください。
. *Storage > Consistency groups*を選択します。
. 整合性グループ メニューから作成した整合性グループを選択します。
. 概要ページの右上で、[*詳細*] を選択し、[*保護*] を選択します。
. System Managerはソース側の情報を自動入力します。適切なクラスタとストレージVMをデスティネーションとして選択します。保護ポリシーを選択します。*関係を初期化する*がチェックされていることを確認してください。
. *保存*を選択します。
. 整合性グループを初期化して同期する必要があります。*整合性グループ*メニューに戻り、同期が正常に完了したことを確認してください。*SnapMirror（リモート）*ステータスに `Protected`がimage:../media/icon_shield.png["盾アイコン"]の横に表示されます。




=== SnapMirror非同期の設定

ONTAP 9.13.1以降では、単一のコンシステンシグループに対してSnapMirror非同期保護を設定できます。ONTAP 9.14.1以降では、SnapMirror非同期を使用して、コンシステンシグループの関係を使用してボリューム単位のスナップショットをデスティネーション クラスタに複製できます。

.タスク概要
ボリューム単位のスナップショットをレプリケートするには、ONTAP 9.14.1以降を実行している必要があります。MirrorAndVaultポリシーとVaultポリシーの場合、ボリューム単位のスナップショットポリシーのSnapMirrorラベルがコンシステンシグループのSnapMirrorポリシールールと一致する必要があります。ボリューム単位のスナップショットは、コンシステンシグループのSnapMirrorポリシーの保持値に従います。この値は、コンシステンシグループのスナップショットとは独立して計算されます。例えば、デスティネーションに2つのスナップショットを保持するポリシーがある場合、ボリューム単位のスナップショットを2つとコンシステンシグループのスナップショットを2つ保持できます。

ボリューム単位のSnapshotを持つSnapMirror関係を再同期する際に、 `-preserve`フラグを使用してボリューム単位のSnapshotを保持できます。整合性グループのSnapshotよりも新しいボリューム単位のSnapshotが保持されます。整合性グループのSnapshotがない場合、再同期処理でボリューム単位のSnapshotを転送することはできません。

.開始する前に
* SnapMirror非同期保護は単一の整合性グループでのみ利用可能です。階層型整合性グループではサポートされていません。階層型整合性グループを単一の整合性グループに変換するには、xref:modify-geometry-task.html[整合性グループのアーキテクチャを変更する]を参照してください。
* ソース クラスタとデスティネーション クラスタのポリシー ラベルが一致している必要があります。
* アクティブなSnapMirror非同期関係でxref:modify-task.html#add-volumes-to-a-consistency-group[整合性グループにボリュームを追加する]を無停止で実行できます。整合性グループにその他の変更を加える場合は、SnapMirror関係を解除し、整合性グループを変更した上で、関係を再確立して再同期する必要があります。
* SnapMirror非同期保護が有効になっている整合性グループには、異なる制限があります。詳細については、xref:limits.html[整合性グループの制限]をご覧ください。
* 複数の個別ボリュームに対してSnapMirror非同期保護関係を設定している場合、既存のスナップショットを保持したまま、それらのボリュームを整合性グループに変換できます。ボリュームを正常に変換するには：
+
** ボリュームの共通Snapshotコピーが必要です。
** 既存のSnapMirror関係を解除し、xref:configure-task.html[ボリュームを単一の整合性グループに追加する]次のワークフローを使用して関係を再同期する必要があります。




.手順
. デスティネーション クラスタから、*ストレージ > 整合性グループ*を選択します。
. 整合性グループ メニューから作成した整合性グループを選択します。
. 概要ページの右上で、[*詳細*] を選択し、[*保護*] を選択します。
. System Managerはソース側の情報を自動入力します。適切なクラスタとストレージVMをデスティネーションとして選択します。保護ポリシーを選択します。*関係を初期化する*がチェックされていることを確認してください。
+
非同期ポリシーを選択する場合は、**転送スケジュールを上書きする**オプションがあります。

+

NOTE: SnapMirror非同期を使用した整合性グループに設定可能な最短スケジュール（目標復旧時点、RPO）は30分です。

. *保存*を選択します。
. 整合性グループを初期化して同期する必要があります。*整合性グループ*メニューに戻り、同期が正常に完了したことを確認してください。*SnapMirror（リモート）*ステータスに `Protected`がimage:../media/icon_shield.png["盾アイコン"]の横に表示されます。




=== SVMディザスタ リカバリの設定

ONTAP 9.14.1以降、xref:../data-protection/snapmirror-svm-replication-concept.html#[SVMディザスタ リカバリ]はコンシステンシ グループをサポートし、ソース クラスタからデスティネーション クラスタへコンシステンシ グループ情報をミラーリングできます。

すでにコンシステンシー グループが含まれている SVM で SVM ディザスタ リカバリを有効にする場合は、xref:../task_dp_configure_storage_vm_dr.html[System Manager]またはxref:../data-protection/replicate-entire-svm-config-task.html[ONTAP CLI]の SVM 構成ワークフローに従います。

アクティブで正常なSVMディザスタリカバリ関係にあるSVMにコンシステンシグループを追加する場合は、デスティネーション クラスタからSVMディザスタリカバリ関係を更新する必要があります。詳細については、xref:../data-protection/update-replication-relationship-manual-task.html[レプリケーション関係の手動更新]を参照してください。コンシステンシグループを拡張するたびに、関係を更新する必要があります。

.制限事項
* SVMディザスタ リカバリでは、階層型整合性グループはサポートされません。
* SVMディザスタ リカバリでは、SnapMirror非同期で保護された整合性グループはサポートされません。SVMディザスタ リカバリを設定する前に、SnapMirror関係を解除する必要があります。
* どちらのクラスタでも、ONTAP 9.14.1以降が実行されている必要があります。
* 整合性グループが含まれるSVMディザスタ リカバリ構成では、ファンアウト関係はサポートされません。
* その他の制限については、xref:limits.html[整合性グループの制限]を参照してください。




== 関係の可視化

System Managerは、*保護 > 関係*メニューでLUNマップを視覚化します。ソース関係を選択すると、System Managerはソース関係の視覚化を表示します。ボリュームを選択すると、これらの関係をさらに詳しく調べて、含まれるLUNとイニシエータ グループの関係のリストを確認できます。この情報は、個々のボリューム ビューからExcelワークブックとしてダウンロードできます。ダウンロード処理はバックグラウンドで実行されます。

.関連情報
* link:clone-task.html["整合性グループのクローニング"]
* link:../task_dp_configure_snapshot.html["Snapshotを設定"]
* link:../task_dp_create_custom_data_protection_policies.html["カスタムのデータ保護ポリシーの作成"]
* link:../task_dp_recover_snapshot.html["Snapshotからのリカバリ"]
* link:../task_dp_restore_from_vault.html["以前のスナップショットからボリュームをリストアする"]
* link:../snapmirror-active-sync/index.html["SnapMirrorアクティブ同期の概要"]
* link:https://docs.netapp.com/us-en/ontap-automation/["ONTAP自動化ドキュメント"^]
* xref:../data-protection/snapmirror-disaster-recovery-concept.html[SnapMirror非同期のディザスタ リカバリの基本]

