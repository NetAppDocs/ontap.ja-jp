---
permalink: data-protection/convert-snapmirror-version-flexible-task.html 
sidebar: sidebar 
keywords: convert, exist, dp-type, relationship, xdp 
summary: 既存のDPタイプの関係を簡単にXDPに変換して、バージョンに依存しないSnapMirrorを活用できます。 
---
= 既存のONTAP SnapMirror DPタイプ関係をXDPに変換する
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
ONTAP 9.12.1以降にアップグレードする場合は、アップグレード前にDPタイプの関係をXDPに変換する必要があります。ONTAP 9.12.1以降では、DPタイプの関係はサポートされません。既存のDPタイプの関係を簡単にXDPに変換して、バージョンに依存しないSnapMirrorを活用できます。

ONTAP 9.12.1以降のリリースにアップグレードする前に、既存のDPタイプの関係をXDPに変換する必要があります。

.タスク概要
* SnapMirrorでは、既存のDPタイプの関係をXDPに自動的に変換しません。関係を変換するには、既存の関係を解除して削除し、新しいXDP関係を作成して関係を再同期する必要があります。
* 変換を計画する場合は、XDP SnapMirror関係のバックグラウンドでの準備とデータの保存処理に時間がかかることに注意してください。長時間にわたってSnapMirror関係のステータスが「preparing」と表示されることも珍しくありません。


[NOTE]
====
SnapMirror関係のタイプをDPからXDPに変換すると、オートサイズやスペース ギャランティなどのスペース関連の設定はデスティネーションにレプリケートされなくなります。

====
.手順
. デスティネーション クラスタから、SnapMirror関係がDPタイプ、ミラー状態がSnapMirrored、関係のステータスがIdle、関係が健全であることを確認します。
+
[source, cli]
----
snapmirror show -destination-path <SVM:volume>
----
+
次の例は、 `snapmirror show`コマンドからの出力を示しています：

+
[listing]
----
cluster_dst::>snapmirror show -destination-path svm_backup:volA_dst

Source Path: svm1:volA
Destination Path: svm_backup:volA_dst
Relationship Type: DP
SnapMirror Schedule: -
Tries Limit: -
Throttle (KB/sec): unlimited
Mirror State: Snapmirrored
Relationship Status: Idle
Transfer Snapshot: -
Snapshot Progress: -
Total Progress: -
Snapshot Checkpoint: -
Newest Snapshot: snapmirror.10af643c-32d1-11e3-954b-123478563412_2147484682.2014-06-27_100026
Newest Snapshot Timestamp: 06/27 10:00:55
Exported Snapshot: snapmirror.10af643c-32d1-11e3-954b-123478563412_2147484682.2014-06-27_100026
Exported Snapshot Timestamp: 06/27 10:00:55
Healthy: true
----
+
[NOTE]
====
 `snapmirror show`コマンド出力のコピーを保持しておくと、既存の関係設定を追跡するのに役立ちます。link:https://docs.netapp.com/us-en/ontap-cli//snapmirror-show.html["ONTAPコマンド リファレンス"^]の `snapmirror show`の詳細をご覧ください。

====
. ソース ボリュームとデスティネーション ボリュームの両方に共通のスナップショットがあることを確認します。
+
[source, cli]
----
volume snapshot show -vserver <SVM> -volume <volume>
----
+
次の例は、ソース ボリュームとデスティネーション ボリュームの `volume snapshot show`出力を示しています：

+
[listing]
----
cluster_src:> volume snapshot show -vserver vsm1 -volume volA
---Blocks---
Vserver Volume Snapshot State Size Total% Used%
-------- ------- ------------------------------- -------- -------- ------ -----
svm1 volA
weekly.2014-06-09_0736 valid 76KB 0% 28%
weekly.2014-06-16_1305 valid 80KB 0% 29%
daily.2014-06-26_0842 valid 76KB 0% 28%
hourly.2014-06-26_1205 valid 72KB 0% 27%
hourly.2014-06-26_1305 valid 72KB 0% 27%
hourly.2014-06-26_1405 valid 76KB 0% 28%
hourly.2014-06-26_1505 valid 72KB 0% 27%
hourly.2014-06-26_1605 valid 72KB 0% 27%
daily.2014-06-27_0921 valid 60KB 0% 24%
hourly.2014-06-27_0921 valid 76KB 0% 28%
snapmirror.10af643c-32d1-11e3-954b-123478563412_2147484682.2014-06-27_100026
valid 44KB 0% 19%
11 entries were displayed.


cluster_dest:> volume snapshot show -vserver svm_backup -volume volA_dst
---Blocks---
Vserver Volume Snapshot State Size Total% Used%
-------- ------- ------------------------------- -------- -------- ------ -----
svm_backup volA_dst
weekly.2014-06-09_0736 valid 76KB 0% 30%
weekly.2014-06-16_1305 valid 80KB 0% 31%
daily.2014-06-26_0842 valid 76KB 0% 30%
hourly.2014-06-26_1205 valid 72KB 0% 29%
hourly.2014-06-26_1305 valid 72KB 0% 29%
hourly.2014-06-26_1405 valid 76KB 0% 30%
hourly.2014-06-26_1505 valid 72KB 0% 29%
hourly.2014-06-26_1605 valid 72KB 0% 29%
daily.2014-06-27_0921 valid 60KB 0% 25%
hourly.2014-06-27_0921 valid 76KB 0% 30%
snapmirror.10af643c-32d1-11e3-954b-123478563412_2147484682.2014-06-27_100026
----
. 変換中にスケジュールされた更新が実行されないようにするために、既存のDPタイプの関係を休止します。
+
[source, cli]
----
snapmirror quiesce -source-path <SVM:volume> -destination-path <SVM:volume>
----
+
[NOTE]
====
このコマンドはデスティネーションSVMまたはデスティネーション クラスタから実行する必要があります。

====
+
次の例では、 `svm1`のソース ボリューム `volA`と `svm_backup`のデスティネーション ボリューム `volA_dst`間の関係を休止します：

+
[listing]
----
cluster_dst::> snapmirror quiesce -destination-path svm_backup:volA_dst
----
+
 `snapmirror quiesce`の詳細については、link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-quiesce.html["ONTAPコマンド リファレンス"^]を参照してください。

. 既存のDPタイプの関係を解除します。
+
[source, cli]
----
snapmirror break -destination-path <SVM:volume>
----
+
[NOTE]
====
このコマンドはデスティネーションSVMまたはデスティネーション クラスタから実行する必要があります。

====
+
次の例では、 `svm1`のソース ボリューム `volA`と `svm_backup`のデスティネーション ボリューム `volA_dst`の関係を解除します：

+
[listing]
----
cluster_dst::> snapmirror break -destination-path svm_backup:volA_dst
----
+
 `snapmirror break`の詳細については、link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-break.html["ONTAPコマンド リファレンス"^]を参照してください。

. デスティネーション ボリュームでSnapshotの自動削除が有効になっている場合は、無効にします：
+
[source, cli]
----
volume snapshot autodelete modify -vserver _SVM_ -volume _volume_ -enabled false
----
+
次の例では、デスティネーション ボリューム上のSnapshotの自動削除を無効にします `volA_dst`：

+
[listing]
----
cluster_dst::> volume snapshot autodelete modify -vserver svm_backup -volume volA_dst -enabled false
----
. 既存のDPタイプの関係を削除します。
+
[source, cli]
----
snapmirror delete -destination-path <SVM:volume>
----
+
 `snapmirror-delete`の詳細については、link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-delete.html["ONTAPコマンド リファレンス"^]を参照してください。

+
[NOTE]
====
このコマンドはデスティネーションSVMまたはデスティネーション クラスタから実行する必要があります。

====
+
次の例では、 `svm1`のソース ボリューム `volA`と `svm_backup`のデスティネーション ボリューム `volA_dst`間の関係を削除します：

+
[listing]
----
cluster_dst::> snapmirror delete -destination-path svm_backup:volA_dst
----
. ソースで元のSVMディザスタ リカバリ関係をリリースします。
+
[source, cli]
----
snapmirror release -destination-path <SVM:volume> -relationship-info-only true
----
+
次の例では、SVMディザスタ リカバリ関係をリリースしています。

+
[listing]
----
cluster_src::> snapmirror release -destination-path svm_backup:volA_dst -relationship-info-only true
----
+
 `snapmirror release`の詳細については、link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-release.html["ONTAPコマンド リファレンス"^]を参照してください。

.  `snapmirror show`コマンドから保持した出力を使用して、新しいXDPタイプの関係を作成できます：
+
[source, cli]
----
snapmirror create -source-path <SVM:volume> -destination-path <SVM:volume>  -type XDP -schedule <schedule> -policy <policy>
----
+
新しい関係では、同じソースボリュームとデスティネーションボリュームを使用する必要があります。この手順で説明するコマンドの詳細については、link:https://docs.netapp.com/us-en/ontap-cli/["ONTAPコマンド リファレンス"^]を参照してください。

+
[NOTE]
====
このコマンドはデスティネーションSVMまたはデスティネーション クラスタから実行する必要があります。

====
+
次の例では、SnapMirrorディザスタ リカバリ関係を、 `svm1`のソース ボリューム `volA`と `svm_backup`のデスティネーション ボリューム `volA_dst`の間に、デフォルトの `MirrorAllSnapshots`ポリシーを使用して作成します：

+
[listing]
----
cluster_dst::> snapmirror create -source-path svm1:volA -destination-path svm_backup:volA_dst
-type XDP -schedule my_daily -policy MirrorAllSnapshots
----
. ソース ボリュームとデスティネーション ボリュームを再同期します。
+
[source, cli]
----
snapmirror resync -source-path <SVM:volume> -destination-path <SVM:volume>
----
+
再同期時間を短縮するには、 `-quick-resync`オプションを使用できますが、ストレージ効率の節約が失われる可能性があることに注意してください。

+
[NOTE]
====
このコマンドはデスティネーションSVMまたはデスティネーション クラスタから実行する必要があります。再同期の際にベースライン転送は不要ですが、再同期には時間がかかる場合があります。再同期はオフピークの時間帯に実行することを推奨します。

====
+
次の例では、 `svm1`のソース ボリューム `volA`と `svm_backup`のデスティネーション ボリューム `volA_dst`間の関係を再同期します：

+
[listing]
----
cluster_dst::> snapmirror resync -source-path svm1:volA -destination-path svm_backup:volA_dst
----
+
 `snapmirror resync`の詳細については、link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-resync.html#parameters.html["ONTAPコマンド リファレンス"^]を参照してください。

. スナップショットの自動削除を無効にした場合は、再度有効にします：
+
[source, cli]
----
volume snapshot autodelete modify -vserver <SVM> -volume <volume> -enabled true
----


.終了後の操作
.  `snapmirror show`コマンドを使用して、SnapMirror関係が作成されたことを確認します。
+
 `snapmirror show`の詳細については、link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-show.html["ONTAPコマンド リファレンス"^]を参照してください。

. SnapMirror XDP デスティネーション ボリュームが SnapMirror ポリシーの定義に従ってスナップショットの更新を開始したら、ソース クラスタからの `snapmirror list-destinations`コマンドの出力を使用して、新しい SnapMirror XDP 関係を表示します。


.DP型関係に関する追加情報
ONTAP 9.3 以降では、XDP モードがデフォルトとなり、コマンド ラインまたは新規または既存のスクリプトでの DP モードの呼び出しはすべて自動的に XDP モードに変換されます。

既存の関係は影響を受けません。関係がすでにDPタイプの場合、引き続きDPタイプのままとなります。ONTAP 9.5以降では、データ保護モードが指定されていない場合、または関係タイプとしてXDPモードが指定されている場合、MirrorAndVaultがデフォルトポリシーとなります。以下の表は、想定される動作を示しています。

[cols="3*"]
|===


| 指定するモード | タイプ | デフォルト ポリシー（ポリシーを指定しない場合） 


 a| 
DP
 a| 
XDP
 a| 
MirrorAllSnapshots（SnapMirror DR）



 a| 
なし
 a| 
XDP
 a| 
MirrorAndVault（ユニファイド レプリケーション）



 a| 
XDP
 a| 
XDP
 a| 
MirrorAndVault（ユニファイド レプリケーション）

|===
表に示すように、さまざまな状況でXDPに割り当てられるデフォルトポリシーにより、変換後も以前のタイプとの機能的な同等性が維持されます。もちろん、必要に応じて、統合レプリケーション用のポリシーなど、異なるポリシーを使用することもできます：

[cols="3*"]
|===


| 指定するモード | そしてポリシーは… | 結果は… 


 a| 
DP
 a| 
MirrorAllSnapshots
 a| 
SnapMirror DR



 a| 
XDPDefault
 a| 
SnapVault



 a| 
MirrorAndVault
 a| 
ユニファイド レプリケーション



 a| 
XDP
 a| 
MirrorAllSnapshots
 a| 
SnapMirror DR



 a| 
XDPDefault
 a| 
SnapVault



 a| 
MirrorAndVault
 a| 
ユニファイド レプリケーション

|===
以下は例外です。

* ONTAP 9.3以前のSVMデータ保護関係のデフォルトは引き続きDPモードです。
+
ONTAP 9.4以降では、SVMデータ保護関係のデフォルトがXDPモードに変更されました。

* ルート ボリュームの負荷共有データ保護関係のデフォルト値は引き続きDPモードです。
* ONTAP 9.4以前のSnapLockデータ保護関係のデフォルトは引き続きDPモードです。
+
ONTAP 9.5以降では、SnapLockデータ保護関係のデフォルトがXDPモードに変更されました。

* 次のクラスタ全体のオプションを設定した場合、DPを明示的に指定した場合のデフォルトは引き続きDPモードです。
+
[listing]
----
options replication.create_data_protection_rels.enable on
----
+
DPを明示的に指定しない場合、このオプションは無視されます。



.関連情報
* link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-create.html["snapmirror create"^]
* link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-delete.html["snapmirror delete"^]
* link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-quiesce.html["snapmirror quiesce"^]
* link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-release.html["snapmirror release"^]
* link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-resync.html["snapmirror resync"^]

