---
permalink: data-protection/manage-snapshot-copy-reserve-concept.html 
sidebar: sidebar 
keywords: manage, snapshot, copy, reserve, increase, protected files 
summary: 'スナップショットリザーブは、スナップショット用にディスク容量の一定割合（デフォルトでは5%）を確保します。スナップショットリザーブが使い果たされると、スナップショットはアクティブ ファイル システムの領域を使用するため、必要に応じてスナップショットリザーブを増やすことをお勧めします。また、リザーブがいっぱいになったときにスナップショットを自動的に削除することもできます。' 
---
= ONTAPスナップショット リザーブの管理について学ぶ
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
_スナップショット予約_ は、スナップショット用にディスク容量の一定割合（デフォルトでは5%）を確保します。スナップショット予約が使い果たされると、スナップショットはアクティブ ファイル システムの領域を使用するため、必要に応じてスナップショット予約を増やすことができます。また、予約がいっぱいになったときにスナップショットを自動的に削除することもできます。



== Snapshotリザーブを増やすタイミング

スナップショットの予約容量を増やすかどうかを決める際には、スナップショットは前回のスナップショット作成以降のファイルの変更のみを記録することを覚えておくことが重要です。アクティブ ファイル システム内のブロックが変更または削除された場合にのみ、ディスク容量が消費されます。

つまり、ファイル システムの変更率は、スナップショットが使用するディスク容量を決定する上で重要な要素となります。アクティブ ファイル システムに変更がなければ、スナップショットをいくつ作成してもディスク容量は消費されません。

データベース トランザクション ログを含むFlexVol volumeは、例えば、変更頻度が高いため、スナップショットの予約領域を最大20%に設定する場合があります。データベースへの更新頻度が高いほど、より多くのスナップショットを作成する必要があるだけでなく、スナップショットが消費する追加のディスク容量に対応するために、より大きなスナップショット予約領域を設定することも必要になります。

[TIP]
====
スナップショットは、ブロックのコピーではなく、ブロックへのポインタで構成されます。ポインタはブロックに対する「権利」と考えることができます：ONTAPはスナップショットが削除されるまでブロックを「保持」します。

====
image:how-snapshots-consume-disk-space.gif["Snapshotによって消費されるディスク容量"]



== 保護対象のファイルを削除することで想定よりもファイル スペースが少なくなる仕組み

スナップショットは、ブロックを使用していたファイルを削除した後でも、そのブロックを参照します。そのため、スナップショットの予約領域を使い果たすと、ファイルシステム全体を削除したときに、ファイルシステムが占有していた領域よりも利用可能な領域が少なくなるという、直感に反する結果が生じる可能性があります。

次の例を考えてみましょう。ファイルを削除する前の `df`コマンド出力は次のようになります：

[listing]
----

Filesystem          kbytes  used    avail  capacity
/vol/vol0/          3000000 3000000 0       100%
/vol/vol0/.snapshot 1000000 500000  500000   50%
----
ファイル システム全体を削除し、ボリュームのスナップショットを作成した後、 `df`コマンドは次の出力を生成します：

[listing]
----

Filesystem          kbytes  used    avail  capacity
/vol/vol0/          3000000 2500000 500000   83%
/vol/vol0/.snapshot 1000000 3500000 0       350%
----
出力に示されているように、削除前に使用されていた 0.5 GB に加えて、以前アクティブ ファイル システムで使用されていた 3 GB 全体が現在スナップショットによって使用されています。

スナップショットによって使用されるディスク領域がスナップショット予約領域を超えるため、2.5 GBのオーバーフローがアクティブ ファイル用に予約された領域に「あふれ」、ファイル用に3 GBの空き領域が期待される場所に0.5 GBの空き領域が残ります。

この手順で説明されているコマンドの詳細については、link:https://docs.netapp.com/us-en/ontap-cli/["ONTAPコマンド リファレンス"^]を参照してください。
