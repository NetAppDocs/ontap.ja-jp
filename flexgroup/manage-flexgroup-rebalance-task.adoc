---
permalink: flexgroup/manage-flexgroup-rebalance-task.html 
sidebar: sidebar 
keywords: enable, storage, rebalance, modify, stop, status, flexgroup, volume 
summary: ONTAP 9.12.1以降では、FlexGroup内のコンスティチュエント間でファイルを無停止で移動することにより、FlexGroupボリュームをリバランシングできます。 
---
= ファイルを移動してONTAP FlexGroupボリュームのバランスを再調整する
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
ONTAP 9.12.1以降では、FlexGroup内のコンスティチュエント間でファイルを無停止で移動することにより、FlexGroupボリュームをリバランシングできます。

FlexGroupリバランシングにより、時間の経過に伴って新しいファイルの追加やファイル サイズの増加が原因で不均衡が生じた場合に、容量を再分配することができます。リバランシング処理を手動で開始すると、ファイルが自動で選択されて、無停止で移動されます。

[NOTE]
====
マルチパートinodeを作成したことで、1つまたは複数のリバランシング イベントの一環として大量のファイルが移動される場合に、FlexGroupのリバランシングによりシステムのパフォーマンスが低下することに注意してください。リバランシング イベントの一環として移動されるすべてのファイルは、自身に関連付けられた2つのマルチパートinodeを持ちます。FlexGroupのファイル総数のうち、マルチパートinodeを持つファイル数が占める割合が高いほど、パフォーマンスへの影響が大きくなります。FlexVolからFlexGroupへの変換など、特定のユースケースでは、大量のマルチパートinodeが作成される可能性があります。

====
リバランスは、クラスタ内のすべてのノードでONTAP 9.12.1以降のリリースが実行されている場合にのみ利用できます。リバランス操作を実行するFlexGroupボリュームでは、きめ細かなデータ機能を有効にする必要があります。この機能を有効にすると、このボリュームを削除するか、設定を有効にする前に作成されたスナップショットから復元しない限り、ONTAP 9.11.1以前のバージョンに戻すことはできません。

ONTAP 9.14.1以降では、ONTAPに導入されたアルゴリズムにより、ユーザが操作しなくても、詳細データ機能が有効になっているボリューム内のファイルが、システムの停止を伴わずプロアクティブに移動されます。このアルゴリズムは、きわめて特殊な限られたシナリオで作動し、パフォーマンスのボトルネックを軽減します。このアルゴリズムが機能するシナリオには、クラスタ内の1つのノード上の特定のファイル セットに対する書き込み負荷が非常に高い場合や、非常にホットな親ディレクトリ内のファイルが継続的に増加している場合などがあります。

ONTAP 9.16.1 以降では、link:enable-adv-capacity-flexgroup-task.html["高度な容量バランス調整"]を有効にして、大きなファイルのデータをFlexGroupメンバーボリューム間で再配布することもできます。



== FlexGroupリバランシングに関する考慮事項

FlexGroupリバランシングの仕組みおよび他のONTAP機能との連携を理解しておく必要があります。

* FlexVolからFlexGroupへの変換
+
FlexVol から FlexGroup への変換後に自動 FlexGroup リバランシングを使用しないことを推奨します。代わりに、ONTAP 9.10.1 以降で利用可能な `volume rebalance file-move start` コマンドを使用して既存のファイルを再分配できます。この操作はデフォルトで無停止です(`-is-disruptive false`。一部の使用中のファイルが移動できない場合、計画的なメンテナンスウィンドウ中にディスラプティブモードでコマンドを再実行できます(`-is-disruptive true`。 `volume rebalance file-move start` についての詳細は link:https://docs.netapp.com/us-en/ontap-cli/volume-rebalance-file-move-start.html["ONTAPコマンド リファレンス"^] をご覧ください。

+
自動FlexGroupリバランシング機能によるリバランシングは、FlexVolをFlexGroupに変換し、FlexVol上のデータの50～85%を新しいコンスティチュエントに移動する場合など、大量のファイルを移動する処理ではパフォーマンスの低下を招くことがあります。

* ファイルの最小サイズと最大サイズ
+
自動リバランシングの対象となるファイルは、保存されているブロックに基づいて選択されます。デフォルトでは、リバランシング対象となる最小ファイル サイズは100MB（後述のmin-file-sizeパラメータを使用すると20MBまで低く設定可能）、最大ファイル サイズは100GBです。

* Snapshot 内のファイル
+
FlexGroupリバランスを設定すると、現在どのスナップショットにも存在しないファイルのみを移動対象とすることができます。リバランスが開始されると、リバランス処理中にスナップショット処理がスケジュールされている場合、通知が表示されます。

+
ファイルが移動中で、かつ宛先でフレーミング処理中の場合、Snapshotは制限されます。ファイルの再バランス処理が進行中の場合、Snapshotリストア処理は許可されません。

+
 `granular-data`オプションを有効にした後に作成されたSnapshotは、ONTAP 9.11.1以前のバージョンではマルチパートinodeがサポートされていないため、ONTAP 9.11.1以前のバージョンを実行しているシステムにレプリケートできません。

* SnapMirrorの処理
+
FlexGroupリバランシングは、スケジュールされたSnapMirror処理と次のSnapMirror処理の間に行う必要があります。SnapMirror処理の開始前にファイルを再配置し、そのファイルの移動がSnapMirror再試行期間（24分）内に完了しないと、SnapMirror処理が失敗する場合があります。SnapMirror転送の開始後に開始されたファイルの再配置は失敗しません。

* ファイルベースの圧縮によるStorage Efficiency
+
ファイルベースの圧縮によるストレージ効率では、ファイルは宛先に移動される前に解凍されるため、圧縮による節約は失われます。圧縮による節約は、リバランス後にFlexGroupボリューム上で手動で開始されたバックグラウンドスキャナが実行されると回復します。ただし、いずれかのボリュームのSnapshotに関連付けられているファイルは、圧縮時に無視されます。

* 重複排除
+
重複排除されたファイルを移動すると、FlexGroupボリューム全体の使用量が増加する可能性があります。ファイルの再バランス調整では、一意のブロックのみが移動先に移動され、ソース上のその容量が解放されます。共有ブロックはソースに残り、移動先にコピーされます。これにより、ほぼ満杯になったソース構成体の使用容量を削減するという目標は達成されますが、新しい移動先に共有ブロックのコピーが存在するため、FlexGroupボリューム全体の使用量が増加する可能性があります。これは、Snapshotに含まれるファイルを移動した場合にも発生する可能性があります。Snapshotスケジュールがリサイクルされ、Snapshot内のファイルのコピーがなくなるまで、スペースの節約効果は完全には認識されません。

* FlexCloneボリューム
+
FlexCloneボリュームを作成したときにファイルのリバランシングが実行されていた場合、そのFlexCloneボリュームでリバランシングは実行されません。FlexCloneボリュームでのリバランシングは、ボリュームの作成後に実行する必要があります。

* ファイル移動
+
FlexGroupリバランシング処理中にファイルが移動されると、ソースとデスティネーションの両方のコンスティチュエントでのクォータ計算で、そのファイル サイズが報告されます。移動が完了すると、クォータの計算は通常の状態に戻り、ファイル サイズは新しいデスティネーションでのみ報告されます。

* 自律型ランサムウェア対策
+
ONTAP 9.13.1以降では、システムの停止を伴う / 伴わないリバランシング処理中の自律型ランサムウェア対策がサポートされます。

* オブジェクト ストア ボリューム
+
ボリューム容量のリバランシングは、S3バケットなどのオブジェクト ストア ボリュームではサポートされません。





== FlexGroupリバランシングの有効化

ONTAP 9.12.1以降では、FlexGroupボリュームの自動無停止リバランシングを有効にして、FlexGroupコンスティチュエント間でファイルを再分配できます。

ONTAP 9.13.1以降では、特定の日時に単一のFlexGroupのリバランシング処理を開始するようにスケジュールを設定できます。

.開始する前に
FlexGroupリバランスを有効にする前に、FlexGroupボリュームで `granular-data`オプションを有効にする必要があります。次のいずれかの方法を使用して有効にできます：

* FlexGroupボリュームを `volume create`コマンドを使用して作成すると
*  `volume modify`コマンドを使用して既存のFlexGroupボリュームを変更し、設定を有効にする
*  `volume rebalance`コマンドを使用してFlexGroupリバランスが開始されると自動的に設定されます
+

NOTE: ONTAP 9.16.1 以降を使用しており、link:enable-adv-capacity-flexgroup-task.html["FlexGroupの高度な容量バランス調整"]が ONTAP CLI の `granular-data advanced`オプションまたは System Manager を使用して有効になっている場合は、FlexGroupリバランシングも有効になります。



.手順
FlexGroupリバランシングは、ONTAP System ManagerまたはONTAP CLIを使用して管理できます。

[role="tabbed-block"]
====
.System Manager
--
. *ストレージ > ボリューム* に移動し、再バランス調整するFlexGroupボリュームを見つけます。
. image:icon_dropdown_arrow.gif["ドロップダウンアイコン"]を選択してボリュームの詳細を表示します。
. *FlexGroupバランスステータス*で*リバランス*を選択します。
+

NOTE: *再バランス*オプションは、FlexGroupステータスがバランスが崩れている場合にのみ使用できます。

. * Rebalance Volume *ウィンドウで、必要に応じてデフォルト設定を変更します。
. 再バランス操作をスケジュールするには、* Rebalance Later *を選択し、日時を入力します。


--
.CLI
--
. 自動リバランシングを開始します。
+
[source, cli]
----
volume rebalance start -vserver <SVM name> -volume <volume name>
----
+
必要に応じて次のオプションを指定できます。

+
[[-max-runtime] <time interval>] 最大実行時間

+
[-max-threshold <percent>] コンスティチュエントごとの最大不均衡しきい値

+
[-min-threshold <percent>] 構成要素ごとの最小不均衡しきい値

+
[-max-file-moves <integer>] 構成要素あたりの最大同時ファイル移動数

+
[-min-file-size {<integer>[KB|MB|GB|TB|PB]}] 最小ファイルサイズ

+
[-start-time <mm/dd/yyyy-00:00:00>] リバランスの開始日時をスケジュール

+
[-exclude-snapshots {true|false}] Snapshotに残っているファイルを除外する

+
例：

+
[listing]
----
volume rebalance start -vserver vs0 -volume fg1
----


--
====


== FlexGroupリバランシング設定の変更

FlexGroupリバランス設定を変更することで、不均衡しきい値、同時ファイル移動数、最小ファイルサイズ、最大実行時間を更新したり、スナップショットを含めるか除外するかを選択できます。FlexGroupリバランススケジュールを変更するオプションは ONTAP 9.13.1 以降で利用可能です。

[role="tabbed-block"]
====
.System Manager
--
. *ストレージ > ボリューム* に移動し、再バランス調整するFlexGroupボリュームを見つけます。
. image:icon_dropdown_arrow.gif["ドロップダウンアイコン"]を選択してボリュームの詳細を表示します。
. *FlexGroupバランスステータス*で*リバランス*を選択します。
+

NOTE: *再バランス*オプションは、FlexGroupステータスがバランスが崩れている場合にのみ使用できます。

. * Rebalance Volume *ウィンドウで、必要に応じてデフォルト設定を変更します。


--
.CLI
--
. 自動リバランシングを変更します。
+
[source, cli]
----
volume rebalance modify -vserver <SVM name> -volume <volume name>
----
+
次のオプションを1つ以上指定できます。

+
[[-max-runtime] <time interval>] 最大実行時間

+
[-max-threshold <percent>] コンスティチュエントごとの最大不均衡しきい値

+
[-min-threshold <percent>] 構成要素ごとの最小不均衡しきい値

+
[-max-file-moves <integer>] 構成要素あたりの最大同時ファイル移動数

+
[-min-file-size {<integer>[KB|MB|GB|TB|PB]}] 最小ファイルサイズ

+
[-start-time <mm/dd/yyyy-00:00:00>] リバランスの開始日時をスケジュール

+
[-exclude-snapshots {true|false}] Snapshotに残っているファイルを除外する



--
====


== FlexGroupリバランシングの停止

FlexGroupリバランシングは、有効にしたあとやスケジュールを設定したあとに、いつでも停止できます。

[role="tabbed-block"]
====
.System Manager
--
. *ストレージ > ボリューム* に移動して FlexGroup ボリュームを見つけます。
. image:icon_dropdown_arrow.gif["ドロップダウンアイコン"]を選択してボリュームの詳細を表示します。
. *Stop Rebalance*を選択します。


--
.CLI
--
. FlexGroupリバランシングを停止します。
+
[source, cli]
----
volume rebalance stop -vserver <SVM name> -volume <volume name>
----


--
====


== FlexGroupリバランシングのステータスの表示

FlexGroupリバランシング処理のステータス、設定、処理時間、およびリバランシング インスタンスの詳細を表示できます。

[role="tabbed-block"]
====
.System Manager
--
. *ストレージ > ボリューム* に移動して FlexGroup ボリュームを見つけます。
. image:icon_dropdown_arrow.gif["ドロップダウンアイコン"]を選択すると、FlexGroupの詳細が表示されます。
. *FlexGroupバランスステータス*は、詳細ペインの下部近くに表示されます。
. 最後の再バランス操作に関する情報を表示するには、*Last Volume Rebalance Status* を選択します。


--
.CLI
--
. FlexGroupリバランシング処理のステータスを表示します。
+
[source, cli]
----
volume rebalance show
----
+
リバランシング ステータスの例：

+
[listing]
----
> volume rebalance show
Vserver: vs0
                                                        Target     Imbalance
Volume       State                  Total      Used     Used       Size     %
------------ ------------------ --------- --------- --------- --------- -----
fg1          idle                     4GB   115.3MB         -       8KB    0%
----
+
リバランシング設定の詳細の例：

+
[listing]
----
> volume rebalance show -config
Vserver: vs0
                    Max            Threshold         Max          Min          Exclude
Volume              Runtime        Min     Max       File Moves   File Size    Snapshot
---------------     ------------   -----   -----     ----------   ---------    ---------
fg1                 6h0m0s         5%      20%          25          4KB          true
----
+
リバランシング時間の詳細の例：

+
[listing]
----
> volume rebalance show -time
Vserver: vs0
Volume               Start Time                    Runtime        Max Runtime
----------------     -------------------------     -----------    -----------
fg1                  Wed Jul 20 16:06:11 2022      0h1m16s        6h0m0s
----
+
リバランシング インスタンスの詳細の例：

+
[listing]
----
    > volume rebalance show -instance
    Vserver Name: vs0
    Volume Name: fg1
    Is Constituent: false
    Rebalance State: idle
    Rebalance Notice Messages: -
    Total Size: 4GB
    AFS Used Size: 115.3MB
    Constituent Target Used Size: -
    Imbalance Size: 8KB
    Imbalance Percentage: 0%
    Moved Data Size: -
    Maximum Constituent Imbalance Percentage: 1%
    Rebalance Start Time: Wed Jul 20 16:06:11 2022
    Rebalance Stop Time: -
    Rebalance Runtime: 0h1m32s
    Rebalance Maximum Runtime: 6h0m0s
    Maximum Imbalance Threshold per Constituent: 20%
    Minimum Imbalance Threshold per Constituent: 5%
    Maximum Concurrent File Moves per Constituent: 25
    Minimum File Size: 4KB
    Exclude Files Stuck in snapshots: true
----


--
====