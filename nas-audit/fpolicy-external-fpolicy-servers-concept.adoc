---
permalink: nas-audit/fpolicy-external-fpolicy-servers-concept.html 
sidebar: sidebar 
keywords: fpolicy, works, external fpolicy servers, privileged data access, channels, synchronous communication, connection, credentials, super user 
summary: Storage Virtual Machine（SVM）でFPolicyを設定して有効にすると、SVMに含まれているすべてのノードでFPolicyが実行されるようになります。FPolicyは、外部FPolicyサーバ（FPolicyサーバ）との接続の確立と維持、通知の処理、およびFPolicyサーバとやり取りする通知メッセージの管理を行います。 
---
= ONTAP FPolicyと外部FPolicyサーバの連携
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
Storage Virtual Machine（SVM）でFPolicyを設定して有効にすると、SVMに含まれているすべてのノードでFPolicyが実行されるようになります。FPolicyは、外部FPolicyサーバ（FPolicyサーバ）との接続の確立と維持、通知の処理、およびFPolicyサーバとやり取りする通知メッセージの管理を行います。

さらに、接続管理の一環として、FPolicy には次の責任があります：

* ファイル通知が正しいLIFを通過してFPolicyサーバに送信されるようにする。
* ポリシーに複数のFPolicyサーバが関連付けられている場合に、FPolicyサーバへの通知の送信時にロード バランシングが行われるようにする。
* FPolicyサーバへの接続が切断されたときに再接続を試行する。
* 認証されたセッションを介してFPolicyサーバに通知を送信する。
* パススルー リードが有効な場合にクライアント要求を処理するためにFPolicyサーバによって確立されたパススルー リード データ接続を管理する。




== 制御チャネルを使用したFPolicy通信

FPolicyは、Storage Virtual Machine（SVM）に含まれている各ノードのデータLIFから外部FPolicyサーバへの制御チャネル接続を開始します。FPolicyは制御チャネルを使用してファイル通知を送信するため、FPolicyサーバでは、SVMのトポロジに基づいて複数の制御チャネル接続が認識される場合があります。



== 権限付きデータ アクセス チャネルを使用した同期通信

同期通信では、FPolicyサーバは、特権データ アクセス パスを介してStorage Virtual Machine（SVM）上のデータにアクセスします。特権パスを介したアクセスでは、FPolicyサーバにファイルシステム全体が公開されます。サーバは、データ ファイルにアクセスして情報を収集したり、ファイルのスキャン、ファイルの読み取り、またはファイルへの書き込みを行ったりできます。

外部FPolicyサーバが特権データ チャネルを介してSVMのルートからファイルシステム全体にアクセスできるため、特権データ チャネル接続はセキュアである必要があります。



== FPolicy接続認証情報が特権データアクセスチャネルで使用される仕組み

FPolicyサーバは、FPolicy設定で保存されている特定のWindowsユーザ クレデンシャルを使用して、クラスタ ノードへの特権データ アクセス接続を確立します。特権データ アクセス チャネル接続の確立用としてサポートされているプロトコルは、SMBだけです。

FPolicyサーバで特権データ アクセスが必要となる場合は、次の条件を満たす必要があります。

* クラスタでSMBライセンスが有効になっている。
* FPolicy サーバーは、FPolicy 設定で設定された資格情報に基づいて実行する必要があります。


データ チャネル接続を確立するとき、FPolicyでは、指定されたWindowsユーザ名のクレデンシャルが使用されます。データ アクセスは、管理共有ONTAP_ADMIN$を介して確立されます。



== 権限付きデータ アクセスのためのスーパー ユーザ クレデンシャルの付与とは

ONTAPは、IPアドレスとFPolicyに設定されたユーザ クレデンシャルを組み合わせて、FPolicyサーバにスーパーユーザ クレデンシャルを付与します。

スーパーユーザのステータスは、FPolicyサーバがデータにアクセスする際に次の権限を付与します。

* 権限チェックの省略
+
ファイルやディレクトリに対するアクセスのチェックが省略されます。

* 特別なロック権限
+
ファイルにロックが設定されていても、読み取り、書き込み、変更が許可されます。FPolicyサーバがファイルに対してバイト範囲ロックを取得すると、そのファイルの既存のロックはその時点で解除されます。

* すべてのFPolicyチェックのバイパス
+
アクセス時にFPolicy通知が生成されません。





== FPolicyによるポリシー処理の管理方法

Storage Virtual Machine（SVM）には、優先度が異なる複数のFPolicyポリシーが割り当てられる場合があります。SVMで適切なFPolicy設定を作成するには、FPolicyがどのようにポリシー処理を管理するかを理解しておくことが重要です。

最初に各ファイル アクセス要求が評価され、このイベントを監視しているポリシーが特定されます。イベントが監視対象イベントの場合は、イベントに関する情報とともに関連するポリシーが評価を実施するFPolicyに渡されます。各ポリシーが割り当てられた優先度の順に評価されます。

ポリシーの設定時には、次の推奨事項を考慮してください。

* あるポリシーが常に他のポリシーより先に評価されるようにするには、そのポリシーの優先度を高く設定します。
* 監視対象イベントに対して要求されたファイル アクセス処理の成功が、別のポリシーで評価されるファイル要求の前提条件になっている場合は、最初のファイル処理の成功または失敗を制御するポリシーの優先度を高く設定します。
+
たとえば、あるポリシーがFPolicyのファイル アーカイブとリストアを管理し、2つ目のポリシーがオンライン ファイルへのファイル アクセス処理を管理する場合は、ファイル リストアを管理するポリシーの優先度を高く設定し、2つ目のポリシーが管理する処理が許可される前にファイルがリストアされるようにする必要があります。

* ファイル アクセス処理に適用される可能性があるすべてのポリシーを評価するには、同期ポリシーの優先度を低く設定します。


既存のポリシーの優先度を変更するには、ポリシーのシーケンス番号を変更します。ただし、新しい優先度に基づいてFPolicyでポリシーを評価するには、シーケンス番号を変更したポリシーを無効にしてから再度有効にする必要があります。
