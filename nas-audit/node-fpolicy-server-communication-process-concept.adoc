---
permalink: nas-audit/node-fpolicy-server-communication-process-concept.html 
sidebar: sidebar 
keywords: node-to-external, fpolicy, server communication process 
summary: FPolicyの設定を適切に計画するには、ノードと外部FPolicyサーバの間の通信プロセスについて理解しておく必要があります。 
---
= ノードと外部FPolicyサーバの間の通信プロセス
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
FPolicyの設定を適切に計画するには、ノードと外部FPolicyサーバの間の通信プロセスについて理解しておく必要があります。

Storage Virtual Machine（SVM）に属しているすべてのノードは、TCP/IPを使用して外部FPolicyサーバへの接続を開始します。FPolicyサーバへの接続のセットアップには、ノードのデータLIFを使用します。そのため、接続のセットアップは、ノードでSVMのデータLIFが稼働している場合にのみ実行できます。

ポリシーが有効になっている場合、各ノードの各FPolicyプロセスでは、FPolicyサーバとの接続の確立が試行されます。ポリシー設定で指定されたFPolicy外部エンジンのIPアドレスとポートが使用されます。

この接続により、SVMに属する各ノードからFPolicyサーバへのデータLIFを介した制御チャネルが確立されます。さらに、データLIFのアドレスが同じノードでIPv4とIPv6の両方で設定されている場合、FPolicyはIPv4とIPv6の両方の接続の確立を試みます。したがって、SVMが複数のノードに展開されている場合、またはIPv4アドレスとIPv6アドレスの両方が設定されている場合は、SVMでFPolicyポリシーを有効にしたあとに、クラスタからの複数の制御チャネルのセットアップ要求に対応する必要があります。

たとえば、クラスタに3つのノード（ノード1、ノード2、およびノード3）があり、SVMのデータLIFがノード2とノード3だけで設定されている場合、データボリュームの配置に関係なく、制御チャネルはノード2とノード3からのみ開始されます。ノード2にSVMに属するデータLIFが2つ（LIF1とLIF2）あり、最初にLIF1から接続を行うとします。FPolicyは、LIF1で障害が発生した場合、LIF2からの制御チャネルの確立を試みます。

image:what-node-to-fpolicy-server-communication-process-is.png["ノードからFpolocyサービスへの通信プロセス"]



== LIFの移行時またはフェイルオーバー時のFPolicyによる外部通信の管理方法

データLIFは、同じノードのデータポート、またはリモートノードのデータポートに移行できます。

データLIFがフェイルオーバーまたは移行されると、FPolicyサーバへの新しい制御チャネル接続が確立されます。その後、FPolicyはSMBクライアントおよびNFSクライアントのタイムアウトした要求を再試行でき、新しい通知が外部FPolicyサーバに送信されます。ノードは、SMBおよびNFSの元のタイムアウトした要求に対するFPolicyサーバの応答を拒否します。



== ノードのフェイルオーバー時のFPolicyによる外部通信の管理方法

FPolicy通信に使用されるデータポートをホストするクラスタノードで障害が発生すると、ONTAPはFPolicyサーバとノードの間の接続を切断します。

クラスタフェイルオーバーがFPolicyサーバに及ぼす影響は、FPolicy通信に使用されるデータポートを別のアクティブノードに移行するようにフェイルオーバーポリシーを設定することで軽減できます。移行が完了すると、新しいデータポートを使用して新しい接続が確立されます。

データポートを移行するようにフェイルオーバーポリシーが設定されていない場合、FPolicyサーバは障害が発生したノードが稼働するまで待機する必要があります。ノードが稼働すると、そのノードから新しいSession IDを使用して新しい接続が開始されます。

[NOTE]
====
FPolicyサーバは、切断された接続をキープアライブプロトコルメッセージで検出します。Session IDをパージするタイムアウトは、FPolicyの設定時に決定されます。デフォルトのキープアライブタイムアウトは2分です。

====