---
permalink: nas-audit/node-fpolicy-server-communication-process-concept.html 
sidebar: sidebar 
keywords: node-to-external, fpolicy, server communication process 
summary: FPolicy の設定を適切に計画するには、ノードと外部 FPolicy サーバの間の通信プロセスについて理解しておく必要があります。 
---
= ノードと外部 FPolicy サーバの間の通信プロセス
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
FPolicy の設定を適切に計画するには、ノードと外部 FPolicy サーバの間の通信プロセスについて理解しておく必要があります。

Storage Virtual Machine （ SVM ）に属しているすべてのノードは、 TCP/IP を使用して外部 FPolicy サーバへの接続を開始します。FPolicy サーバへの接続のセットアップには、ノードのデータ LIF を使用します。そのため、接続のセットアップは、ノードで SVM のデータ LIF が稼働している場合しか実行できません。

ポリシーが有効になっている場合は、各ノードのそれぞれの FPolicy プロセスで、 FPolicy サーバとの接続の確立が試行されます。ポリシー設定で指定された FPolicy 外部エンジンの IP アドレスとポートが使用されます。

この接続により、 SVM に属する各ノードから FPolicy サーバへのデータ LIF を介した制御チャネルが確立されます。また、データ LIF のアドレスとして同じノードで IPv4 と IPv6 の両方が設定されている場合、 FPolicy は IPv4 と IPv6 の両方の接続の確立を試みます。そのため、 SVM が複数のノードに展開されている場合、または IPv4 と IPv6 の両方のアドレスが設定されている場合は、 SVM で FPolicy ポリシーを有効にしたあとに、クラスタからの複数の制御チャネルのセットアップ要求に対応する必要があります。

たとえば、クラスタのノードが 3 つ（ノード 1 、ノード 2 、ノード 3 ）ある場合に、 SVM のデータ LIF がノード 2 とノード 3 にのみ分散されていると、データボリュームの分散に関係なく、制御チャネルはノード 2 とノード 3 からのみ開始されます。ノード 2 には LIF1 と LIF2 の 2 つのデータ LIF があり、これらは SVM に属しており、初期接続は LIF1 からであるとします。FPolicy は、 LIF1 で障害が発生した場合に LIF2 からの制御チャネルの確立を試みます。

image::../media/what-node-to-fpolicy-server-communication-process-is.png[ノードからFpolocyサービスへの通信プロセス]



== LIF の移行またはフェイルオーバー時における FPolicy による外部通信の管理方法

データ LIF は、同じノードのデータポート、またはリモートノードのデータポートに移行できます。

データ LIF がフェイルオーバーまたは移行されると、 FPolicy サーバへの新しい制御チャネル接続が確立されます。その後、 FPolicy は SMB クライアントおよび NFS クライアントのタイムアウトした要求を再試行でき、新しい通知が外部 FPolicy サーバに送信されます。ノードは、 SMB と NFS の元のタイムアウトした要求に対する FPolicy サーバの応答を拒否します。



== ノードのフェイルオーバー時における FPolicy による外部通信の管理方法

FPolicy 通信に使用されるデータポートをホストするクラスタノードに障害が発生した場合は、 ONTAP サーバとノードの間の接続が切断されます。

クラスタフェイルオーバーがFPolicyサーバに及ぼす影響は、FPolicy通信に使用されるデータポートを別のアクティブノードに移行するようにフェイルオーバーポリシーを設定することで軽減できます。移行が完了すると、新しいデータポートを使用して新しい接続が確立されます。

データポートを移行するようにフェイルオーバーポリシーが設定されていない場合、FPolicyサーバは障害が発生したノードが稼働するまで待機する必要があります。ノードが稼働したら、新しいセッション ID を使用してそのノードから新しい接続が開始されます。

[NOTE]
====
FPolicy サーバでは、切断された接続を検出するためにキープアライブプロトコルメッセージが使用されます。セッション ID をパージするためのタイムアウトは、 FPolicy の設定時に決定します。デフォルトのキープアライブタイムアウトは 2 分です。

====