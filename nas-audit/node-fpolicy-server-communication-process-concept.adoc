---
permalink: nas-audit/node-fpolicy-server-communication-process-concept.html 
sidebar: sidebar 
keywords: node-to-external, fpolicy, server communication process 
summary: FPolicy設定を適切に計画するには、ノードと外部FPolicyサーバの間の通信プロセスについて理解しておく必要があります。 
---
= ノードと外部のONTAP FPolicyサーバ間の通信プロセス
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
FPolicy設定を適切に計画するには、ノードと外部FPolicyサーバの間の通信プロセスについて理解しておく必要があります。

Storage Virtual Machine（SVM）に属しているすべてのノードは、TCP/IPを使用して外部FPolicyサーバへの接続を開始します。FPolicyサーバへの接続のセットアップには、ノードのデータLIFを使用します。そのため、接続のセットアップは、ノードでSVMのデータLIFが稼働している場合しか実行できません。

ポリシーが有効になっている場合は、各ノードのそれぞれのFPolicyプロセスで、FPolicyサーバとの接続の確立が試行されます。これには、ポリシーの設定で指定されたFPolicy外部エンジンのIPアドレスとポートが使用されます。

この接続により、SVMに属する各ノードからFPolicyサーバへのデータLIFを介した制御チャネルが確立されます。さらに、データLIFのアドレスとして同じノードでIPv4とIPv6の両方が設定されている場合、FPolicyはIPv4とIPv6の両方の接続の確立を試みます。そのため、SVMが複数のノードに展開されている場合、またはIPv4とIPv6の両方のアドレスが設定されている場合は、SVMでFPolicyポリシーを有効にしたあとに、クラスタからの複数の制御チャネルのセットアップ要求に対応する必要があります。

たとえば、クラスタに3つのノード（ノード1、ノード2、およびノード3）があり、SVMのデータLIFがノード2とノード3だけで設定されている場合、データ ボリュームの配置に関係なく、制御チャネルはノード2とノード3からのみ開始されます。ノード2にSVMに属するデータLIFが2つ（LIF1とLIF2）あり、最初にLIF1から接続を行うとします。FPolicyは、LIF1で障害が発生した場合にLIF2からの制御チャネルの確立を試みます。

image:what-node-to-fpolicy-server-communication-process-is.png["ノードからFpolicyサービスへの通信プロセス"]



== LIFの移行またはフェイルオーバー時におけるFPolicyによる外部通信の管理方法

データLIFは、同じノードのデータ ポート、またはリモート ノードのデータ ポートに移行できます。

データLIFがフェイルオーバーまたは移行されるときは、FPolicyサーバへの新しい制御チャネル接続が確立されます。その後、FPolicyはSMBクライアントおよびNFSクライアントのタイムアウトした要求を再試行でき、新しい通知が外部FPolicyサーバに送信されます。ノードは、SMBとNFSの元のタイムアウトした要求に対するFPolicyサーバの応答を拒否します。



== ノードのフェイルオーバー時におけるFPolicyによる外部通信の管理方法

FPolicy通信に使用されるデータ ポートをホストするクラスタ ノードに障害が発生した場合は、FPolicyサーバとノードの間の接続が切断されます。

クラスタ フェイルオーバーがFPolicyサーバに与える影響は、FPolicy通信に使用されるデータ ポートを別のアクティブ ノードに移行するようにフェイルオーバーポリシーを設定することで軽減できます。移行が完了したら、新しいデータ ポートを使用して新しい接続が確立されます。

データ ポートを移行するようにフェイルオーバーポリシーが設定されていない場合、FPolicyサーバは障害が発生したノードが稼働するまで待機する必要があります。ノードが稼働したら、新しいセッションIDを使用してそのノードから新しい接続が開始されます。

[NOTE]
====
FPolicyサーバでは、切断された接続を検出するためにキープアライブ プロトコル メッセージが使用されます。セッションIDをパージするためのタイムアウトは、FPolicy設定時に決定します。デフォルトのキープアライブのタイムアウトは2分です。

====