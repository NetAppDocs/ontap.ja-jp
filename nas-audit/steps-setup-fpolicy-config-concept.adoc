---
permalink: nas-audit/steps-setup-fpolicy-config-concept.html 
sidebar: sidebar 
keywords: steps, setting, fpolicy configuration 
summary: FPolicy がファイル アクセスを監視する前に、FPolicy サービスが必要な SVM で FPolicy 設定を作成し、有効にする必要があります。 
---
= ONTAP FPolicy設定をセットアップする
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
FPolicyでファイル アクセスを監視するには、FPolicyの設定を作成し、FPolicyサービスが必要なStorage Virtual Machine（SVM）で有効にする必要があります。

以下に、SVMでFPolicy設定をセットアップして有効にする手順を示します。

. FPolicy外部エンジンを作成します。
+
FPolicy外部エンジンは、特定のFPolicy設定に関連付けられている外部FPolicyサーバ（FPolicyサーバ）を識別します。内部の「`native`」FPolicyエンジンを使用してネイティブファイルブロッキング設定を作成する場合は、FPolicy外部エンジンを作成する必要はありません。

+
ONTAP 9.15.1以降では、 `protobuf`エンジン形式を使用できます。 `protobuf`に設定すると、通知メッセージはGoogle Protobufを使用してバイナリ形式でエンコードされます。エンジン形式を `protobuf`に設定する前に、FPolicyサーバが `protobuf`デシリアライゼーションもサポートしていることを確認してください。詳細については、link:plan-fpolicy-external-engine-config-concept.html["FPolicy外部エンジンの設定の計画"]を参照してください。

. FPolicyイベントを作成します。
+
FPolicyイベントでは、FPolicyポリシーで監視する対象を定義します。監視対象のプロトコルとファイル処理を指定し、一連のフィルタを含めることができます。それらのフィルタを使用して、監視対象イベントの中から、FPolicy外部エンジンで通知を送信する必要があるイベントだけを抽出できます。また、イベントでは、ポリシーでボリューム操作を監視するかどうかも指定します。

. FPolicyの永続的ストアを作成します（オプション）。
+
ONTAP 9.14.1以降、FPolicyではlink:persistent-stores.html["永続ストア"]を設定して、SVM内の非同期の非必須ポリシーのファイルアクセスイベントをキャプチャできます。同期（必須または非必須）および非同期の必須設定はサポートされていません。

+
永続的ストアは、クライアントI/O処理をFPolicy通知処理から分離して、クライアントのレイテンシを低減するのに役立ちます。

+
ONTAP 9.15.1 以降、FPolicy 永続ストアの設定が簡素化されました。 `persistent-store-create`コマンドは、SVM のボリューム作成を自動化し、永続ストア用のボリュームを設定します。

. FPolicyポリシーを作成します。
+
FPolicyポリシーは、監視対象のイベントセットと、監視対象イベントのうち、どのイベントについて通知を指定されたFPolicyサーバー（FPolicyサーバーが設定されていない場合はネイティブエンジン）に送信するかを適切なスコープに関連付ける役割を担います。また、このポリシーは、FPolicyサーバーが通知を受信するデータへの特権アクセスを許可するかどうかも定義します。FPolicyサーバーは、データにアクセスする必要がある場合、特権アクセスを必要とします。特権アクセスが必要となる一般的なユースケースとしては、ファイルブロッキング、クォータ管理、階層型ストレージ管理などが挙げられます。このポリシーでは、このポリシーの設定でFPolicyサーバーを使用するか、内部の「ネイティブ」FPolicyサーバーを使用するかを指定します。

+
スクリーニングを必須にするかどうかはポリシーで指定します。スクリーニングを必須にすると、すべてのFPolicyサーバが停止した場合や定義された時間内にFPolicyサーバからの応答を得られない場合に、ファイル アクセスが拒否されます。

+
ポリシーはSVM単位で適用されます。1つのポリシーを複数のSVMに適用することはできません。ただし、ある特定のSVMに複数のFPolicyポリシーを含めることは可能で、範囲、イベント、外部サーバの設定を同じ組み合わせにすることも、それぞれで異なる組み合わせにすることもできます。

. ポリシーの範囲を設定します。
+
FPolicyスコープでは、ボリューム、共有、またはエクスポート ポリシーについて、ポリシーで監視するものと除外するものを指定します。また、ファイル拡張子についても、FPolicyの監視対象に含めるものと除外するものを指定します。

+
[NOTE]
====
除外リストの方が対象リストよりも優先されます。

====
. FPolicyポリシーを有効にします。
+
ポリシーを有効にすると、制御チャネルおよび特権データ チャネル（オプション）の接続が確立されます。SVMが属するノードのFPolicyプロセスで、ファイルおよびフォルダに対するアクセスの監視が開始され、設定された条件に当てはまるイベントが見つかると、FPolicyサーバ（FPolicyサーバが設定されていない場合は標準のエンジン）に通知が送信されます。



[NOTE]
====
ポリシーでネイティブ ファイル ブロッキングを使用する場合は、外部エンジンは設定されず、関連付けられることもありません。

====