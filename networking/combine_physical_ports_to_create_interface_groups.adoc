---
sidebar: sidebar 
permalink: networking/combine_physical_ports_to_create_interface_groups.html 
keywords: combine, ports, ifgrp, interface, group, create, creating, add, adding, types, single-mode, single, mode, static, dynamic, multimode, best, practice, port-based, port, based, load, balance, balancing, ip, address, mac, sequential, remove, removing, delete, deleting, combine physical ports to create interface groups, interface group types, characteristics of single-mode interface groups, characteristics of static multimode interface groups, dynamic multimode interface group, load balancing in multimode interface groups, port-based load balancing, ip address and mac address load balancing, sequential load balancing, create an interface group, add a port to an interface group, remove a port from an interface group, delete an interface group 
summary: 2つ以上の物理ポートを1つの論理ポートに結合してインターフェイス グループを作成します 
---
= 物理ポートを組み合わせてONTAPインターフェースグループを作成する
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
インターフェイス グループ（別名リンク アグリゲーション グループ[LAG]）は、同じノード上の2つ以上の物理ポートを1つの論理ポートに組み合わせて作成します。論理ポートを使用すると、耐障害性と可用性が向上し、負荷も共有できます。



== インターフェイス グループの種類

ストレージ システムでは、シングルモード、スタティック マルチモード、およびダイナミック マルチモードという3種類のインターフェイス グループがサポートされています。各インターフェイス グループは、フォールト トレランスのレベルが異なります。マルチモード インターフェイス グループは、ネットワーク トラフィックのロード バランシング方法を提供します。



=== シングルモード インターフェイス グループの特性

シングルモード インターフェイス グループでは、インターフェイス グループの1つのインターフェイスだけがアクティブになります。他のインターフェイスはスタンバイで、アクティブなインターフェイスに障害が発生した場合に動作を引き継ぎます。

シングルモード インターフェイス グループの特性は、次のとおりです。

* フェイルオーバーでは、クラスタがアクティブ リンクを監視して、フェイルオーバーを制御します。クラスタがアクティブ リンクを監視するので、スイッチを設定する必要はありません。
* シングルモード インターフェイス グループには、複数のスタンバイ インターフェイスを設定できます。
* シングルモード インターフェイス グループが複数のスイッチをカバーする場合は、スイッチどうしをInter-Switch Link（ISL;スイッチ間リンク）で接続する必要があります。
* シングルモード インターフェイス グループでは、スイッチ ポートが同じブロードキャスト ドメインに属している必要があります。
* ポートが同じブロードキャスト ドメイン内にあるかどうかを確認するために、リンク監視用ARPパケット（送信元アドレスは0.0.0.0）がポートを介して送信されます。


次の図はシングルモード インターフェイス グループの例です。この例では、e0aとe1aがa0aというシングルモード インターフェイス グループを構成しています。アクティブ インターフェイスのe0aに障害が発生すると、スタンバイ インターフェイスのe1aが処理を引き継ぎ、スイッチとの接続を維持します。

image:ontap_nm_image6.png["シングルモード インターフェイス グループ"]


NOTE: シングルモード機能を実現するためには、フェイルオーバー グループを使用するアプローチが推奨されます。フェイルオーバー グループを使用すると、2番目のポートを引き続き他のLIFに使用でき、未使用のままにする必要がありません。またフェイルオーバー グループは、複数のポートにまたがることも、複数のノードのポートにまたがることも可能です。



=== スタティック マルチモード インターフェイス グループの特性

ONTAPに実装されているスタティック マルチモード インターフェイス グループは、IEEE 802.3ad（static）に準拠しています。スタティック マルチモード インターフェイス グループでは、アグリゲーションはサポートするがアグリゲーション設定のための制御パケット交換は行わないスイッチを使用できます。

スタティック マルチモード インターフェイス グループは、Link Aggregation Control Protocol（LACP）とも呼ばれるIEEE 802.3ad（dynamic）に準拠していません。LACPはポート アグリゲーション プロトコル（PAgP）と同等な、Cisco独自のリンク ポート アグリゲーション プロトコルです。

スタティック マルチモード インターフェイス グループの特性は、次のとおりです。

* インターフェイス グループ内のすべてのインターフェイスがアクティブで、単一のMACアドレスを共有します。
+
** 複数の接続が、インターフェイス グループ内のインターフェイスに分散されます。
** 各接続またはセッションが、インターフェイス グループ内の1つのインターフェイスを使用します。シーケンシャル ロード バランシング方式を使用する場合、すべてのセッションはパケット ベースで使用可能なリンク全体で分散され、インターフェイス グループの特定のインターフェイスにバインドされません。


* スタティック マルチモード インターフェイス グループは、最大「n-1」個のインターフェイスの障害から回復することができます。この「n」は、インターフェイス グループを構成しているインターフェイスの合計数です。
* あるポートで障害が発生した場合や切断された場合は、そのリンクを経由していたトラフィックが残りのインターフェイスの1つに自動的に再分散されます。
* スタティック マルチモード インターフェイス グループではリンクの喪失は検出できますが、クライアントへの接続の切断や、接続性とパフォーマンスに影響を及ぼす可能性があるスイッチの設定ミスは検出できません。
* スタティック マルチモード インターフェイス グループには、複数のスイッチ ポートでのリンク アグリゲーションをサポートするスイッチが必要です。インターフェイス グループの各リンクの接続先ポートがすべて1つの論理ポートを構成するよう、そのスイッチを設定します。一部のスイッチは、ジャンボ フレーム用に構成されたポートのリンク アグリゲーションをサポートしていない場合があります。詳細については、スイッチ ベンダーのマニュアルを参照してください。
* スタティック マルチモード インターフェイス グループのインターフェイス間でのトラフィック分散には、いくつかのロード バランシング オプションを使用できます。


次の図はスタティック マルチモード インターフェイス グループの例を示したものです。インターフェイスe0a、e1a、e2a、およびe3aは、a1aというマルチモード インターフェイス グループの一部です。このa1aマルチモード インターフェイス グループの4つのインターフェイスはすべてアクティブです。

image:ontap_nm_image7.png["動的マルチモード インターフェイス グループ"]

1つの集約リンク内のトラフィックを複数の物理スイッチに分散するテクノロジがいくつか存在します。この機能を有効にするテクノロジは、ネットワーキング製品によって異なります。ONTAPのスタティック マルチモード インターフェイス グループは、IEEE 802.3規格に準拠しています。IEEE 802.3規格に対応または準拠すると言われている複数スイッチ リンク アグリゲーション テクノロジであれば、ONTAPと一緒に使用できます。

IEEE 802.3規格には、集約リンク内の送信デバイスが、送信用の物理インターフェイスを決定することが規定されています。そのため、ONTAPが受け持つのは発信トラフィックの分散だけで、着信フレームの受信方法を制御することはできません。集約リンクでの着信トラフィックの転送を管理または制御するためには、直接接続されたネットワーク デバイス上でその転送を変更する必要があります。



=== ダイナミック マルチモード インターフェイス グループ

ダイナミック マルチモード インターフェイス グループは、Link Aggregation Control Protocol（LACP）を実装して、直接接続されたスイッチへのグループ メンバーシップの通信を行います。LACPを使用すると、リンク ステータスの喪失および直接接続されたスイッチ ポートと通信できないノードを検出できます。

ONTAPに実装されているダイナミック マルチモード インターフェイス グループは、IEEE 802.3 AD（802.1AX）に準拠しています。ONTAPは、Cisco独自のリンク アグリゲーション プロトコルであるPort Aggregation Protocol（PAgP）をサポートしていません。

ダイナミック マルチモード インターフェイス グループには、LACPをサポートするスイッチが必要です。

ONTAPは、アクティブまたはパッシブ モードに設定されているスイッチとの相性がよい、設定不可のアクティブ モードでLACPを実装します。ONTAPは、IEEE 802.3 AD（802.1AX）の規定に従い、longおよびshortのLACPタイマーを実装し、設定不可の値（3秒と90秒）で使用します。

ONTAPのロード バランシング アルゴリズムは、発信トラフィックの転送に使用されるメンバー ポートを決定しますが、着信フレームの受信方法は制御しません。スイッチは、そのポート チャネル グループに設定されたロード バランシング アルゴリズムに基づいて、転送に使用されるポート チャネル グループのメンバー（個々の物理ポート）を決定します。したがって、スイッチの設定により、トラフィックを受信するストレージ システムのメンバー ポート（個々の物理ポート）が決まります。スイッチ設定の詳細については、スイッチ ベンダーのマニュアルを参照してください。

あるインターフェイスが、連続したLACPプロトコル パケットの受信に失敗すると、そのインターフェイスに対しては「ifgrp status」コマンドで「lag_inactive」と出力されます。既存のトラフィックは、他のアクティブなインターフェイスに自動的に再ルーティングされます。

ダイナミック マルチモード インターフェイス グループを使用する場合、以下のルールが適用されます。

* ダイナミック マルチモード インターフェイス グループは、ポートベース、IPベース、MACベース、またはラウンドロビンによるロード バランシング方式を使用するように設定する必要があります。
* ダイナミック マルチモード インターフェイス グループでは、すべてのインターフェイスをアクティブにして、1つのMACアドレスを共有する必要があります。


次の図は、ダイナミック マルチモード インターフェイス グループの例です。インターフェイスe0a、e1a、e2a、およびe3aは、a1aというマルチモード インターフェイス グループの一部です。a1aダイナミック マルチモード インターフェイス グループの4つのインターフェイスはすべてアクティブです。

image:ontap_nm_image7.png["動的マルチモード インターフェイス グループ"]



=== マルチモード インターフェイス グループでのロード バランシング

IP アドレス、MAC アドレス、シーケンシャル、またはポートベース ロード バランシング方式を使用して、マルチモード インターフェイス グループのネットワーク ポートにネットワーク トラフィックを均等に分散することにより、マルチモード インターフェイス グループのすべてのインターフェイスが送信トラフィックに均等に使用されるようにすることができます。

マルチモード インターフェイス グループのロード バランシング方式を指定できるのは、インターフェイス グループの作成時だけです。

*ベスト プラクティス*：可能な限り、ポートベース ロード バランシングを推奨します。ネットワークに特別な理由や制限がない限り、ポートベース ロード バランシングを使用してください。



==== ポートベースのロード バランシング

ポートベースのロード バランシングは推奨される方式です。

ポートベースのロード バランシング方式を使用して、マルチモード インターフェイス グループのトラフィックをトランスポート レイヤ（TCPまたはUDP）ポートに基づいて均等に分散させることができます。

ポートベースのロード バランシング方式では、トランスポート レイヤのポート番号に加えて、送信元と受信側のIPアドレスに対して高速ハッシュ アルゴリズムを使用します。



==== IPアドレスおよびMACアドレスによるロード バランシング

IPアドレスおよびMACアドレスによるロード バランシングは、マルチモード インターフェイス グループのトラフィックを均等にする方式です。

これらのロード バランシング方式では、送信元アドレスと受信側アドレス（IPアドレスおよびMACアドレス）に対して高速ハッシュ アルゴリズムを使用します。ハッシュ アルゴリズムの結果が、リンク状態がUPでないインターフェイスに一致した場合は、次のアクティブなインターフェイスが使用されます。


NOTE: ルーターに直接接続しているシステムでインターフェイス グループを作成する場合は、MACアドレスによるロード バランシング方式を選択しないでください。このような構成では、すべての発信IPフレームの宛先MACアドレスはルーターのMACアドレスになります。そのため、使用されるインターフェイス グループのインターフェイスは1つだけになります。

IPアドレスによるロード バランシングは、IPv4アドレスとIPv6アドレスの両方で同様に機能します。



==== シーケンシャル ロード バランシング

シーケンシャル ロード バランシングでは、ラウンドロビン アルゴリズムを使用して複数のリンク間でパケットを均等に分散できます。単一の接続のトラフィックのロード バランシングによって負荷を複数のリンクに分散させて、単一の接続のスループットを向上させるには、シーケンシャル オプションを使用します。

ただし、シーケンシャル ロード バランシングでは、パケット配信の順序が乱れてパフォーマンスが大幅に低下する可能性があります。このため、一般にシーケンシャル ロード バランシングは推奨されません。



== インターフェイス グループ（別名LAG）の作成

インターフェイス グループ（別名LAG）をシングルモード、スタティック マルチモード、またはダイナミック マルチモード（LACP）で作成すると、グループ内のネットワーク ポートの機能を組み合わせて1つのインターフェイスとしてクライアントに提供できます。

実行する手順は、System ManagerとCLIのどちらのインターフェイスを使用するかによって異なります。

[role="tabbed-block"]
====
.System Manager
--
*System Manager を使用して LAG を作成します*

.手順
. LAG を作成するには、*ネットワーク > Ethernet ポート > + Link Aggregation Group* を選択します。
. ドロップダウン リストからノードを選択します。
. 次のいずれかを選択します。
+
.. ONTAPで *ブロードキャスト ドメインを自動的に選択（推奨）* します。
.. ブロードキャスト ドメインを手動で選択する。


. LAGを構成するポートを選択します。
. モードを選択します。
+
.. シングル：一度に 1 つのポートのみが使用されます。
.. 複数：すべてのポートを同時に使用できます。
.. LACP：LACP プロトコルは使用できるポートを決定します。


. 負荷分散を選択します。
+
.. IP based
.. MAC based
.. ポート
.. シーケンシャル


. 変更を保存します。


image:AddLag01.png["ラグ グラフィックを追加"]

--
.CLI
--
*CLI を使用してインターフェース グループを作成する*

マルチモード インターフェイス グループを作成するときは、次のいずれかのロード バランシング方式を指定できます。

* `port`：ネットワーク トラフィックはトランスポート層（TCP/UDP）ポートに基づいて分散されます。これは推奨されるロード バランシング方法です。
* `mac`：ネットワーク トラフィックは MAC アドレスに基づいて分散されます。
* `ip`：ネットワーク トラフィックは IP アドレスに基づいて分散されます。
* `sequential`：ネットワーク トラフィックは受信されるとすぐに分散されます。



NOTE: インターフェイス グループのMACアドレスは、基盤のポートの順序およびそれらのポートがブートアップ時にどのように初期化されるかによって決まります。そのため、ifgrpのMACアドレスがリブート後やONTAPのアップグレード後に変わる可能性があることを想定しておいてください。

.手順
 `network port ifgrp create`コマンドを使用してインターフェース グループを作成します。

インターフェース グループには、 `a<number><letter>`という構文を使用して名前を付ける必要があります。たとえば、a0a、a0b、a1c、a2aは有効なインターフェース グループ名です。

 `network port ifgrp create`の詳細については、link:https://docs.netapp.com/us-en/ontap-cli/network-port-ifgrp-create.html["ONTAPコマンド リファレンス"^]をご覧ください。

次の例は、分散機能をportに、モードをmultimodeに設定して、a0aという名前のインターフェイス グループを作成する方法を示しています。

`network port ifgrp create -node _cluster-1-01_ -ifgrp _a0a_ -distr-func _port_ -mode _multimode_`

--
====


== インターフェイス グループ（別名LAG）へのポートの追加

すべてのポート速度のインターフェイス グループ（別名LAG）に、最大16個の物理ポートを追加できます。

実行する手順は、System ManagerとCLIのどちらのインターフェイスを使用するかによって異なります。

[role="tabbed-block"]
====
.System Manager
--
*System Managerを使用してポートをLAGに追加します*

.手順
. LAG を編集するには、*ネットワーク > イーサネット ポート > LAG* を選択します。
. 同じノードからLAGに追加するポートを選択します。
. 変更を保存します。


--
.CLI
--
*CLI を使用してインターフェイス グループにポートを追加する*

.手順
インターフェイス グループにネットワーク ポートを追加します。

`network port ifgrp add-port`

次の例は、a0aというインターフェイス グループにポートe0cを追加する方法を示しています。

`network port ifgrp add-port -node _cluster-1-01_ -ifgrp _a0a_ -port _e0c_`

ONTAP 9.8以降では、最初の物理ポートがインターフェース グループに追加されてから約1分後に、インターフェース グループは適切なブロードキャスト ドメインに自動的に配置されます。ONTAPによるこの処理を希望せず、ifgrpを手動でブロードキャスト ドメインに配置する場合は、 `ifgrp add-port`コマンドの一部として `-skip-broadcast-domain-placement`パラメータを指定します。

link:https://docs.netapp.com/us-en/ontap-cli/network-port-ifgrp-add-port.html["ONTAPコマンド リファレンス"^]のポート インターフェイス グループに適用される `network port ifgrp add-port`と設定制限の詳細については、こちらを参照してください。

--
====


== インターフェイス グループ（別名LAG）からのポートの削除

LIFをホストするインターフェイス グループからポートを削除できます。ただし、削除するポートがインターフェイス グループ内の最後のポートでない場合に限ります。最後のポートをインターフェイス グループから削除しないという前提により、インターフェイス グループがLIFをホストできない、またはインターフェイス グループをLIFのホーム ポートに指定できないという要件はありません。ただし、最後のポートを削除する場合は、先にインターフェイス グループからLIFを移行または移動しておく必要があります。

.タスク概要
インターフェイス グループ（別名LAG）からは最大16個のポート（物理インターフェイス）を削除できます。

実行する手順は、System ManagerとCLIのどちらのインターフェイスを使用するかによって異なります。

[role="tabbed-block"]
====
.System Manager
--
*System Managerを使用してLAGからポートを削除します*

.手順
. LAG を編集するには、*ネットワーク > イーサネット ポート > LAG* を選択します。
. LAGから削除するポートを選択します。
. 変更を保存します。


--
.CLI
--
*CLI を使用してインターフェイス グループからポートを削除する*

.手順
インターフェイス グループからネットワーク ポートを削除します。

`network port ifgrp remove-port`

 `network port ifgrp remove-port`の詳細については、link:https://docs.netapp.com/us-en/ontap-cli/network-port-ifgrp-remove-port.html["ONTAPコマンド リファレンス"^]をご覧ください。

次の例は、a0aというインターフェイス グループからポートe0cを削除する方法を示しています。

`network port ifgrp remove-port -node _cluster-1-01_ -ifgrp _a0a_ -port _e0c_`

--
====


== インターフェイス グループ（別名LAG）の削除

基盤となる物理ポートに直接LIFを設定する場合、またはインターフェイス グループ（別名LAG）のモードや分散機能を変更する場合は、インターフェイス グループ（別名LAG）を削除することができます。

.開始する前に
* LIFをホストしているインターフェイス グループ（別名LAG）は削除できません。
* LIFのホーム ポートまたはフェイルオーバー ターゲットであるインターフェイス グループ（別名LAG）は削除できません。


実行する手順は、System ManagerとCLIのどちらのインターフェイスを使用するかによって異なります。

[role="tabbed-block"]
====
.System Manager
--
*System Managerを使用してLAGを削除します*

.手順
. LAG を削除するには、*ネットワーク > イーサネット ポート > LAG* を選択します。
. 削除するLAGを選択します。
. LAGを削除します。


--
.CLI
--
*CLI を使用してインターフェース グループを削除する*

.手順
 `network port ifgrp delete`コマンドを使用してインターフェース グループを削除します。

 `network port ifgrp delete`の詳細については、link:https://docs.netapp.com/us-en/ontap-cli/network-port-ifgrp-delete.html["ONTAPコマンド リファレンス"^]をご覧ください。

次に、a0bという名前のインターフェイス グループを削除する例を示します。

`network port ifgrp delete -node _cluster-1-01_ -ifgrp _a0b_`

--
====