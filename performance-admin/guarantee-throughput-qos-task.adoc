---
permalink: performance-admin/guarantee-throughput-qos-task.html 
sidebar: sidebar 
keywords: throughput, qos, understand, ceilings, floors, shared, policy, adaptive, general, support, workloads, 
summary: ストレージのサービス品質（QoS）を使用することで、競合するワークロードによって重要なワークロードのパフォーマンスが低下しないようにすることができます。競合するワークロードにスループット上限を設定してシステムリソースへの影響を制限したり、重要なワークロードにスループット下限を設定して競合するワークロードの需要に関わらず、最小スループット目標を確実に達成できるようにしたりできます。同じワークロードに上限と下限の両方を設定することもできます。 
---
= ONTAPでのQoSによるスループット保証の概要
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
ストレージのサービス品質（QoS）を使用することで、競合するワークロードによって重要なワークロードのパフォーマンスが低下しないようにすることができます。競合するワークロードにスループットの_上限_を設定してシステムリソースへの影響を制限することも、重要なワークロードにスループットの_下限_を設定して競合するワークロードの需要に関わらず最小スループット目標を満たすようにすることもできます。同じワークロードに上限と下限の両方を設定することもできます。



== スループット上限（QoS Max）

スループットの上限は、ワークロードのスループットを最大IOPS、最大MBps、またはその両方に制限します。次の図では、ワークロード2がワークロード1および3の「Bully」とならないようにスループットの上限が設定されています。

_ポリシーグループ_は、1つ以上のワークロードのスループット上限を定義します。ワークロードは、_ストレージオブジェクト_（ボリューム、ファイル、qtree、LUN、またはSVM内のすべてのボリューム、ファイル、qtree、LUN）に対するI/O操作を表します。上限は、ポリシーグループの作成時に指定することも、ワークロードを監視してから指定することもできます。


NOTE: ワークロードのスループットは、特にスループットが急激に変化した場合、指定された上限を10%までは超過することができます。バースト時には、上限を50%まで超過することができます。バーストは、トークンが150%まで累積した場合に単一ノードで発生します。

image:qos-ceiling.gif["スループット上限適用前と適用後のQoSを比較したグラフ。"]



== スループットフロア（QoS Min）

スループットの下限は、ワークロードのスループットが最小IOPS、最小MBps、またはその両方を下回らないことを保証する設定です。次の図では、ワークロード1とワークロード3にスループットの下限が設定され、ワークロード2からの要求量に関係なく、最小スループットが確保されています。


TIP: これらの例からわかるように、スループットの上限はスループットを直接調整するのに対し、スループットの下限は下限が設定されたワークロードを優先することでスループットを間接的に調整します。

下限はポリシー グループの作成時に指定できるほか、ワークロードをしばらく監視したあとで指定することもできます。

ONTAP 9.13.1以降では、<<adaptive-qos-templates>>を使用してSVMスコープでスループットフロアを設定できます。ONTAP 9.13.1より前のリリースでは、スループットフロアを定義するポリシーグループをSVMに適用することはできません。

[NOTE]
====
ONTAP 9.7よりも前のリリースでは、十分なパフォーマンス容量がある場合にスループットの下限が保証されます。

ONTAP 9.7以降では、パフォーマンス容量が不足している場合でもスループットの下限が保証されます。この新しい下限機能は、下限v2と呼ばれます。下限v2では、この保証を満たすために、スループットの下限がないワークロードや下限の設定を超過する作業でレイテンシが高くなる可能性があります。下限v2は、一般のQoSとアダプティブQoSの両方に適用されます。

ONTAP 9.7P6以降では、Floor v2の新しい動作を有効/無効にするオプションが利用可能です。 `volume move trigger-cutover`のような重要な処理の実行中、ワークロードは指定されたフロアを下回る可能性があります。十分な容量があり、重要な処理が実行されていない場合でも、ワークロードへのスループットは指定されたフロアを最大5%下回ることがあります。フロアがオーバープロビジョニングされ、パフォーマンス容量が不足している場合、一部のワークロードは指定されたフロアを下回る可能性があります。

====
image:qos-floor.gif["フロアが適用される前と後の QoS スループットを比較した 2 つのグラフ。"]



== 共有および非共有QoSポリシーグループ

ONTAP 9.4以降では、_非共有_QoSポリシーグループを使用して、定義済みのスループット上限または下限を各メンバーワークロードに個別に適用するように指定できます。_共有_ポリシーグループの動作は、ポリシータイプによって異なります：

* スループットの上限については、共有ポリシー グループに割り当てられたワークロードの合計スループットが指定した上限以下でなければなりません。
* スループットの下限については、共有ポリシー グループを適用できるのは単一のワークロードのみです。




== アダプティブQoS

通常、ストレージ オブジェクトに割り当てたポリシー グループの値は固定値です。ストレージ オブジェクトのサイズが変わったときは、値を手動で変更する必要があります。たとえば、ボリュームの使用スペースが増えた場合、通常は指定されているスループットの上限も増やす必要があります。

_Adaptive QoS_ は、ワークロードのサイズに応じてポリシーグループの値を自動的に調整し、ワークロードのサイズが変化しても IOPS と TBs|GBs の比率を維持します。これは、大規模な導入環境で数百、数千のワークロードを管理する際に大きなメリットとなります。

アダプティブQoSは、主にスループットの上限の調整に使用しますが、下限の管理（ワークロード サイズが増えた場合）に使用することもできます。ワークロードのサイズは、ストレージ オブジェクトに割り当てられたスペースまたはストレージ オブジェクトで使用されているスペースのいずれかで表されます。


NOTE: ONTAP 9.5以降では、使用されているスペースをスループットの下限に使用できます。ONTAP 9.4以前では使用できません。

* _割り当て領域_ポリシーは、ストレージ オブジェクトの公称サイズに応じてIOPS/TB|GB比を維持します。比が100 IOPS/GBの場合、150GBのボリュームのスループット上限は、ボリュームがそのサイズを維持する限り15,000 IOPSになります。ボリュームのサイズが300GBに変更されると、アダプティブQoSによってスループット上限が30,000 IOPSに調整されます。
* _使用済みスペース_ ポリシー（デフォルト）は、ストレージ効率化前の実際のデータ保存量に応じてIOPS/TB|GB比率を維持します。比率が100 IOPS/GBの場合、150 GBのボリュームに100 GBのデータを保存した場合、スループット上限は10,000 IOPSになります。使用済みスペースの量が変化すると、アダプティブQoSは比率に応じてスループット上限を調整します。


ONTAP 9.5以降では、アプリケーションにI/Oブロック サイズを指定することで、スループット制限をIOPSとMBpsの両方で指定できます。MBpsの制限は、ブロック サイズにIOPS制限を掛けて計算されます。たとえば、32KのI/Oブロック サイズでIOPSの制限が6144IOPS/TBの場合、MBpsの制限は192MBpsになります。

以下は、スループットの上限と下限の両方に対して想定される動作です。

* アダプティブQoSポリシー グループにワークロードを割り当てると、上限または下限がただちに更新されます。
* アダプティブQoSポリシー グループに含まれるワークロードのサイズを変更すると、上限または下限が約5分で更新されます。


更新が実行されるためにはスループットが少なくとも10 IOPS増加する必要があります。

アダプティブQoSポリシー グループは常に非共有です。定義されているスループットの上限または下限は、各メンバー ワークロードに個別に適用されます。

ONTAP 9.6以降では、SSDを使用するONTAP Select Premiumでスループットの下限がサポートされます。



=== アダプティブ ポリシー グループ テンプレート

ONTAP 9.13.1以降では、SVMにアダプティブQoSテンプレートを設定できます。アダプティブポリシーグループテンプレートを使用すると、SVM内のすべてのボリュームのスループットの下限と上限を設定できます。

アダプティブポリシーグループテンプレートは、SVMの作成後にのみ設定できます。 `vserver modify`コマンドに `-qos-adaptive-policy-group-template`パラメータを指定して、ポリシーを設定します。

アダプティブ ポリシー グループ テンプレートを設定すると、ポリシーの設定後に作成または移行されたボリュームには、そのポリシーが自動的に適用されます。SVM上の既存のボリュームには適用されません。SVMでポリシーを無効にすると、無効後にSVMに移行または作成されたボリュームにはポリシーが適用されません。アダプティブ ポリシー グループ テンプレートを無効にしても、それまでにそのポリシーが適用されていたボリュームに変更はなく、引き続き同じポリシーが適用されます。

詳細については、xref:../performance-admin/adaptive-policy-template-task.html[アダプティブ ポリシー グループ テンプレートの設定]を参照してください。



== 全般的なサポート

次の表に、スループットの上限、スループットの下限、およびアダプティブQoSのサポート状況を示します。

|===
| リソースまたは機能 | スループットの上限 | スループットの下限 | スループットの下限v2 | アダプティブQoS 


 a| 
ONTAP 9バージョン
 a| 
All
 a| 
9.2以降
 a| 
9.7以降
 a| 
9.3 以降



 a| 
プラットフォーム
 a| 
All
 a| 
* AFF
* C190 ^1^
* ONTAP Select プレミアム（SSD）^1^

 a| 
* AFF
* C190
* SSDを使用するONTAP Select Premium

 a| 
All



 a| 
プロトコル
 a| 
All
 a| 
All
 a| 
All
 a| 
All



 a| 
FabricPool
 a| 
はい
 a| 
〇（階層化ポリシーが「none」に設定され、ブロックがクラウドにない場合）
 a| 
〇（階層化ポリシーが「none」に設定され、ブロックがクラウドにない場合）
 a| 
いいえ



 a| 
SnapMirror Synchronous
 a| 
はい
 a| 
いいえ
 a| 
いいえ
 a| 
はい

|===
^1^ C190およびONTAP SelectサポートはONTAP 9.6リリースから開始されました。



== スループットの上限がサポートされるワークロード

次の表に、スループットの上限がサポートされるワークロードをONTAP 9のバージョン別に示します。ルート ボリューム、負荷共有ミラー、およびデータ保護ミラーはサポートされません。

|===
| ワークロード | ONTAP 9.8以降 | ONTAP 9.7から9.4 | ONTAP 9.3以前 


 a| 
Volume
 a| 
はい
 a| 
はい
 a| 
はい



 a| 
ファイル
 a| 
はい
 a| 
はい
 a| 
はい



 a| 
LUN
 a| 
はい
 a| 
はい
 a| 
はい



 a| 
SVM
 a| 
はい
 a| 
はい
 a| 
はい



 a| 
FlexGroupボリューム
 a| 
はい
 a| 
はい
 a| 
はい（ONTAP 9.3のみ）



 a| 
qtree ^1^
 a| 
はい
 a| 
いいえ
 a| 
いいえ



 a| 
ポリシー グループへの複数のワークロードの割り当て
 a| 
はい
 a| 
はい
 a| 
はい



 a| 
非共有のポリシー グループ
 a| 
はい
 a| 
はい
 a| 
いいえ

|===
^1^ ONTAP 9.9.1以降、SMBが有効になっているFlexVolおよびFlexGroupボリュームのqtreeでSMBアクセスがサポートされます。ONTAP 9.8以降、NFSが有効になっているFlexVolおよびFlexGroupボリュームのqtreeでNFSアクセスがサポートされます。



== スループットの下限がサポートされるワークロード

次の表に、スループットの下限がサポートされるワークロードをONTAP 9のバージョン別に示します。ルート ボリューム、負荷共有ミラー、およびデータ保護ミラーはサポートされません。

|===
| ワークロード | ONTAP 9.13.1以降 | ONTAP 9.8から9.13.0 | ONTAP 9.4 から 9.7 | ONTAP 9.3 


| Volume | はい | はい | はい | はい 


| ファイル | はい | はい | はい | はい 


| LUN | はい | はい | はい | はい 


| SVM | はい | いいえ | いいえ | いいえ 


| FlexGroupボリューム | はい | はい | はい | いいえ 


| qtree ^1^ | はい | はい | いいえ | いいえ 


| ポリシー グループへの複数のワークロードの割り当て | はい | はい | はい | いいえ 


| 非共有のポリシー グループ | はい | はい | はい | いいえ 
|===
^1^ ONTAP 9.8以降、NFSが有効になっているFlexVolおよびFlexGroupボリュームのqtreeでNFSアクセスがサポートされます。ONTAP 9.9.1以降、SMBが有効になっているFlexVolおよびFlexGroupボリュームのqtreeでSMBアクセスもサポートされます。



== アダプティブQoSがサポートされるワークロード

次の表に、アダプティブQoSがサポートされるワークロードをONTAP 9のバージョン別に示します。ルート ボリューム、負荷共有ミラー、およびデータ保護ミラーはサポートされません。

|===
| ワークロード | ONTAP 9.13.1以降 | ONTAP 9.4から9.13.0 | ONTAP 9.3 


| Volume | はい | はい | はい 


| ファイル | はい | はい | いいえ 


| LUN | はい | はい | いいえ 


| SVM | はい | いいえ | いいえ 


| FlexGroupボリューム | はい | はい | いいえ 


| ポリシー グループへの複数のワークロードの割り当て | はい | はい | はい 


| 非共有のポリシー グループ | はい | はい | はい 
|===


== ワークロードとポリシー グループの最大数

次の表に、ワークロードとポリシー グループの最大数をONTAP 9のバージョン別に示します。

|===
| ワークロード | ONTAP 9.4以降 | ONTAP 9.3以前 


 a| 
クラスタあたりの最大ワークロード
 a| 
40,000
 a| 
12,000



 a| 
ノードあたりの最大ワークロード
 a| 
40,000
 a| 
12,000



 a| 
ポリシー グループの最大数
 a| 
12,000
 a| 
12,000

|===