---
permalink: revert/task_reverting_an_ontap_cluster.html 
sidebar: sidebar 
keywords: ontap, revert, reverting, reversion, cluster 
summary: クラスタをオフラインにして以前のONTAPリリースにリバートするには、ストレージ フェイルオーバーとデータLIFを無効にし、リバートの前提条件を満たしていることを確認してから、ノードのクラスタ設定とファイルシステム設定をリバートします。この処理をクラスタの他の各ノードに対して繰り返す必要があります。 
---
= ONTAPクラスタのリバート
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
ONTAPクラスタのリバートはシステム停止を伴います。リバート中はクラスタをオフラインにする必要があります。テクニカルサポートの支援なしに本番環境のクラスタをリバートしないでください。

新しいクラスタまたはテスト クラスタを元に戻すには、ストレージ フェイルオーバーとデータLIFを無効にし、リバートの前提条件に対処する必要があります。その後、クラスタ内の各ノードでクラスタとファイル システムの構成を元に戻す必要があります。

.開始する前に
* link:task_things_to_verify_before_revert.html["リバート前の検証"]を完了しているはずです。
* 必要なlink:concept_pre_revert_checks.html["特定の ONTAP バージョンの事前チェック"]を完了している必要があります。
* link:task_download_and_install_ontap_software_image.html["ターゲットのONTAPソフトウェアイメージをダウンロードしてインストールしました"]する必要があります。




== ステップ1：クラスタをリバージョンする準備

クラスタノードをリバートする前に、ターゲットの ONTAP イメージがインストールされていることを確認し、クラスタ内のすべてのデータ LIF を無効にする必要があります。

.手順
. 権限レベルをadvancedに設定します。
+
[source, cli]
----
set -privilege advanced
----
+
続行するように求められたら、*y* と入力します。

. ターゲットの ONTAP ソフトウェアがインストールされていることを確認します：
+
[source, cli]
----
system image show
----
+
次の例は、バージョン9.13.1が両方のノードに代替イメージとしてインストールされていることを示しています：

+
[listing]
----
cluster1::*> system image show
                 Is      Is                 Install
Node     Image   Default Current Version    Date
-------- ------- ------- ------- --------   -------------------
node0
         image1  true    true    9.14.1      MM/DD/YYYY TIME
         image2  false   false   9.13.1      MM/DD/YYYY TIME
node1
         image1  true    true    9.14.1      MM/DD/YYYY TIME
         image2  false   false   9.13.1      MM/DD/YYYY TIME
4 entries were displayed.
----
. クラスタ内のすべてのデータ LIF を無効にします：
+
[source, cli]
----
network interface modify {-role data} -status-admin down
----
. クラスタ間の FlexCache 関係があるかどうかを判断します：
+
[source, cli]
----
flexcache origin show-caches -relationship-type inter-cluster
----
. クラスタ間 FlexCache が存在する場合は、キャッシュクラスタ上のデータ LIF を無効にします：
+
[source, cli]
----
network interface modify -vserver <vserver_name> -lif <lif_name> -status-admin down
----




== ステップ2：クラスタノードを元に戻す

クラスタをリバートするには、HAペアの最初のノードをリバートしてから、パートナーノードをリバートする必要があります。次に、クラスタ内のすべてのノードがリバートされるまで、各HAペアに対してこのプロセスを繰り返します。MetroCluster構成がある場合は、構成内の両方のクラスタに対してこれらの手順を繰り返す必要があります。

[role="tabbed-block"]
====
.4つ以上のノード
--
.手順
. リバートするノードにログインします。
+
ノードをリバートするには、そのノードのノード管理LIFを通じてクラスタにログインする必要があります。

. HA ペアのノードのストレージフェイルオーバーを無効にします：
+
[source, cli]
----
storage failover modify -node <nodename> -enabled false
----
+
ストレージ フェイルオーバーを無効にするのは、HAペアに対して1度だけです。一方のノードでストレージ フェイルオーバーを無効にすると、そのノードのパートナーでもストレージ フェイルオーバーが無効になります。

. ノードのターゲット ONTAP ソフトウェア イメージをデフォルト イメージに設定します：
+
[source, cli]
----
system image modify -node <nodename> -image <target_image> -isdefault true
----
. ターゲットの ONTAP ソフトウェアイメージが、元に戻すノードのデフォルトイメージとして設定されていることを確認します：
+
[source, cli]
----
system image show
----
+
次の例は、バージョン 9.13.1 が node0 のデフォルト イメージとして設定されていることを示しています：

+
[listing]
----
cluster1::*> system image show
                 Is      Is                 Install
Node     Image   Default Current Version    Date
-------- ------- ------- ------- --------   -------------------
node0
         image1  false   true    9.14.1      MM/DD/YYYY TIME
         image2  true    false   9.13.1      MM/DD/YYYY TIME
node1
         image1  true    true    9.14.1      MM/DD/YYYY TIME
         image2  false   false   9.13.1      MM/DD/YYYY TIME
4 entries were displayed.
----
. ノードがリバートの準備ができていることを確認します：
+
[source, cli]
----
system node revert-to -node <nodename> -check-only true -version 9.x
----
+
 `check-only`パラメータは、スナップショットポリシーを無効にしたり、ONTAP の新しいバージョンにアップグレードした後に作成されたスナップショットを削除したりするなど、元に戻す前に対処する必要がある前提条件を識別します。

+
 `-version`オプションは、リバート先のONTAPリリースを指します。たとえば、9.14.1から9.13.1にリバートする場合、 `-version`オプションの正しい値は9.13.1です。

. ノードのクラスタ構成を元に戻します：
+
[source, cli]
----
system node revert-to -node <nodename> -version 9.x
----
+
クラスタ設定がリバートされ、クラスタシェルからログアウトされます。

. ログインプロンプトを待ち、システムシェルにログインするかどうかを尋ねられたら*No*と入力します。
+
ログインプロンプトが表示されるまで30分以上かかる場合があります。

. admin でクラスターシェルにログインします。
. ノードシェルに切り替えます：
+
[source, cli]
----
run -node <nodename>
----
+
クラスタシェルに再ログインしてからノードシェル コマンドを使用できるようになるまでに、数分かかることがあります。コマンドが失敗した場合は、数分待ってからもう一度試してください。

. ノードのファイルシステム構成を元に戻します：
+
[source, cli]
----
revert_to 9.x
----
+
このコマンドは、ノードのファイルシステム構成が元に戻す準備ができていることを確認し、元に戻します。前提条件が特定された場合は、それらに対処してから `revert_to`コマンドを再実行する必要があります。

+

NOTE: システム コンソールを使用してリバート プロセスを監視すると、ノードシェルよりも詳細な情報が表示されます。

+
AUTOBOOTがtrueに設定されている場合、コマンドが完了するとノードでONTAPがリブートします。

+
AUTOBOOTがfalseの場合、コマンドが終了するとLOADERプロンプトが表示されます。 `yes`を入力して元に戻し、その後、 `boot_ontap`を使用してノードを手動で再起動してください。

. ノードが再起動したら、新しいソフトウェアが実行されていることを確認します：
+
[source, cli]
----
system node image show
----
+
次の例では、image1が新しいONTAPバージョンで、node0で現在のバージョンとして設定されています。

+
[listing]
----
cluster1::*> system node image show
                 Is      Is                 Install
Node     Image   Default Current Version    Date
-------- ------- ------- ------- --------   -------------------
node0
         image1  true    true    X.X.X       MM/DD/YYYY TIME
         image2  false   false   Y.Y.Y      MM/DD/YYYY TIME
node1
         image1  true    false   X.X.X      MM/DD/YYYY TIME
         image2  false   true    Y.Y.Y      MM/DD/YYYY TIME
4 entries were displayed.
----
. ノードのリバートステータスが完了していることを確認します：
+
[source, cli]
----
system node upgrade-revert show -node <nodename>
----
+
ステータスが「complete」、「not needed」、または「there are no table entries returned」のいずれかになっている必要があります。

. HA ペアの他のノードでこれらの手順を繰り返し、さらに追加の HA ペアごとにこれらの手順を繰り返します。
+
MetroCluster構成がある場合は、構成内の両方のクラスターでこれらの手順を繰り返す必要があります

. すべてのノードを元に戻した後、クラスターの高可用性を再度有効にします：
+
[source, cli]
----
storage failover modify -node* -enabled true
----


--
.2ノードクラスタ
--
. リバートするノードにログインします。
+
ノードをリバートするには、そのノードのノード管理LIFを通じてクラスタにログインする必要があります。

. クラスターの高可用性（HA）を無効にします：
+
[source, cli]
----
cluster ha modify -configured false
----
. ストレージフェイルオーバーを無効にする：
+
[source, cli]
----
storage failover modify -node <nodename> -enabled false
----
+
ストレージ フェイルオーバーを無効にするのは、HAペアに対して1度だけです。一方のノードでストレージ フェイルオーバーを無効にすると、そのノードのパートナーでもストレージ フェイルオーバーが無効になります。

. ノードのターゲット ONTAP ソフトウェア イメージをデフォルト イメージに設定します：
+
[source, cli]
----
system image modify -node <nodename> -image <target_image> -isdefault true
----
. ターゲットの ONTAP ソフトウェアイメージが、元に戻すノードのデフォルトイメージとして設定されていることを確認します：
+
[source, cli]
----
system image show
----
+
次の例は、バージョン 9.13.1 が node0 のデフォルト イメージとして設定されていることを示しています：

+
[listing]
----
cluster1::*> system image show
                 Is      Is                 Install
Node     Image   Default Current Version    Date
-------- ------- ------- ------- --------   -------------------
node0
         image1  false   true    9.14.1      MM/DD/YYYY TIME
         image2  true    false   9.13.1      MM/DD/YYYY TIME
node1
         image1  true    true    9.14.1      MM/DD/YYYY TIME
         image2  false   false   9.13.1      MM/DD/YYYY TIME
4 entries were displayed.
----
. ノードが現在epsilonを保持しているかどうかを確認します：
+
[source, cli]
----
cluster show -node <nodename>
----
+
次の例では、node1にイプシロンが設定されています。

+
[listing]
----
cluster1::*> cluster show -node node1

          Node: node1
          UUID: 026efc12-ac1a-11e0-80ed-0f7eba8fc313
       Epsilon: true
   Eligibility: true
        Health: true
----
+
.. ノードがイプシロンを保持している場合は、イプシロンをノードのパートナーに転送できるように、ノード上でイプシロンを false としてマークします：
+
[source, cli]
----
cluster modify -node <nodename> -epsilon false
----
.. パートナー ノードで epsilon を true にマークして、epsilon をノードのパートナーに転送します：
+
[source, cli]
----
cluster modify -node <node_partner_name> -epsilon true
----


. ノードがリバートの準備ができていることを確認します：
+
[source, cli]
----
system node revert-to -node <nodename> -check-only true -version 9.x
----
+
 `check-only`パラメータは、スナップショットポリシーを無効にしたり、ONTAPの新しいバージョンにアップグレードした後に作成されたスナップショットを削除したりするなど、元に戻す前に対処する必要がある条件を識別します。

+
 `-version`オプションは、リバート先のONTAPリリースを指します。ONTAPバージョンの最初の2つの値のみが必要です。たとえば、9.14.1から9.13.1にリバートする場合、 `-version`オプションの正しい値は9.13です。

+
クラスタ設定がリバートされ、クラスタシェルからログアウトされます。

. ノードのクラスタ構成を元に戻します：
+
[source, cli]
----
system node revert-to -node <nodename> -version 9.x
----
. ログイン プロンプトを待ち、システムシェルにログインするかどうかを尋ねられたら `No`を入力します。
+
ログインプロンプトが表示されるまで30分以上かかる場合があります。

. admin でクラスターシェルにログインします。
. ノードシェルに切り替えます：
+
[source, cli]
----
run -node <nodename>
----
+
クラスタシェルに再ログインしてからノードシェル コマンドを使用できるようになるまでに、数分かかることがあります。コマンドが失敗した場合は、数分待ってからもう一度試してください。

. ノードのファイルシステム構成を元に戻します：
+
[source, cli]
----
revert_to 9.x
----
+
このコマンドは、ノードのファイルシステム構成が元に戻す準備ができていることを確認し、元に戻します。前提条件が特定された場合は、それらに対処してから `revert_to`コマンドを再実行する必要があります。

+

NOTE: システム コンソールを使用してリバート プロセスを監視すると、ノードシェルよりも詳細な情報が表示されます。

+
AUTOBOOTがtrueに設定されている場合、コマンドが完了するとノードでONTAPがリブートします。

+
AUTOBOOTがfalseの場合、コマンドの終了時にLOADERプロンプトが表示されます。 `yes`を入力して元に戻し、その後、 `boot_ontap`を使用してノードを手動で再起動してください。

. ノードが再起動したら、新しいソフトウェアが実行されていることを確認します：
+
[source, cli]
----
system node image show
----
+
次の例では、image1が新しいONTAPバージョンで、node0で現在のバージョンとして設定されています。

+
[listing]
----
cluster1::*> system node image show
                 Is      Is                 Install
Node     Image   Default Current Version    Date
-------- ------- ------- ------- --------   -------------------
node0
         image1  true    true    X.X.X       MM/DD/YYYY TIME
         image2  false   false   Y.Y.Y      MM/DD/YYYY TIME
node1
         image1  true    false   X.X.X      MM/DD/YYYY TIME
         image2  false   true    Y.Y.Y      MM/DD/YYYY TIME
4 entries were displayed.
----
. ノードのリバートステータスが完了していることを確認します：
+
[source, cli]
----
system node upgrade-revert show -node <nodename>
----
+
ステータスが「complete」、「not needed」、または「there are no table entries returned」のいずれかになっている必要があります。

. HA ペアの他のノードでもこれらの手順を繰り返します。
. 両方のノードを元に戻した後、クラスタの高可用性を再度有効にします：
+
[source, cli]
----
cluster ha modify -configured true
----
. 両方のノードでストレージフェイルオーバーを再度有効にします：
+
[source, cli]
----
storage failover modify -node <nodename> -enabled true
----


--
====
.関連情報
* link:https://docs.netapp.com/us-en/ontap-cli/storage-failover-modify.html["storage failover modify"^]

