---
permalink: revert/task_things_to_verify_before_revert.html 
sidebar: sidebar 
keywords: ontap, revert, reversion, reverting, downgrade, downgrading, preparation, pre-revert, checks, verification, cluster health, storage health, system time, jobs 
summary: ONTAPをリバートする前に、クラスタの健全性、ストレージの健全性、システム時刻を確認してください。また、クラスタ上でジョブが実行されていないことも確認してください。 
---
= ONTAPクラスタをリバートする前に実行するシステム検証
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
ONTAPクラスタをリバートする前に、クラスタの健全性、ストレージの健全性、およびシステム時刻を確認する必要があります。また、クラスタでジョブが実行されていないことも確認する必要があります。



== クラスタの健全性の確認

ONTAP クラスタをリバートする前に、ノードが正常であり、クラスタに参加する資格があること、およびクラスタがクォーラム内にあることを確認する必要があります。

.手順
. クラスタ内のノードがオンラインで、クラスタに参加するための条件を満たしていることを確認します。
+
[source, cli]
----
cluster show
----
+
この例では、すべてのノードが正常であり、クラスターに参加する資格があります。

+
[listing]
----
cluster1::> cluster show
Node                  Health  Eligibility
--------------------- ------- ------------
node0                 true    true
node1                 true    true
----
+
正常に機能していないノードや条件を満たしていないノードがある場合は、EMSログでエラーを確認して適切に修正します。

. 権限レベルをadvancedに設定します。
+
[source, cli]
----
set -privilege advanced
----
+
Enter `y`を押して続行します。

. 各RDBプロセスの構成の詳細を確認します。
+
** リレーショナル データベースのエポックとデータベースのエポックが各ノードで一致すること。
** リングごとのクォーラム マスターがすべてのノードで同一であること。
+
各リングのクォーラム マスターが異なる場合がある点に注意してください。

+
[cols="2*"]
|===
| この RDB プロセスを表示するには： | コマンド 


 a| 
管理アプリケーション
 a| 
[source, cli]
----
cluster ring show -unitname mgmt
----


 a| 
ボリューム ロケーション データベース
 a| 
[source, cli]
----
cluster ring show -unitname vldb
----


 a| 
仮想インターフェイス マネージャ
 a| 
[source, cli]
----
cluster ring show -unitname vifmgr
----


 a| 
SAN管理デーモン
 a| 
[source, cli]
----
cluster ring show -unitname bcomd
----
|===
+
次の例は、ボリューム ロケーション データベースのプロセスを示しています。

+
[listing]
----
cluster1::*> cluster ring show -unitname vldb
Node      UnitName Epoch    DB Epoch DB Trnxs Master    Online
--------- -------- -------- -------- -------- --------- ---------
node0     vldb     154      154      14847    node0     master
node1     vldb     154      154      14847    node0     secondary
node2     vldb     154      154      14847    node0     secondary
node3     vldb     154      154      14847    node0     secondary
4 entries were displayed.
----


. admin権限レベルに戻ります。
+
[source, cli]
----
set -privilege admin
----
. SAN環境を使用している場合は、各ノードがSANクォーラムにあることを確認します。
+
[source, cli]
----
event log show  -severity informational -message-name scsiblade.*
----
+
各ノードの最新のscsibladeイベント メッセージに、SCSIブレードがクォーラムにあることが示されます。

+
[listing]
----
cluster1::*> event log show  -severity informational -message-name scsiblade.*
Time             Node       Severity       Event
---------------  ---------- -------------- ---------------------------
MM/DD/YYYY TIME  node0      INFORMATIONAL  scsiblade.in.quorum: The scsi-blade ...
MM/DD/YYYY TIME  node1      INFORMATIONAL  scsiblade.in.quorum: The scsi-blade ...
----


.関連情報
link:../system-admin/index.html["システム管理"]



== ストレージの健全性の確認

ONTAPクラスターを元に戻す前に、ディスク、アグリゲート、ボリュームのステータスを確認する必要があります。

.手順
. ディスクのステータスを確認します。
+
[cols="2*"]
|===
| 確認するには... | 操作 


 a| 
破損ディスク
 a| 
.. 破損ディスクを表示します。
+
[source, cli]
----
storage disk show -state broken
----
.. 破損ディスクを取り外すか交換します。




 a| 
メンテナンス中または再構築中のディスク
 a| 
.. メンテナンス、保留、または再構築の状態のディスクを表示します。
+
[source, cli]
----
storage disk show -state maintenance|pending|reconstructing
----
.. 続行する前に、メンテナンスまたは再構築操作が完了するまで待機します。


|===
. ストレージ アグリゲートを含む物理ストレージと論理ストレージの状態を表示して、すべてのアグリゲートがオンラインであることを確認します：+
+
[source, cli]
----
storage aggregate show -state !online
----
+
このコマンドは、オンラインで_ない_アグリゲートを表示します。メジャー アップグレードまたはリバートを実行する前後には、すべてのアグリゲートがオンラインになっている必要があります。

+
[listing]
----
cluster1::> storage aggregate show -state !online
There are no entries matching your query.
----
. オンラインで_ない_ボリュームを表示して、すべてのボリュームがオンラインであることを確認します：
+
[source, cli]
----
volume show -state !online
----
+
メジャー アップグレードまたはリバートの実行前と実行後には、すべてのボリュームがオンラインになっている必要があります。

+
[listing]
----
cluster1::> volume show -state !online
There are no entries matching your query.
----
. 整合性のないボリュームがないことを確認します。
+
[source, cli]
----
volume show -is-inconsistent true
----
+
不一致なボリュームに対処する方法については、link:https://kb.netapp.com/Advice_and_Troubleshooting/Data_Storage_Software/ONTAP_OS/Volume_Showing_WAFL_Inconsistent["NetApp ナレッジベース：WAFL に一貫性のないボリューム"^]を参照してください。



.関連情報
link:../disks-aggregates/index.html["ディスクおよびアグリゲートの管理"]



== システム時刻を確認する

ONTAP クラスタを元に戻す前に、NTP が設定されており、クラスタ全体で時刻が同期されていることを確認する必要があります。

.手順
. クラスターが NTP サーバーに関連付けられていることを確認します：
+
[source, cli]
----
cluster time-service ntp server show
----
. 各ノードの日付と時刻が同じであることを確認します：
+
[source, cli]
----
cluster date show
----
+
[listing]
----
cluster1::> cluster date show
Node      Date                Timezone
--------- ------------------- -------------------------
node0     4/6/2013 20:54:38   GMT
node1     4/6/2013 20:54:38   GMT
node2     4/6/2013 20:54:38   GMT
node3     4/6/2013 20:54:38   GMT
4 entries were displayed.
----




== 実行中のジョブがないことの確認

ONTAPクラスタをリバートする前に、クラスタ ジョブのステータスを確認する必要があります。アグリゲート、ボリューム、NDMP（ダンプまたはリストア）、またはSnapshotジョブ（作成、削除、移動、変更、レプリケート、マウント ジョブなど）が実行中またはキューに登録されている場合は、ジョブが正常に完了するのを待つか、キューに登録されているエントリを停止する必要があります。

.手順
. 実行中またはキューに登録されているアグリゲート、ボリューム、またはSnapshotジョブのリストを確認します：
+
[source, cli]
----
job show
----
+
この例では、2 つのジョブがキューに入れられています：

+
[listing]
----
cluster1::> job show
                            Owning
Job ID Name                 Vserver    Node           State
------ -------------------- ---------- -------------- ----------
8629   Vol Reaper           cluster1   -              Queued
       Description: Vol Reaper Job
8630   Certificate Expiry Check
                            cluster1   -              Queued
       Description: Certificate Expiry Check
----
. 実行中またはキューに入っているアグリゲート、ボリューム、またはスナップショット ジョブを削除します：
+
[source, cli]
----
job delete -id <job_id>
----
. アグリゲート、ボリューム、またはスナップショット ジョブが実行中またはキューに入っていないことを確認します：
+
[source, cli]
----
job show
----
+
次の例では、実行中のジョブとキューに登録されているジョブがすべて削除されています。

+
[listing]
----
cluster1::> job show
                            Owning
Job ID Name                 Vserver    Node           State
------ -------------------- ---------- -------------- ----------
9944   SnapMirrorDaemon_7_2147484678
                            cluster1   node1          Dormant
       Description: Snapmirror Daemon for 7_2147484678
18377  SnapMirror Service Job
                            cluster1   node0          Dormant
       Description: SnapMirror Service Job
2 entries were displayed
----


.関連情報
* link:https://docs.netapp.com/us-en/ontap-cli/storage-disk-show.html["storage disk show"^]

