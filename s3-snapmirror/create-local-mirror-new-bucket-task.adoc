---
sidebar: sidebar 
permalink: s3-snapmirror/create-local-mirror-new-bucket-task.html 
keywords: snapmirror, create local, new bucket, create a mirror relationship for an existing bucket 
summary: 新しいS3バケットを作成すると、同じクラスター内のSnapMirror S3宛先にすぐに保護できます。データのミラーリングは、ソースと同じストレージVMまたは別のストレージVM内のバケットに行うことができます。 
---
= ローカルクラスタ上の新しい ONTAP S3 バケットのミラー関係を作成する
:hardbreaks:
:toclevels: 1
:allow-uri-read: 
:toclevels: 1
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
新しいS3バケットを作成すると、同じクラスター内のSnapMirror S3宛先にすぐに保護できます。データのミラーリングは、ソースと同じストレージVMまたは別のストレージVM内のバケットに行うことができます。

.開始する前に
* ONTAPのバージョン、ライセンス、S3サーバの設定に関する要件を満たしている必要があります。
* ソースとデスティネーションのStorage VM間にピア関係が確立されている必要があります。
* ソースとデスティネーションのVMのCA証明書が必要です。自己署名CA証明書または外部CAベンダーが署名した証明書を使用できます。


[role="tabbed-block"]
====
.System Manager
--
. このStorage VMに対する最初のSnapMirror S3関係を作成する場合は、ソースとデスティネーションの両方のStorage VMに対するrootユーザのキーがあることを確認し、ない場合は再生成します。
+
.. *Storage > Storage VMs* をクリックし、Storage VMを選択します。
.. *設定*タブで、S3 タイルの image:icon_pencil.gif["編集アイコン"] をクリックします。
.. *Users*タブで、rootユーザーのアクセスキーがあることを確認します。
.. 存在しない場合は、*root*の横にあるimage:icon_kabob.gif["メニューオプションアイコン"]をクリックし、*キーの再生成*をクリックします。既にキーが存在する場合は、再生成しないでください。


. ストレージ VM を編集して、ソース ストレージ VM と宛先ストレージ VM の両方でユーザーを追加し、ユーザーをグループに追加します：*ストレージ > ストレージ VM* をクリックし、ストレージ VM をクリックして、*設定* をクリックし、S3 の下の image:icon_pencil.gif["編集アイコン"] をクリックします。
+
詳細については、link:../task_object_provision_add_s3_users_groups.html["S3のユーザとグループの追加"]を参照してください。

. 既存のものがなく、デフォルトポリシーを使用したくない場合は、SnapMirror S3ポリシーを作成してください：
+
.. *Protection > Overview* をクリックし、*Local Policy Settings* をクリックします。
.. *Protection Policies*の横にあるimage:../media/icon_arrow.gif["矢印アイコン"]をクリックし、*Add*をクリックします。
+
*** ポリシーの名前と説明を入力します。
*** ポリシーの対象として、クラスタまたはSVMを選択します。
*** SnapMirror S3 関係には *継続* を選択します。
*** *Throttle*と*Recovery Point Objective*の値を入力します。




. SnapMirror保護を適用してバケットを作成します。
+
.. *Storage > Buckets* をクリックし、*Add* をクリックします。
.. 名前を入力し、ストレージ VM を選択し、サイズを入力して、*その他のオプション*をクリックします。
.. *権限*で、*追加*をクリックします。権限の確認は任意ですが、推奨されます。
+
*** *Principal* と *Effect* - ユーザーグループ設定に対応する値を選択するか、デフォルトを受け入れます。
*** *Actions* - 次の値が表示されていることを確認します：
+
[listing]
----
GetObject,PutObject,DeleteObject,ListBucket,GetBucketAcl,GetObjectAcl,ListBucketMultipartUploads,ListMultipartUploadParts
----
*** *Resources* - デフォルト``(bucketname, bucketname/*)``または必要な他の値を使用します
+
これらのフィールドの詳細については、link:../task_object_provision_manage_bucket_access.html["バケットへのユーザ アクセスの管理"]を参照してください。



.. *保護*で、*SnapMirrorを有効にする（ONTAPまたはCloud）*にチェックを入れます。次に、以下の値を入力します：
+
*** デスティネーション
+
**** *TARGET*：ONTAPシステム
**** *CLUSTER*：ローカル クラスターを選択します。
**** *STORAGE VM*：ローカルクラスタ上のストレージ VM を選択します。
**** *S3 SERVER CA CERTIFICATE*：ソース証明書の内容をコピーして貼り付けます。


*** ソース
+
**** *S3 SERVER CA CERTIFICATE*：宛先証明書の内容をコピーして貼り付けます。






. 外部 CA ベンダーによって署名された証明書を使用している場合は、* 宛先で同じ証明書を使用する * をオンにします。
. *宛先設定*をクリックすると、バケット名、容量、パフォーマンスサービスレベルのデフォルトの代わりに独自の値を入力することもできます。
. *保存*をクリックします。ソースストレージVMに新しいバケットが作成され、デスティネーションストレージVMに作成された新しいバケットにミラーリングされます。


.ロックされたバケットのバックアップ
ONTAP 9.14.1以降では、ロックされたS3バケットをバックアップし、必要に応じてリストアできます。

新規または既存のバケットの保護設定を定義する際に、ソース クラスタとデスティネーション クラスタがONTAP 9.14.1以降を実行し、ソース バケットでオブジェクト ロックが有効になっている場合、デスティネーション バケットでオブジェクト ロックを有効にできます。ソース バケットのオブジェクト ロック モードとロック保持期間は、デスティネーション バケットにレプリケートされたオブジェクトに適用されます。また、*デスティネーション設定*セクションで、デスティネーション バケットに異なるロック保持期間を定義することもできます。この保持期間は、ソース バケットとS3インターフェースからレプリケートされた、ロックされていないオブジェクトにも適用されます。

バケットでオブジェクト ロックを有効にする方法については、link:../s3-config/create-bucket-task.html["バケットの作成"]を参照してください。

--
.CLI
--
. この SVM の最初のSnapMirror S3 関係である場合は、ソース SVM と宛先 SVM の両方にルート ユーザー キーが存在することを確認し、存在しない場合は再生成します：
`vserver object-store-server user show`
+
ルートユーザーのアクセスキーがあることを確認してください。ない場合は、以下を入力してください（
`vserver object-store-server user regenerate-keys -vserver _svm_name_ -user _root_`

+
キーがすでにある場合は再生成しないでください。

. ソースとデスティネーションの両方のSVMにバケットを作成します。
+
`vserver object-store-server bucket create -vserver svm_name -bucket bucket_name [-size _integer_[KB|MB|GB|TB|PB]] [-comment _text_] [_additional_options_]`

. ソースとデスティネーションの両方のSVMで、デフォルトのバケット ポリシーにアクセス ルールを追加します。
+
`vserver object-store-server bucket policy add-statement -vserver _svm_name_ -bucket _bucket_name_ -effect {allow|deny} -action _object_store_actions_ -principal _user_and_group_names_ -resource _object_store_resources_ [-sid _text_] [-index _integer_]`

+
....
src_cluster::> vserver object-store-server bucket policy add-statement -bucket test-bucket -effect allow -action GetObject,PutObject,DeleteObject,ListBucket,GetBucketAcl,GetObjectAcl,ListBucketMultipartUploads,ListMultipartUploadParts -principal - -resource test-bucket, test-bucket /*
....
. 既存のSnapMirror S3ポリシーがなく、デフォルトポリシーを使用したくない場合は、SnapMirror S3ポリシーを作成してください：
`snapmirror policy create -vserver svm_name -policy policy_name -type continuous [-rpo _integer_] [-throttle _throttle_type_] [-comment _text_] [_additional_options_]`
+
パラメータ：

+
** `continuous` – SnapMirror S3 関係の唯一のポリシータイプ（必須）。
** `-rpo` – 回復ポイント目標の時間を秒単位で指定します（オプション）。
** `-throttle` – スループット/帯域幅の上限をキロバイト/秒単位で指定します（オプション）。
+
.例
[listing]
----
src_cluster::> snapmirror policy create -vserver vs0 -type continuous -rpo 0 -policy test-policy
----


. 管理SVMにCAサーバ証明書をインストールします。
+
.. _source_ S3 サーバーの証明書に署名した CA 証明書を管理 SVM にインストールします：
`security certificate install -type server-ca -vserver _admin_svm_ -cert-name _src_server_certificate_`
.. 管理 SVM に、_宛先_ S3 サーバーの証明書に署名した CA 証明書をインストールします：
`security certificate install -type server-ca -vserver _admin_svm_ -cert-name _dest_server_certificate_` + 外部 CA ベンダーによって署名された証明書を使用している場合は、この証明書を管理 SVM にインストールするだけで済みます。
+
 `security certificate install`の詳細については、link:https://docs.netapp.com/us-en/ontap-cli/security-certificate-install.html["ONTAPコマンド リファレンス"^]をご覧ください。



. SnapMirror S3 関係を作成します：
`snapmirror create -source-path _src_svm_name_:/bucket/_bucket_name_ -destination-path _dest_peer_svm_name_:/bucket/_bucket_name_, ...} [-policy policy_name]``
+
作成したポリシーを使用することも、デフォルトのポリシーをそのまま使用することもできます。

+
....
src_cluster::> snapmirror create -source-path vs0-src:/bucket/test-bucket -destination-path vs1-dest:/vs1/bucket/test-bucket-mirror -policy test-policy
....
. ミラーリングがアクティブであることを確認します：
`snapmirror show -policy-type continuous -fields status`


--
====
.関連情報
* link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-create.html["snapmirror create"^]
* link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-policy-create.html["snapmirror policy create"^]
* link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-show.html["snapmirror show"^]

