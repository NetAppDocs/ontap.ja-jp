---
sidebar: sidebar 
permalink: s3-snapmirror/create-remote-mirror-existing-bucket-task.html 
keywords: snapmirror create a mirror relationship for an existing bucket, existing bucket, protect existing s3 buckets,s3 snapmirror relationship, remote cluster,  storage vm, bucket access policy, snapmirror protection, mirror buckets, snapmirror policy, source vm, destination vm, peering, mirror data to remote cluster, first s3 snapmirror relationship 
summary: 既存の S3 バケットの保護はいつでも開始できます。たとえば、 S3 設定を ONTAP 9.10.1 より前のリリースからアップグレードした場合などです。 
---
= 既存のバケットのミラー関係を作成する（リモートクラスタ）
:toc: macro
:hardbreaks:
:toclevels: 1
:allow-uri-read: 
:toc: 
:toclevels: 1
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/
:toc-position: content


[role="lead"]
既存の S3 バケットの保護はいつでも開始できます。たとえば、 S3 設定を ONTAP 9.10.1 より前のリリースからアップグレードした場合などです。

.必要なもの
* ONTAP のバージョン、ライセンス、 S3 サーバの設定に関する要件を満たしている必要があります。
* ソースクラスタとデスティネーションクラスタの間にピア関係が存在し、ソース Storage VM とデスティネーション Storage VM の間にピア関係が存在します。
* CA 証明書は、ソース VM とデスティネーション VM に必要です。自己署名 CA 証明書または外部 CA ベンダーが署名した証明書を使用できます。


.このタスクについて
タスクはソースとデスティネーションの両方のクラスタで実行する必要があります。



== System Manager の手順の略

. この Storage VM の最初の S3 SnapMirror 関係である場合は、ソースとデスティネーションの Storage VM の両方に root ユーザキーが存在することを確認し、存在しない場合は再生成します。
+
.. Storage > Storage VM* をクリックし、 Storage VM を選択します。
.. [ * 設定 * ] タブで、をクリックします image:icon_pencil.gif["編集アイコン"] を * S3 * タイルに追加します。
.. [*Users*] タブで、 root ユーザのアクセスキーがあることを確認します。
.. 表示されていない場合は、をクリックします image:icon_kabob.gif["[ 詳細 ] アイコン"] [*root*] の横にある [*Regenerate Key] をクリックします。すでにキーが存在する場合は、キーを再生成しないでください。


. ソース Storage VM とデスティネーション Storage VM の両方でユーザとグループのアクセスが正しいことを確認します。 * Storage > Storage VM の順にクリックし、 * Storage VM をクリックして、 * Settings * をクリックし、をクリックします image:icon_pencil.gif["編集アイコン"] * S3 の下 * 。
+
を参照してください link:../task_object_provision_add_s3_users_groups.html["S3 ユーザとグループを追加"] を参照してください。

. ソースクラスタに S3 SnapMirror ポリシーを作成します。これは、既存のポリシーがなく、デフォルトポリシーを使用しない場合に行います。
+
.. [* 保護 ] 、 [ 概要 *] の順にクリックし、 [ ローカルポリシーの設定 *] をクリックします。
.. をクリックします image:../media/icon_arrow.gif["右矢印"] [* 保護ポリシー * ] の横にある [* 追加 ] をクリックします。
.. ポリシー名と概要を入力します。
.. ポリシーのスコープとして、クラスタまたは SVM を選択します
.. S3 SnapMirror 関係には「 * Continuous * 」を選択します。
.. スロットル値および * 目標復旧時点 * 値を入力します。


. 既存のバケットのバケットアクセスポリシーが引き続きニーズを満たしていることを確認します。
+
.. [ * ストレージ ] 、 [ バケット ] の順にクリックし、保護するバケットを選択します。
.. [* アクセス許可 *] タブで、をクリックします image:icon_pencil.gif["編集アイコン"] * 編集 * をクリックし、 * 権限 * の下の * 追加 * をクリックします。
+
*** * 主な内容と効果 * ：ユーザーグループの設定に対応する値を選択するか、デフォルト値をそのまま使用します。
*** *アクション*：次の値が表示されていることを確認します。 `GetObject,PutObject,DeleteObject,ListBucket,GetBucketAcl,GetObjectAcl,ListBucketMultipartUploads,ListMultipartUploadParts`
*** *リソース*：デフォルトを使用します `(_bucketname, bucketname_/*)` 必要な値が含まれています。
+
を参照してください link:../task_object_provision_manage_bucket_access.html["バケットへのユーザアクセスを管理します"] これらのフィールドの詳細については、を参照してください。





. S3 SnapMirror 保護を使用して既存のバケットを保護します。
+
.. [ * ストレージ * ] > [* バケット * ] をクリックし、保護するバケットを選択します。
.. [*Protect] をクリックして、次の値を入力します。
+
*** 宛先
+
**** * ターゲット * ： ONTAP システム
**** * cluster * ：リモートクラスタを選択します。
**** * Storage VM * ：リモートクラスタの Storage VM を選択します。
**** * S3 サーバ CA 証明書 * ： _source_certificate の内容をコピーして貼り付けます。


*** ソース
+
**** * S3 サーバ CA 証明書 * ： _destination_certificate の内容をコピーして貼り付けます。








チェック * 外部 CA ベンダーが署名した証明書を使用している場合は、宛先で同じ証明書を使用します。

[* Destination Settings] をクリックすると、バケット名、容量、およびパフォーマンスサービスレベルのデフォルト値の代わりに独自の値を入力することもできます。

[Save] をクリックすると、既存のバケットがデスティネーション Storage VM の新しいバケットにミラーリングされます。



== CLI 手順の略

. この SVM の最初の S3 SnapMirror 関係の場合は、ソースとデスティネーションの両方の SVM に root ユーザキーが存在することを確認し、存在しない場合は再生成します。
`vserver object-store-server user show`+ rootユーザのアクセスキーがあることを確認します。表示されない場合は、次のように入力します。
`vserver object-store-server user regenerate-keys -vserver _svm_name_ -user _root_`+キーがすでに存在する場合は、キーを再生成しません。
. ミラーターゲットにするバケットをデスティネーション SVM 上に作成します。
+
`vserver object-store-server bucket create -vserver _svm_name_ -bucket _dest_bucket_name_ [-size _integer_[KB|MB|GB|TB|PB]] [-comment _text_] [_additional_options_]`

. ソースとデスティネーションの両方の SVM で、デフォルトのバケットポリシーのアクセスルールが正しいことを確認します。
+
`vserver object-store-server bucket policy add-statement -vserver _svm_name_ -bucket _bucket_name_ -effect {allow|deny} -action _object_store_actions_ -principal _user_and_group_names_ -resource _object_store_resources_ [-sid _text_] [-index _integer_]`

+
.例
[listing]
----
src_cluster::> vserver object-store-server bucket policy add-statement -bucket test-bucket -effect allow -action GetObject,PutObject,DeleteObject,ListBucket,GetBucketAcl,GetObjectAcl,ListBucketMultipartUploads,ListMultipartUploadParts -principal - -resource test-bucket, test-bucket /*
----
. ソース SVM に S3 SnapMirror ポリシーを作成します。これは、既存のポリシーがなく、デフォルトポリシーを使用しない場合に行います。
+
`snapmirror policy create -vserver svm_name -policy policy_name -type continuous [-rpo _integer_] [-throttle _throttle_type_] [-comment _text_] [_additional_options_]`

+
パラメータ

+
** `continuous` –S3 SnapMirror関係の唯一のポリシータイプ（必須）。
** `-rpo` –目標復旧時点の時間を秒単位で指定します（オプション）。
** `-throttle` –スループット/帯域幅の上限をキロバイト/秒単位で指定します（オプション）。
+
.例
[listing]
----
src_cluster::> snapmirror policy create -vserver vs0 -type continuous -rpo 0 -policy test-policy
----


. ソースクラスタとデスティネーションクラスタの管理 SVM に CA 証明書をインストールします。
+
.. ソースクラスタで、_destination_S3サーバ証明書に署名したCA証明書をインストールします。
`security certificate install -type server-ca -vserver _src_admin_svm_ -cert-name _dest_server_certificate_`
.. デスティネーションクラスタで、_source_S3サーバ証明書に署名したCA証明書をインストールします。
`security certificate install -type server-ca -vserver _dest_admin_svm_ -cert-name _src_server_certificate_`+外部のCAベンダーが署名した証明書を使用している場合は、ソースとデスティネーションの管理SVMに同じ証明書をインストールします。
+
を参照してください `security certificate install` 詳細はマニュアルページを参照してください。



. ソース SVM で、 S3 SnapMirror 関係を作成します。
+
`snapmirror create -source-path _src_svm_name_:/bucket/_bucket_name_ -destination-path dest_peer_svm_name:/bucket/_bucket_name_, ...} [-policy policy_name]`

+
作成したポリシーを使用することも、デフォルトのポリシーをそのまま使用することもできます。

+
.例
[listing]
----
src_cluster::> snapmirror create -source-path vs0:/bucket/test-bucket -destination-path vs1:/bucket/test-bucket-mirror -policy test-policy
----
. ミラーリングがアクティブであることを確認します。
`snapmirror show -policy-type continuous -fields status`

