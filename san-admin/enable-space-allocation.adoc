---
permalink: san-admin/enable-space-allocation.html 
sidebar: sidebar 
keywords: enable, space allocation, space reclamation, unmap, lun, hole punching, namespace, nvme, san 
summary: スペース割り当てを有効にして、ホストとストレージシステムがスペース管理で連携できるようにします。 
---
= SANプロトコルのONTAPスペース割り当てを有効にする
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
ONTAPのスペース割り当ては、LUNまたはNVMeネームスペースがスペース不足になった場合にオフラインになるのを防ぎ、SANホストでスペースを再生できるようにします。

ONTAPでスペースが割り当てられるかどうかは、使用しているSANプロトコルとONTAPのバージョンによって異なります。ONTAP 9.16.1以降では、iSCSI、FC、NVMeの各プロトコルについて、新規に作成したLUNおよびすべてのネームスペースに対してスペース割り当てがデフォルトで有効になります。

[cols="2,2,4a"]
|===
| ONTAPのバージョン | プロトコル | スペース割り当て 


| 9.16.1以降  a| 
* iSCSI
* FC
* NVMe

 a| 
新規作成されたLUNおよびすべてのネームスペースに対してデフォルトで有効



.2+| 9.15.1  a| 
* iSCSI
* FC

 a| 
新規作成されたLUNに対してデフォルトで有効



| NVMe | サポート対象外 


.2+| 9.14.1以前  a| 
* iSCSI
* FC

 a| 
新規作成されたLUNではデフォルトで無効



| NVMe | サポート対象外 
|===
スペース割り当てが有効な場合：

* LUNまたはネームスペースのスペースが不足すると、ONTAPはホストに書き込み処理に使用できる空きスペースがないことを通知します。そのため、LUNまたはネームスペースはオンラインのままで、読み取り処理は継続されます。ホストの設定に応じて、成功するか、ホストのファイルシステムがオフラインになるまで、ホストは書き込み処理を再試行します。LUNまたはネームスペースで使用可能な空きスペースが増えると、書き込み処理が再開されます。
+
スペース割り当てが有効になっていない場合、LUNまたはネームスペースのスペースが不足すると、すべてのI/O処理が失敗し、LUNまたはネームスペースがオフラインになります。通常の処理を再開するには、スペースの問題を解決する必要があります。パスとデバイスを動作状態にリストアするには、ホストでLUNデバイスの再スキャンが必要になる場合もあります。

* ホストはSCSIまたはNVMe（とも呼ばれる `TRIM`）処理を実行できます `UNMAP`。マッピング解除処理を使用すると、有効なデータがなくなったために不要になったデータブロックをホストが特定できます。識別は通常、ファイルの削除後に行われます。その後、ストレージシステムはこれらのデータブロックの割り当てを解除して、スペースを他の場所で消費できるようにします。このように割り当てを解除することで、特にデータの書き替え率が高いファイルシステムでは、全体的なストレージ効率が大幅に向上します。


.開始する前に
スペース割り当てを有効にするには、書き込みを完了できない場合にスペース割り当てエラーを正しく処理できるホスト構成が必要です。SCSIまたはNVMeを活用 `UNMAP`するには、SCSI SBC-3標準で定義されている論理ブロックプロビジョニングを使用できる構成が必要です。

現在、スペース割り当てを有効にした場合にシンプロビジョニングをサポートしているホストは次のとおりです。

* Citrix XenServer 6.5以降
* VMware ESXi 5.0以降
* Oracle Linux 6.2 UEKカーネル以降
* Red Hat Enterprise Linux 6.2以降
* SUSE Linux Enterprise Server 11以降
* Solaris 11.1以降
* ウィンドウ


.タスクの内容
クラスタをONTAP 9 .15.1以降にアップグレードした場合、ソフトウェアのアップグレード前に作成されたすべてのLUNのスペース割り当て設定は、ホストタイプに関係なく、アップグレード後も変更されません。たとえば、スペース割り当てが無効になっているVMwareホスト用にONTAP 9 .13.1でLUNが作成された場合、ONTAP 9 .15.1にアップグレードしても、そのLUNでのスペース割り当ては無効なままになります。

.手順
. スペース割り当てを有効にします。
+
[source, cli]
----
lun modify -vserver <vserver_name> -volume <volume_name> -lun <lun_name> -space-allocation enabled
----
. スペース割り当てが有効になっていることを確認します。
+
[source, cli]
----
lun show -vserver <vserver_name> -volume <volume_name> -lun <lun_name> -fields space-allocation
----
. ホストOSでスペース割り当てが有効になっていることを確認します。
+

NOTE: VMware ESXiの一部のバージョンなど、一部のホスト構成では、設定の変更が自動的に認識されるため、ユーザの操作は必要ありません。その他の設定では、デバイスの再スキャンが必要になる場合があります。一部のファイルシステムやボリュームマネージャでは、を使用したスペース再生を有効にするために、追加の設定が必要になる場合があります `SCSI UNMAP`。ファイルシステムの再マウントまたはOSの完全なリブートが必要になる場合があります。詳細については、ご使用のホストのドキュメントを参照してください。





== VMware ESXi 8.x以降のNVMeホスト用のホストの設定

NVMeプロトコルを使用してESXi 8.x以降を実行しているVMwareホストでは、ONTAPでスペース割り当てを有効にしたあとに、ホストで次の手順を実行する必要があります。

.手順
. ESXiホストで、DSMが無効になっていることを確認します。
+
`esxcfg-advcfg -g /SCSi/NVmeUseDsmTp4040`

+
想定される値は0です。

. NVMe DSMを有効にします。
+
`esxcfg-advcfg -s 1 /Scsi/NvmeUseDsmTp4040`

. DSMが有効になっていることを確認します。
+
`esxcfg-advcfg -g /SCSi/NVmeUseDsmTp4040`

+
想定される値は1です。



.関連リンク
詳細については、をご覧ください link:https://docs.netapp.com/us-en/ontap-sanhost/nvme_esxi_8.html["ESXi 8.x（ONTAP）向けのNVMe-oFホストの設定"^]。
