---
permalink: san-admin/enable-space-allocation.html 
sidebar: sidebar 
keywords: enable, space allocation, space reclamation, unmap, lun, hole punching, namespace, nvme, san 
summary: スペース割り当てを有効にして、ホストとストレージシステムがスペース管理で連携できるようにします。 
---
= SANプロトコルのONTAPスペース割り当ての有効化
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
ONTAPのスペース割り当て機能は、LUNやNVMeネームスペースがスペース不足になった場合にオフラインになるのを防ぎ、SANホストでスペースを再利用できるようにします。

ONTAPのスペース割り当てサポートは、SANプロトコルとONTAPのバージョンに基づいています。ONTAP 9.16.1以降では、新規作成されたLUNとすべてのネームスペースに対して、iSCSI、FC、NVMeプロトコルのスペース割り当てがデフォルトで有効になっています。

[cols="2,2,4a"]
|===
| ONTAPのバージョン | プロトコル | スペース割り当てのサポート 


| 9.16.1以降  a| 
* iSCSI
* FC
* NVMe

 a| 
新しく作成されたLUNとすべてのネームスペースに対してデフォルトで有効



.2+| 9.15.1  a| 
* iSCSI
* FC

 a| 
新規作成されたLUNについてデフォルトで有効



| NVMe | サポート対象外 


.2+| 9.14.1以前  a| 
* iSCSI
* FC

 a| 
新規作成されたLUNについてデフォルトで無効



| NVMe | サポート対象外 
|===
スペース割り当てが有効になっている場合の処理は、以下のとおりです。

* LUNまたはネームスペースでスペースが不足すると、ONTAPからホストに対して、書き込み処理に使用できる空きスペースがないことが通知されます。このとき、LUNまたはネームスペースはオンライン状態を維持し、読み取り処理は継続されます。ホストの設定に応じて、成功するまでホストが書き込み処理を再試行するか、ホスト ファイルシステムがオフラインに切り替わります。LUNまたはネームスペースで使用可能な空きスペースが増えると、書き込み処理が再開されます。
+
スペース割り当てが有効になっていない場合には、LUNまたはネームスペースのスペースが不足すると、すべてのI/O処理が失敗し、LUNまたはネームスペースはオフラインになります。通常の処理を再開するには、スペースの問題を解決する必要があります。パスとデバイスを動作状態にリストアするために、ホストでLUNデバイスを再スキャンする必要が生じる場合もあります。

* ホストはSCSIまたはNVME `UNMAP`（ `TRIM`とも呼ばれる）操作を実行できます。UNMAP操作により、ホストは有効なデータが含まれていないため不要になったデータブロックを識別できます。識別は通常、ファイルの削除後に行われます。その後、ストレージシステムはこれらのデータブロックの割り当てを解除し、そのスペースを他の場所で使用できるようにします。この割り当て解除により、特にデータの回転率が高いファイルシステムでは、全体的なストレージ効率が大幅に向上します。


.開始する前に
スペース割り当てを有効にするには、書き込みが完了できない場合にスペース割り当てエラーを適切に処理できるホスト構成が必要です。SCSIまたはNVME `UNMAP`を活用するには、SCSI SBC-3規格で定義されている論理ブロックプロビジョニングを使用できる構成が必要です。

現在、スペース割り当てを有効にした場合のシンプロビジョニングに対応しているホストは次のとおりです。

* Citrix XenServer 6.5以降
* VMware ESXi 5.0以降
* Oracle Linux 6.2 UEKカーネル以降
* Red Hat Enterprise Linux 6.2以降
* SUSE Linux Enterprise Server 11以降
* Solaris 11.1以降
* Windows


.タスク概要
クラスタをONTAP 9.15.1以降にアップグレードした場合、ソフトウェアのアップグレード前に作成されたすべてのLUNのスペース割り当て設定は、ホスト タイプに関係なく、アップグレード後も変更されません。たとえば、ONTAP 9.13.1でスペース割り当てが無効なVMwareホストにLUNが作成されていた場合、ONTAP 9.15.1にアップグレードしたあとも、そのLUNでのスペース割り当ては無効なままになります。

.手順
. スペース割り当てを有効にします。
+
[source, cli]
----
lun modify -vserver <vserver_name> -volume <volume_name> -lun <lun_name> -space-allocation enabled
----
. スペース割り当てが有効になっていることを確認します。
+
[source, cli]
----
lun show -vserver <vserver_name> -volume <volume_name> -lun <lun_name> -fields space-allocation
----
. ホストOSでスペース割り当てが有効になっていることを確認します。
+

NOTE: 一部のホスト構成（VMware ESXiの一部のバージョンを含む）では、設定変更が自動的に認識されるため、ユーザーの介入は必要ありません。その他の構成では、デバイスの再スキャンが必要になる場合があります。一部のファイルシステムおよびボリュームマネージャでは、 `SCSI UNMAP`を使用したスペース再利用を有効にするために、追加の特定の設定が必要になる場合があります。ファイルシステムの再マウントまたはOSの完全な再起動が必要になる場合があります。手順については、お使いのホストのドキュメントを参照してください。





== VMware ESXi 8.x以降のNVMeホストの設定

NVMeプロトコルを使用してESXi 8.x以降を実行しているVMwareホストでは、ONTAPでスペース割り当てを有効にしたあとに、ホストで以下の手順を実行する必要があります。

.手順
. ESXiホストで、DSMが無効になっていることを確認します。
+
`esxcfg-advcfg -g /SCSi/NVmeUseDsmTp4040`

+
正しい値は0です。

. NVMe DSMを有効にします。
+
`esxcfg-advcfg -s 1 /Scsi/NvmeUseDsmTp4040`

. DSMが有効になっていることを確認します。
+
`esxcfg-advcfg -g /SCSi/NVmeUseDsmTp4040`

+
正しい値は1です。



.関連リンク
link:https://docs.netapp.com/us-en/ontap-sanhost/nvme_esxi_8.html["ONTAPを使用したESXi 8.xのNVMe-oFホスト設定"^]についての詳細をご覧ください。
