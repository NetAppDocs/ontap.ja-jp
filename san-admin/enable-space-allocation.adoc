---
permalink: san-admin/enable-space-allocation.html 
sidebar: sidebar 
keywords: enable, space allocation, space reclamation, unmap, lun 
summary: スペース割り当てを有効にして、ホストとストレージシステムがスペース管理で連携できるようにします。 
---
= SANのスペース割り当てを有効にする
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
ホストとストレージシステムが連携してLUNのスペース管理を行えるように、スペース割り当てを有効にします。

ONTAP 9.15.1以降では、新しく作成したLUNに対するスペース割り当てがデフォルトで有効になります。以前のバージョンのONTAP（9.14.1以前）では、スペース割り当てがデフォルトで無効になっていました。

この設定を有効にする `space-allocation` と、次の利点が得られます。

* * ONTAPは、書き込みを処理するための空きスペースがないホストと通信できます*：この通信は、ホストがスペース不足の状況を処理するためのより優雅な方法です。LUNはオンラインのままですが、スペースが使用可能になるまで書き込みIOを処理できません。読み取りIOは引き続き実行できます。ホストOSへの正確な影響はホストの構成によって異なります。場合によっては、OSが成功するまで書き込みIOを再試行します。それ以外の場合は、ファイルシステムがオフラインになる可能性があります。
+

NOTE: この設定が有効になっていない場合 `space-allocation`、LUNはスペースの下限しきい値に達し、すべてのIOが失敗した時点での状態になり `space-error`ます。スペースの問題を解決したら、LUNを状態に戻す必要があり `online`ます。パスとデバイスを動作状態にリストアするには、ホストでLUNデバイスの再スキャンが必要になる場合もあります。

* *ホストは処理（別名 `TRIM`）を実行できます `SCSI UNMAP`*：これらの処理を使用すると、有効なデータが含まれなくなったために不要になったLUN上のデータブロックをホストが識別できます。識別は通常、ファイルの削除後に行われます。その後、ストレージシステムはこれらのデータブロックの割り当てを解除して、スペースを他の場所で消費できるようにします。このように割り当てを解除することで、特にデータの書き替え率が高いファイルシステムでは、全体的なストレージ効率が大幅に向上します。


.開始する前に
スペース割り当てを有効にするには、書き込みを完了できない場合にスペース割り当てエラーを正しく処理できるホスト構成が必要です。を活用する `SCSI UNMAP`には、SCSI SBC-3標準で定義されている論理ブロックプロビジョニングを使用できる構成が必要です。

現在、スペース割り当てを有効にした場合にSCSIシンプロビジョニングをサポートしているホストは次のとおりです。

* Citrix XenServer 6.5以降
* ESXi 5.0以降
* Oracle Linux 6.2 UEKカーネル以降
* Red Hat Enterprise Linux 6.2以降
* SUSE Linux Enterprise Server 11以降
* Solaris 11.1以降
* ウィンドウ


スペースの割り当てはNVMeホストではサポートされません。

.タスクの内容
クラスタをONTAP 9 .15.1にアップグレードした場合、ソフトウェアのアップグレード前に作成されたすべてのLUNのスペース割り当て設定は、ホストタイプに関係なく、アップグレード後も変更されません。たとえば、スペース割り当てが無効になっているVMwareホスト用にONTAP 9 .13.1でLUNが作成された場合、ONTAP 9 .15.1にアップグレードしても、そのLUNでのスペース割り当ては無効なままになります。

.手順
. スペース割り当てを有効にします。
+
[source, cli]
----
lun modify -vserver <vserver_name> -volume <volume_name> -lun <lun_name> -space-allocation enabled
----
. スペース割り当てが有効になっていることを確認します。
+
[source, cli]
----
lun show -vserver <vserver_name> -volume <volume_name> -lun <lun_name> -fields space-allocation
----
. ホストOSでスペース割り当てが有効になっていることを確認します。
+

NOTE: 一部のホスト構成（特にESX）では、設定の変更が自動的に認識されるため、ユーザの操作は不要です。その他の設定では、デバイスの再スキャンが必要になる場合があります。一部のファイルシステムやボリュームマネージャでは、を使用したスペース再生を有効にするために、追加の設定が必要になる場合があります `SCSI UNMAP`。ファイルシステムの再マウントまたはOSの完全なリブートが必要になる場合があります。ご使用のOSのマニュアルを参照してください。


