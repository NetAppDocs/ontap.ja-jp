---
permalink: san-admin/enable-space-allocation.html 
sidebar: sidebar 
keywords: enable, space allocation, space reclamation, unmap 
summary: スペース割り当てを有効にして、ホストとストレージシステムがスペース管理で連携できるようにします。 
---
= SANのスペース割り当てを有効にする
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
ホストとストレージシステムが連携してLUNのスペース管理を行えるように、スペース割り当てを有効にします。を有効にします `space-allocation` を設定すると、次の利点が得られます。

* * ONTAPは、書き込みを処理するための空きスペースがないホストと通信できます*：この通信は、ホストがスペース不足の状況を処理するためのより優雅な方法です。LUNはオンラインのままですが、スペースが使用可能になるまで書き込みIOを処理できません。読み取りIOは引き続き実行できます。ホストOSへの正確な影響はホストの構成によって異なります。場合によっては、OSが成功するまで書き込みIOを再試行します。それ以外の場合は、ファイルシステムがオフラインになる可能性があります。
+

NOTE: 状況に応じて `space-allocation` 設定が有効になっていない場合、LUNは次の状態になります。 `space-error` スペースの下限しきい値に達し、すべてのIOが失敗した場合。LUNを次の場所に戻す必要があります： `online` スペースの問題が解決された後の状態。パスとデバイスを動作状態にリストアするには、ホストでLUNデバイスの再スキャンが必要になる場合もあります。

* *ホストは `SCSI UNMAP` （時 々 `TRIM`）処理*：これらの処理を使用すると、有効なデータがなくなったために不要になったLUN上のデータブロックをホストが特定できます。識別は通常、ファイルの削除後に行われます。その後、ストレージシステムはこれらのデータブロックの割り当てを解除して、スペースを他の場所で消費できるようにします。このように割り当てを解除することで、特にデータの書き替え率が高いファイルシステムでは、全体的なストレージ効率が大幅に向上します。


.作業を開始する前に
スペース割り当てを有効にするには、書き込みを完了できない場合にスペース割り当てエラーを正しく処理できるホスト構成が必要です。活用 `SCSI UNMAP` SCSI SBC-3標準で定義されている論理ブロックプロビジョニングを使用できる設定が必要です。

現在、スペース割り当てを有効にした場合の SCSI シンプロビジョニングに対応しているホストは次のとおりです。

* Citrix XenServer 6.5 以降
* ESXi 5.0以降
* Oracle Linux 6.2 UEKカーネル以降
* Red Hat Enterprise Linux 6.2 以降
* SUSE Linux Enterprise Server 11以降
* Solaris 11.1以降
* Windows の場合


スペースの割り当てはNVMeホストではサポートされません。

.このタスクについて
ONTAP 9.15.1以降では、新しく作成したVMware LUNおよびHyper-V LUNに対してスペース割り当てがデフォルトで有効になり、新しく作成したVMwareおよびHyper-Vで使用されないLUNに対しては無効になります。


NOTE: クラスタをONTAP 9.15.1にアップグレードした場合、ソフトウェアのアップグレード前に作成されたすべてのLUNのスペース割り当て設定は、ホストタイプに関係なく、アップグレード後も変更されません。  たとえば、スペース割り当てが無効になっているVMwareホスト用にONTAP 9.13.1でLUNが作成された場合、ONTAP 9.15.1へのアップグレード後も、そのLUNでのスペース割り当ては無効なままです。

.手順
. スペース割り当てを有効にします。
+
`lun modify -vserver _vserver_name_ -volume _volume_name_ -lun _lun_name_ -space-allocation enabled`

. スペース割り当てが有効になっていることを確認します。
+
`lun show -vserver _vserver_name_ -volume _volume_name_ -lun _lun_name_ -fields space-allocation`

. ホストOSでスペース割り当てが有効になっていることを確認します。
+

NOTE: 一部のホスト構成（特にESX）では、設定の変更が自動的に認識されるため、ユーザの操作は不要です。その他の設定では、デバイスの再スキャンが必要になる場合があります。一部のファイルシステムやボリュームマネージャでは、 `SCSI UNMAP`。ファイルシステムの再マウントまたはOSの完全なリブートが必要になる場合があります。ご使用のOSのマニュアルを参照してください。


