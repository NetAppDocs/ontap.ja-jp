---
permalink: san-config/set-queue-depth-task.html 
sidebar: sidebar 
keywords: calculate, queue depth 
summary: ノードおよびFCポートのファンインあたりのITN数を最大にするために、ホストのFCキュー深度の調整が必要になる場合があります。LUNの最大数と1つのFCポートに接続できるHBAの数は、FCターゲット ポートで使用可能なキューの深度によって制限されます。 
---
= ONTAP SANホストのキュー深度を変更する
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
ノードあたりのITN数とFCポートのファンインの最大値を達成するには、ホスト上のキューの深さを変更する必要がある場合があります。環境に応じてlink:calculate-queue-depth-task.html["最適なキュー深度を計算する"]できます。



== AIXホスト

AIXホストのキュー デプスは、 `chdev`コマンドを使用して変更できます。 `chdev`コマンドを使用して行った変更は、再起動後も保持されます。

例：

* hdisk7デバイスのキュー深度を変更するには、次のコマンドを使用します。
+
`chdev -l hdisk7 -a queue_depth=32`

* fcs0 HBAのキュー深度を変更するには、次のコマンドを使用します。
+
`chdev -l fcs0 -a num_cmd_elems=128`

+
 `num_cmd_elems`のデフォルト値は200です。最大値は2,048です。

+
[NOTE]
====
 `num_cmd_elems`を変更するには HBA をオフラインにして、 `rmdev -l fcs0 -R`コマンドと `makdev -l fcs0 -P`コマンドを使用してオンラインに戻す必要がある場合があります。

====




== HP-UXホスト

HP-UXホスト上のLUNまたはデバイスのキュー深度は、カーネル パラメータ `scsi_max_qdepth`を使用して変更できます。HBAのキュー深度は、カーネル パラメータ `max_fcp_reqs`を使用して変更できます。

*  `scsi_max_qdepth`のデフォルト値は8です。最大値は255です。
+
`scsi_max_qdepth`は、 `kmtune`コマンドの `-u`オプションを使用して、実行中のシステムで動的に変更できます。変更はシステム上のすべてのデバイスに反映されます。例えば、LUNキューの深さを64に増やすには、次のコマンドを使用します：

+
`kmtune -u -s scsi_max_qdepth=64`

+
 `scsictl`コマンドを使用して、個々のデバイスファイルのキュー深度を変更できます。 `scsictl`コマンドによる変更は、システムの再起動後には保持されません。特定のデバイスファイルのキュー深度を表示および変更するには、次のコマンドを実行します：

+
`scsictl -a /dev/rdsk/c2t2d0`

+
`scsictl -m queue_depth=16 /dev/rdsk/c2t2d0`

*  `max_fcp_reqs`のデフォルト値は512です。最大値は1024です。
+
変更 `max_fcp_reqs`を有効にするには、カーネルを再構築し、システムを再起動する必要があります。例えば、HBAキューの深さを256に変更するには、次のコマンドを使用します：

+
`kmtune -u -s max_fcp_reqs=256`





== Solarisホスト

SolarisホストのLUNおよびHBAのキュー深度を設定できます。

* LUNキューの深さの場合：ホストで使用中のLUNの数にLUNごとのスロットル（lun-queue-depth）を掛けた値は、ホストのtgt-queue-depth値以下である必要があります。
* Sunスタックのキュー深度について：ネイティブドライバでは、HBAレベルでLUNごとまたはターゲットごと `max_throttle`の設定はできません。ネイティブドライバの `max_throttle`値を設定する場合は、 `/kernel/drv/sd.conf`ファイルおよび `/kernel/drv/ssd.conf`ファイルでデバイスタイプ（VID_PID）ごとに設定することをお勧めします。ホストユーティリティは、MPxIO構成ではこの値を64、Veritas DMP構成では8に設定します。


.手順
. `# cd/kernel/drv`
. `# vi lpfc.conf`
. 検索する `/tft-queue (/tgt-queue)`
+
`tgt-queue-depth=32`

+
[NOTE]
====
デフォルト値はインストール時に32に設定されます。

====
. 環境の構成に基づいて必要な値を設定します。
. ファイルを保存します。
.  `+sync; sync; sync; reboot -- -r+`コマンドを使用してホストを再起動します。




== VMwareホスト（QLogic HBAの場合）

 `esxcfg-module`コマンドを使用してHBAタイムアウト設定を変更します。 `esx.conf`ファイルを手動で更新することは推奨されません。

.手順
. rootユーザとしてサービス コンソールにログオンします。
.  `#vmkload_mod -l`コマンドを使用して、現在ロードされているQlogic HBAモジュールを確認します。
. Qlogic HBAの単一のインスタンスが1つの場合は、次のコマンドを実行します。
+
`#esxcfg-module -s ql2xmaxqdepth=64 qla2300_707`

+
[NOTE]
====
この例ではqla2300_707モジュールを使用しています。 `vmkload_mod -l`の出力に基づいて適切なモジュールを使用してください。

====
. 次のコマンドを使用して変更内容を保存します。
+
`#/usr/sbin/esxcfg-boot -b`

. 次のコマンドを使用してサーバをリブートします。
+
`#reboot`

. 次のコマンドを使用して変更内容を確認します。
+
.. `#esxcfg-module -g qla2300_707`
.. `qla2300_707 enabled = 1 options = 'ql2xmaxqdepth=64'`






== VMwareホスト（Emulex HBAの場合）

 `esxcfg-module`コマンドを使用してHBAタイムアウト設定を変更します。 `esx.conf`ファイルを手動で更新することは推奨されません。

.手順
. rootユーザとしてサービス コンソールにログオンします。
.  `#vmkload_mod -l grep lpfc`コマンドを使用して、現在ロードされているEmulex HBAを確認します。
. Emulex HBAのインスタンスが1つの場合は、次のコマンドを入力します。
+
`#esxcfg-module -s lpfc0_lun_queue_depth=16 lpfcdd_7xx`

+
[NOTE]
====
HBAのモデルに応じて、モジュールはlpfcdd_7xxまたはlpfcdd_732のいずれかになります。上記のコマンドではlpfcdd_7xxモジュールを使用しています。 `vmkload_mod -l`の結果に応じて適切なモジュールを使用してください。

====
+
このコマンドを実行すると、lpfc0で表されるHBAに対してLUNのキュー深度が16に設定されます。

. Emulex HBAのインスタンスが複数の場合は、次のコマンドを実行します。
+
`a esxcfg-module -s "lpfc0_lun_queue_depth=16 lpfc1_lun_queue_depth=16" lpfcdd_7xx`

+
lpfc0に対するLUNのキュー深度とlpfc1に対するLUNのキュー深度が16に設定されます。

. 次のコマンドを入力します。
+
`#esxcfg-boot -b`

.  `#reboot`を使用して再起動します。




== Windowsホスト（Emulex HBAの場合）

Windowsホストでは、 `LPUTILNT`ユーティリティを使用してEmulex HBAのキューの深さを更新できます。

.手順
.  `C:\WINNT\system32`ディレクトリにある `LPUTILNT`ユーティリティを実行します。
. 右側のメニューから*ドライブ パラメータ*を選択します。
. 下にスクロールして*QueueDepth*をダブルクリックします。
+
[NOTE]
====
*QueueDepth*を150より大きく設定する場合は、次のWindowsレジストリ値も適切に増やす必要があります：

`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\lpxnds\Parameters\Device\NumberOfRequests`

====




== Windowsホスト（Qlogic HBAの場合）

Windows ホストでは、 `SANsurfer` HBA マネージャ ユーティリティを使用して、Qlogic HBA のキュー深度を更新できます。

.手順
.  `SANsurfer` HBA マネージャー ユーティリティを実行します。
. *HBA ポート* > *設定* をクリックします。
. リスト ボックスで *Advanced HBA port settings* をクリックします。
.  `Execution Throttle`パラメータを更新します。




== Linuxホスト（Emulex HBAの場合）

Linuxホスト上のEmulex HBAのキュー深度を更新できます。更新内容を再起動後も維持するには、新しいRAMディスクイメージを作成し、ホストを再起動する必要があります。

.手順
. 変更するキュー深度パラメータを特定します。
+
`modinfo lpfc|grep queue_depth`

+
キュー深度パラメータのリストとその説明が表示されます。オペレーティングシステムのバージョンに応じて、以下のキュー深度パラメータの1つ以上を変更できます：

+
** `lpfc_lun_queue_depth`：特定のLUNにキューイングできるFCコマンドの最大数（uint）
** `lpfc_hba_queue_depth`：lpfc HBA にキューイングできる FC コマンドの最大数（uint）
** `lpfc_tgt_queue_depth`：特定のターゲットポートにキューイングできる FC コマンドの最大数（uint）
+
 `lpfc_tgt_queue_depth`パラメータは、Red Hat Enterprise Linux 7.xシステム、SUSE Linux Enterprise Server 11 SP4システム、および12.xシステムにのみ適用されます。



. Red Hat Enterprise Linux 5.x システムの `/etc/modprobe.conf`ファイルと、Red Hat Enterprise Linux 6.x または 7.x システム、あるいは SUSE Linux Enterprise Server 11.x または 12.x システムの `/etc/modprobe.d/scsi.conf`ファイルにキュー深度パラメータを追加して、キュー深度を更新します。
+
オペレーティング システムのバージョンに応じて、次のコマンドを 1 つ以上追加できます：

+
** `options lpfc lpfc_hba_queue_depth=new_queue_depth`
** `options lpfc lpfc_lun_queue_depth=new_queue_depth`
** `options lpfc_tgt_queue_depth=new_queue_depth`


. 新しい RAM ディスク イメージを作成し、ホストを再起動して、再起動後も更新が保持されるようにします。
+
詳細については、ご使用の Linux オペレーティング システムのバージョンのlink:../system-admin/index.html["システム管理"]を参照してください。

. 変更したキュー深度パラメータの値が更新されていることを確認します。
+


+
[listing]
----
root@localhost ~]#cat /sys/class/scsi_host/host5/lpfc_lun_queue_depth
      30
----
+
キュー深度の現在の値が表示されます。





== Linuxホスト（QLogic HBAの場合）

Linuxホスト上のQLogicドライバのデバイスキュー深度を更新できます。更新内容を再起動後も維持するには、新しいRAMディスクイメージを作成し、ホストを再起動する必要があります。QLogic HBA管理GUIまたはコマンドラインインターフェース（CLI）を使用して、QLogic HBAのキュー深度を変更できます。

このタスクでは、QLogic HBA CLI を使用して QLogic HBA キューの深さを変更する方法を示します。

.手順
. 変更するデバイス キュー深度パラメータを特定します。
+
`modinfo qla2xxx | grep ql2xmaxqdepth`

+
変更できるのは `ql2xmaxqdepth`キュー深度パラメータのみです。これは、各LUNに設定できる最大キュー深度を示します。デフォルト値はRHEL 7.5以降では64です。デフォルト値はRHEL 7.4以前では32です。

+
[listing]
----
root@localhost ~]# modinfo qla2xxx|grep ql2xmaxqdepth
parm:       ql2xmaxqdepth:Maximum queue depth to set for each LUN. Default is 64. (int)
----
. デバイスのキューの深さの値を更新します：
+
** 変更を永続的にする場合は、次の手順を実行します：
+
...  `/etc/modprobe.conf`ファイルに Red Hat Enterprise Linux 5.x システム用のキュー デプス パラメータを追加し、 `/etc/modprobe.d/scsi.conf`ファイルに Red Hat Enterprise Linux 6.x または 7.x システム、または SUSE Linux Enterprise Server 11.x または 12.x システム用のキュー デプス パラメータを追加して、キュー デプスを更新します： `options qla2xxx ql2xmaxqdepth=new_queue_depth`
... 新しい RAM ディスク イメージを作成し、ホストを再起動して、再起動後も更新が保持されるようにします。
+
詳細については、ご使用の Linux オペレーティング システムのバージョンのlink:../system-admin/index.html["システム管理"]を参照してください。



** 現在のセッションだけでパラメータを変更する場合は、次のコマンドを実行します。
+
`echo new_queue_depth > /sys/module/qla2xxx/parameters/ql2xmaxqdepth`

+
次の例では、キューの深さは128に設定されています。

+
[listing]
----
echo 128 > /sys/module/qla2xxx/parameters/ql2xmaxqdepth
----


. キュー深度の値が更新されたことを確認します。
+
`cat /sys/module/qla2xxx/parameters/ql2xmaxqdepth`

+
キュー深度の現在の値が表示されます。

. QLogic HBA BIOS からファームウェア パラメータ `Execution Throttle`を更新して、QLogic HBA キューの深さを変更します。
+
.. QLogic HBAの管理CLIにログインします。
+
`/opt/QLogic_Corporation/QConvergeConsoleCLI/qaucli`

.. メインメニューから `Adapter Configuration`オプションを選択します。
+
[listing]
----
[root@localhost ~]# /opt/QLogic_Corporation/QConvergeConsoleCLI/qaucli
Using config file: /opt/QLogic_Corporation/QConvergeConsoleCLI/qaucli.cfg
Installation directory: /opt/QLogic_Corporation/QConvergeConsoleCLI
Working dir: /root

QConvergeConsole

        CLI - Version 2.2.0 (Build 15)

    Main Menu

    1:  Adapter Information
    **2:  Adapter Configuration**
    3:  Adapter Updates
    4:  Adapter Diagnostics
    5:  Monitoring
    6:  FabricCache CLI
    7:  Refresh
    8:  Help
    9:  Exit


        Please Enter Selection: 2
----
.. アダプタ構成パラメータのリストから `HBA Parameters`オプションを選択します。
+
[listing]
----
1:  Adapter Alias
    2:  Adapter Port Alias
    **3:  HBA Parameters**
    4:  Persistent Names (udev)
    5:  Boot Devices Configuration
    6:  Virtual Ports (NPIV)
    7:  Target Link Speed (iiDMA)
    8:  Export (Save) Configuration
    9:  Generate Reports
   10:  Personality
   11:  FEC
(p or 0: Previous Menu; m or 98: Main Menu; ex or 99: Quit)
        Please Enter Selection: 3
----
.. HBA ポートのリストから、必要な HBA ポートを選択します。
+
[listing]
----
Fibre Channel Adapter Configuration

    HBA Model QLE2562 SN: BFD1524C78510
      1: Port   1: WWPN: 21-00-00-24-FF-8D-98-E0 Online
      2: Port   2: WWPN: 21-00-00-24-FF-8D-98-E1 Online
    HBA Model QLE2672 SN: RFE1241G81915
      3: Port   1: WWPN: 21-00-00-0E-1E-09-B7-62 Online
      4: Port   2: WWPN: 21-00-00-0E-1E-09-B7-63 Online


        (p or 0: Previous Menu; m or 98: Main Menu; ex or 99: Quit)
        Please Enter Selection: 1
----
+
HBA ポートの詳細が表示されます。

.. HBA パラメータ メニューから `Display HBA Parameters`オプションを選択して、 `Execution Throttle`オプションの現在の値を表示します。
+
 `Execution Throttle`オプションのデフォルト値は65535です。

+
[listing]
----
HBA Parameters Menu

=======================================================
HBA           : 2 Port: 1
SN            : BFD1524C78510
HBA Model     : QLE2562
HBA Desc.     : QLE2562 PCI Express to 8Gb FC Dual Channel
FW Version    : 8.01.02
WWPN          : 21-00-00-24-FF-8D-98-E0
WWNN          : 20-00-00-24-FF-8D-98-E0
Link          : Online
=======================================================

    1:  Display HBA Parameters
    2:  Configure HBA Parameters
    3:  Restore Defaults


        (p or 0: Previous Menu; m or 98: Main Menu; x or 99: Quit)
        Please Enter Selection: 1
--------------------------------------------------------------------------------
HBA Instance 2: QLE2562 Port 1 WWPN 21-00-00-24-FF-8D-98-E0 PortID 03-07-00
Link: Online
--------------------------------------------------------------------------------
Connection Options             : 2 - Loop Preferred, Otherwise Point-to-Point
Data Rate                      : Auto
Frame Size                     : 2048
Hard Loop ID                   : 0
Loop Reset Delay (seconds)     : 5
Enable Host HBA BIOS           : Enabled
Enable Hard Loop ID            : Disabled
Enable FC Tape Support         : Enabled
Operation Mode                 : 0 - Interrupt for every I/O completion
Interrupt Delay Timer (100us)  : 0
**Execution Throttle             : 65535**
Login Retry Count              : 8
Port Down Retry Count          : 30
Enable LIP Full Login          : Enabled
Link Down Timeout (seconds)    : 30
Enable Target Reset            : Enabled
LUNs Per Target                : 128
Out Of Order Frame Assembly    : Disabled
Enable LR Ext. Credits         : Disabled
Enable Fabric Assigned WWN     : N/A

Press <Enter> to continue:
----
.. 続行するには *Enter* を押してください。
.. HBA パラメータ メニューから、 `Configure HBA Parameters`オプションを選択して HBA パラメータを変更します。
.. 「パラメータの構成」メニューから `Execute Throttle`オプションを選択し、このパラメータの値を更新します。
+
[listing]
----
Configure Parameters Menu

=======================================================
HBA           : 2 Port: 1
SN            : BFD1524C78510
HBA Model     : QLE2562
HBA Desc.     : QLE2562 PCI Express to 8Gb FC Dual Channel
FW Version    : 8.01.02
WWPN          : 21-00-00-24-FF-8D-98-E0
WWNN          : 20-00-00-24-FF-8D-98-E0
Link          : Online
=======================================================

    1:  Connection Options
    2:  Data Rate
    3:  Frame Size
    4:  Enable HBA Hard Loop ID
    5:  Hard Loop ID
    6:  Loop Reset Delay (seconds)
    7:  Enable BIOS
    8:  Enable Fibre Channel Tape Support
    9:  Operation Mode
   10:  Interrupt Delay Timer (100 microseconds)
   11:  Execution Throttle
   12:  Login Retry Count
   13:  Port Down Retry Count
   14:  Enable LIP Full Login
   15:  Link Down Timeout (seconds)
   16:  Enable Target Reset
   17:  LUNs per Target
   18:  Enable Receive Out Of Order Frame
   19:  Enable LR Ext. Credits
   20:  Commit Changes
   21:  Abort Changes


        (p or 0: Previous Menu; m or 98: Main Menu; x or 99: Quit)
        Please Enter Selection: 11
Enter Execution Throttle [1-65535] [65535]: 65500
----
.. 続行するには *Enter* を押してください。
.. 「パラメータの構成」メニューから、 `Commit Changes`オプションを選択して変更を保存します。
.. メニューを終了します。



