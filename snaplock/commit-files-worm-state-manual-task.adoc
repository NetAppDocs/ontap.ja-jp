---
permalink: snaplock/commit-files-worm-state-manual-task.html 
sidebar: sidebar 
keywords: commit, file, worm, manually, nfs, cifs, read, only, automatically, program, appendable, nfs, cifs, chunk, vam 
summary: ファイルのWORM（Write Once, Read Many）状態へのコミットは、手動で、または自動的に行うことができます。追記可能WORMファイルを作成することもできます。 
---
= ONTAP SnapLockを使用してファイルをWORMにコミット
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
ファイルのWORM（Write Once, Read Many）状態へのコミットは、手動で、または自動的に行うことができます。追記可能WORMファイルを作成することもできます。



== ファイルのWORM状態への手動コミット

ファイルを手動でWORM状態にコミットするには、ファイルを読み取り専用にします。ファイルの読み書き属性は、NFSまたはCIFSで適切なコマンドやプログラムを使用して読み取り専用に変更できます。ファイルが早期にコミットされないようアプリケーションがファイルへの書き込みを完了したことを確認したい場合や、ボリューム数が多いために自動コミット スキャナでスケーリングの問題が発生する場合は、手動でファイルをコミットすることができます。

.開始する前に
* コミットするファイルがSnapLockボリュームに格納されている必要があります。
* ファイルが書き込み可能になっている必要があります。


.タスク概要
コマンドまたはプログラムが実行されると、ボリュームComplianceClock時間がファイルの `ctime`フィールドに書き込まれます。ComplianceClock時間によって、ファイルの保存期間に達したかどうかが判断されます。

.手順
. 適切なコマンドまたはプログラムを使用して、ファイルの読み書き属性を読み取り専用に変更します。
+
UNIXシェルでは、次のコマンドを使用して、 `document.txt`という名前のファイルを読み取り専用にします：

+
[listing]
----
chmod -w document.txt
----
+
Windowsシェルで次のコマンドを使用して、 `document.txt`という名前のファイルを読み取り専用にします：

+
[listing]
----
attrib +r document.txt
----




== ファイルのWORM状態への自動コミット

SnapLock自動コミット機能を使用すると、ファイルを自動的にWORM状態にコミットできます。自動コミット機能は、ファイルが自動コミット期間内に変更されなかった場合、SnapLockボリューム上のファイルをWORM状態にコミットします。自動コミット機能はデフォルトで無効になっています。

.開始する前に
* 自動コミットするファイルがSnapLockボリュームに格納されている必要があります。
* SnapLockがオンラインである必要があります。
* SnapLockボリュームが読み書き可能ボリュームである必要があります。


[NOTE]
====
SnapLockの自動コミット機能は、ボリューム内のすべてのファイルをスキャンし、自動コミットの要件を満たすファイルをコミットします。ファイルが自動コミットできる状態になってから、SnapLockの自動コミット スキャナによって実際にコミットされるまでに、時間が空くことがあります。ただし、ファイルは自動コミットの対象になった時点からファイルシステムによる削除や変更から保護されます。

====
.タスク概要
_自動コミット期間_は、ファイルが自動コミットされるまでに変更されない期間を指定します。自動コミット期間が経過する前にファイルを変更すると、そのファイルの自動コミット期間が再開されます。

自動コミット期間に指定できる値は次のとおりです。

|===
| Value | 単位 | 注記 


 a| 
なし
 a| 
-
 a| 
デフォルト



 a| 
5 - 5256000
 a| 
minutes
 a| 
-



 a| 
1 - 87600
 a| 
hours
 a| 
-



 a| 
1 - 3650
 a| 
days
 a| 
-



 a| 
1 - 120
 a| 
months
 a| 
-



 a| 
1 - 10
 a| 
years
 a| 
-

|===
[NOTE]
====
最小値は5分、最大値は10年です。

====
.手順
. SnapLockボリュームのファイルをWORM状態に自動コミットします。
+
`*volume snaplock modify -vserver _SVM_name_ -volume _volume_name_ -autocommit-period _autocommit_period_*`

+
 `volume snaplock modify`の詳細については、link:https://docs.netapp.com/us-en/ontap-cli/volume-snaplock-modify.html["ONTAPコマンド リファレンス"^]を参照してください。

+
次のコマンドは、ファイルが5時間変更されない限り、SVM vs1のボリューム `vol1`上のファイルを自動コミットします：

+
[listing]
----
cluster1::>volume snaplock modify -vserver vs1 -volume vol1 -autocommit-period 5hours
----




== 追記可能WORMファイルの作成

追記可能なWORMファイルは、ログエントリのように増分的に書き込まれるデータを保持します。適切なコマンドやプログラムを使用してWORM追記可能ファイルを作成するか、SnapLock _ボリューム追記モード_機能を使用してデフォルトでWORM追記可能ファイルを作成することもできます。



== コマンドまたはプログラムを使用した追記可能WORMファイルの作成

追記可能WORMファイルは、NFSまたはCIFSで適切なコマンドやプログラムを使用して作成できます。追記可能WORMファイルには、ログ エントリのように段階的に書き込まれるデータが格納されます。データは256KBのチャンク単位でファイルに追加されます。チャンクが書き込まれるたびに、前のチャンクがWORM方式で保護されます。このファイルは保持期間が経過するまで削除できません。

.開始する前に
追記可能WORMファイルはSnapLockボリュームに格納する必要があります。

.タスク概要
アクティブな256 KBチャンクにデータを順番に書き込む必要はありません。ファイルのn×256KB+1バイト目にデータが書き込まれると、前の256 KBセグメントはWORM保護されます。

現在アクティブな256KBのチャンクを超える順不同の書き込みが発生すると、アクティブな256KBのチャンクが最新のオフセットにリセットされ、古いオフセットへの書き込みが失敗して「Read Only File System (ROFS)」エラーが表示されます。書き込みオフセットは、クライアント アプリケーションによって異なります。クライアントが追記可能WORMファイルの書き込みセマンティクスに準拠していないと、書き込み内容が誤って終了する可能性があります。そのため、クライアントを順不同の書き込みのオフセット制限に準拠させるか、ファイルシステムを同期モードでマウントして同期書き込みが行われるようにすることを推奨します。

.手順
. 適切なコマンドまたはプログラムを使用して、必要な保持期限を指定した空のファイルを作成します。
+
UNIXシェルで、次のコマンドを使用して、 `document.txt`という名前の長さがゼロのファイルの保持時間を2020年11月21日午前6：00に設定します：

+
[listing]
----
touch -a -t 202011210600 document.txt
----
. 適切なコマンドまたはプログラムを使用して、ファイルの読み書き属性を読み取り専用に変更します。
+
UNIXシェルでは、次のコマンドを使用して、 `document.txt`という名前のファイルを読み取り専用にします：

+
[listing]
----
chmod 444 document.txt
----
. 適切なコマンドまたはプログラムを使用して、ファイルの読み書き属性を書き込み可能に戻します。
+
[NOTE]
====
ファイル内にデータがないため、この手順はコンプライアンス リスクとはみなされません。

====
+
UNIXシェルでは、次のコマンドを使用して、 `document.txt`という名前のファイルを書き込み可能にします：

+
[listing]
----
chmod 777 document.txt
----
. 適切なコマンドまたはプログラムを使用して、ファイルへのデータの書き込みを開始します。
+
UNIX シェルでは、次のコマンドを使用して `document.txt`にデータを書き込みます：

+
[listing]
----
echo test data >> document.txt
----
+
[NOTE]
====
ファイルにデータを追加する必要がなくなったら、ファイル権限を読み取り専用に戻してください。

====




== ボリューム アペンド モードを使用した追記可能WORMファイルの作成

ONTAP 9.3以降では、SnapLock_ボリューム追加モード_（VAM）機能を使用して、デフォルトでWORM形式の追記可能ファイルを作成できます。WORM形式の追記可能ファイルは、ログエントリのように増分的に書き込まれるデータを保持します。データは256KBのチャンク単位でファイルに追加されます。各チャンクが書き込まれるたびに、前のチャンクはWORM保護されます。保持期間が経過するまで、ファイルを削除することはできません。

.開始する前に
* 追記可能WORMファイルはSnapLockボリュームに格納する必要があります。
* SnapLockボリュームはアンマウントされ、Snapshotとユーザが作成したファイルが含まれていない状態である必要があります。


.タスク概要
アクティブな256 KBチャンクにデータを順番に書き込む必要はありません。ファイルのn×256KB+1バイト目にデータが書き込まれると、前の256 KBセグメントはWORM保護されます。

ボリュームに自動コミット期間を指定している場合、追記可能WORMファイルに変更がなかった期間が自動コミット期間を超えると、そのファイルはWORM状態にコミットされます。

[NOTE]
====
VAMはSnapLock監査ログ ボリュームではサポートされません。

====
.手順
. VAMを有効にします。
+
`*volume snaplock modify -vserver _SVM_name_ -volume _volume_name_ -is-volume-append-mode-enabled true|false*`

+
 `volume snaplock modify`の詳細については、link:https://docs.netapp.com/us-en/ontap-cli/volume-snaplock-modify.html["ONTAPコマンド リファレンス"^]を参照してください。

+
次のコマンドは、SVM``vs1``のボリューム `vol1`上でVAMを有効にします：

+
[listing]
----
cluster1::>volume snaplock modify -vserver vs1 -volume vol1 -is-volume-append-mode-enabled true
----
. 適切なコマンドまたはプログラムを使用して、書き込み権限を指定してファイルを作成します。
+
ファイルはデフォルトで追記可能WORMファイルになります。


