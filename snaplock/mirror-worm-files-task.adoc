---
permalink: snaplock/mirror-worm-files-task.html 
sidebar: sidebar 
keywords: mirror, worm, file, snapmirror, replicate, volume, compliance, enterprise, snaplock 
summary: SnapMirrorを使用すると、ディザスタ リカバリなどの目的で、地理的に離れた別の場所にWORMファイルをレプリケートできます。ソース ボリュームとデスティネーション ボリュームの両方でSnapLockが設定されていて、両方のボリュームのSnapLockモード（ComplianceまたはEnterprise）が同じである必要があります。ボリュームとファイルの主要なSnapLockプロパティがすべてレプリケートされます。 
---
= 災害復旧のためにONTAP SnapMirrorでWORMファイルをミラーリングする
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
SnapMirrorを使用すると、ディザスタ リカバリなどの目的で、地理的に離れた別の場所にWORMファイルをレプリケートできます。ソース ボリュームとデスティネーション ボリュームの両方でSnapLockが設定されていて、両方のボリュームのSnapLockモード（ComplianceまたはEnterprise）が同じである必要があります。ボリュームとファイルの主要なSnapLockプロパティがすべてレプリケートされます。

.前提条件
ソースボリュームとデスティネーションボリュームは、ピアSVMを含むピアクラスタ内に作成する必要があります。詳細については、 https://docs.netapp.com/us-en/ontap-system-manager-classic/peering/index.html["クラスタとSVMのピアリング"^]を参照してください。

.タスク概要
* ONTAP 9.5以降では、DP（データ保護）タイプの関係ではなく、XDP（拡張データ保護）タイプのSnapMirror関係を使用してWORMファイルをレプリケートできます。XDPモードはONTAPバージョンに依存せず、同じブロックに格納されているファイルを区別できるため、レプリケートされたComplianceモードのボリュームの再同期が大幅に容易になります。既存のDPタイプの関係をXDPタイプの関係に変換する方法については、link:../data-protection/index.html["データ保護"]を参照してください。
* DPタイプのSnapMirror関係の再同期処理は、SnapLockがデータ損失につながると判断した場合、コンプライアンスモードボリュームで失敗します。再同期処理が失敗した場合は、 `volume clone create`コマンドを使用してデスティネーションボリュームのクローンを作成できます。その後、ソースボリュームをクローンと再同期できます。
* SnapLock ボリュームの SnapMirror 関係は、async-mirror タイプの `MirrorAllSnapshots` ポリシーのみをサポートします。SnapLock ボリュームの保持期間は、そのボリューム内にあるすべての WORM ファイルの中で最大の保持期間によって決まります。デスティネーションはソースの DR コピーであるため、デスティネーションの SnapLock ボリュームの保持期間はソースと同じになります。
* SnapLock Complianceボリューム間のXDPタイプのSnapMirror関係では、関係解除後にデスティネーションのデータがソースから変化している場合も再同期がサポートされます。
+
再同期時に共通のSnapshotに基づいてソースとデスティネーションの間でデータの相違が検出されると、この相違をキャプチャするためにデスティネーションで新しいSnapshotが作成されます。新しいSnapshotと共通のSnapshotの両方が次の期間ロックされます。

+
** デスティネーションのボリューム有効期限
** ボリューム有効期限が過ぎているか設定されていない場合、Snapshotは30日間ロックされます。
** デスティネーションに法的保留がある場合、実際のボリューム有効期限はマスクされ、「`indefinite`」と表示されます。ただし、実際のボリューム有効期限の間、Snapshotはロックされます。




デスティネーション ボリュームの有効期限がソースよりもあとの場合、デスティネーションの有効期限が維持され、再同期後にソース ボリュームの有効期限で上書きされることはありません。

デスティネーションにソースと異なるリーガル ホールドが設定されている場合は、再同期を実行できません。再同期を試行する前に、ソースとデスティネーションに同じリーガル ホールドを設定するか、またはデスティネーションのリーガル ホールドをすべて解除する必要があります。

相違データをキャプチャするために作成された、デスティネーション ボリューム上のロックされたSnapshotは、 `snapmirror update -s snapshot`コマンドを実行することでCLIを使用してソースにコピーできます。コピーされたSnapshotは、ソースでも引き続きロックされたままになります。

* SVMデータ保護関係はサポートされません。
* 負荷共有データ保護関係はサポートされません。


次の図は、SnapMirror関係を初期化する手順を示しています。

image:snapmirror_steps_clustered.png["この図はSnapMirror関係を初期化する手順を示しています。デスティネーション クラスタを特定し、デスティネーション ボリュームを作成し、ボリューム間のSnapMirror関係を作成してから、関係を初期化してベースライン転送を開始します。"]

[role="tabbed-block"]
====
.System Manager
--
ONTAP 9.12.1以降では、System Managerを使用して、WORMファイルのSnapMirrorレプリケーションを設定できます。

.手順
. *Storage > Volumes*に移動します。
. *表示 / 非表示*をクリックし、*SnapLockタイプ*を選択すると、*ボリューム*ウィンドウに列が表示されます。
. SnapLockボリュームを探します。
. image:icon_kabob.gif["メニューオプションアイコン"]をクリックして*保護*を選択します。
. デスティネーション クラスタとデスティネーションStorage VMを選択します。
. *その他のオプション*をクリックします。
. *Show legacy policies* を選択し、*DPDefault (legacy)* を選択します。
. *Destination Configuration details*セクションで、*Override transfer schedule*を選択し、*hourly*を選択します。
. *保存*をクリックします。
. ソース ボリューム名の左側にある矢印をクリックしてボリュームの詳細を展開し、ページの右側でリモートSnapMirror保護の詳細を確認します。
. リモート クラスタで、* Protection Relationships * に移動します。
. 関係を探し、デスティネーション ボリューム名をクリックして関係の詳細を確認します。
. デスティネーション ボリュームのSnapLockタイプおよびその他のSnapLock情報を確認します。


--
.CLI
--
. デスティネーション クラスタを特定します。
. デスティネーション クラスタで、link:../system-admin/install-license-task.html["SnapLockライセンスをインストールする"]、link:../snaplock/initialize-complianceclock-task.html["Compliance Clockを初期化する"]、および ONTAP 9.10.1 より前のリリースを使用している場合は、link:../snaplock/create-snaplock-aggregate-task.html["SnapLockアグリゲートを作成する"]。
. デスティネーション クラスタで、SnapLockデスティネーション ボリュームのタイプを `DP`ソース ボリュームと同じサイズまたはそれより大きいサイズで作成します：
+
`*volume create -vserver _SVM_name_ -volume _volume_name_ -aggregate _aggregate_name_ -snaplock-type compliance|enterprise -type DP -size _size_*`

+

NOTE: ONTAP 9.10.1以降では、SnapLockボリュームと非SnapLockボリュームを同じアグリゲートに配置できるため、ONTAP 9.10.1を使用している場合はSnapLockアグリゲートを別々に作成する必要はありません。ボリュームの-snaplock-typeオプションを使用して、SnapLockボリューム タイプ（ComplianceまたはEnterprise）を指定します。ONTAP 9.10.1より前のリリースでは、SnapLockモード（ComplianceまたはEnterprise）はアグリゲートから継承されます。デスティネーション ボリュームの言語設定とソース ボリュームの言語設定が一致している必要があります。

+
次のコマンドは、アグリゲート `node01_aggr`に `dstvolB`という名前の2 GBのSnapLock `Compliance`ボリュームを `SVM2`に作成します：

+
[listing]
----
cluster2::> volume create -vserver SVM2 -volume dstvolB -aggregate node01_aggr -snaplock-type compliance -type DP -size 2GB
----
. デスティネーションSVMで、SnapMirrorポリシーを作成します。
+
`snapmirror policy create -vserver _SVM_name_ -policy _policy_name_`

+
次のコマンドは、SVM 全体のポリシー `SVM1-mirror`を作成します：

+
[listing]
----
SVM2::> snapmirror policy create -vserver SVM2 -policy SVM1-mirror
----
. デスティネーションSVMで、SnapMirrorスケジュールを作成します。
+
`*job schedule cron create -name _schedule_name_ -dayofweek _day_of_week_ -hour _hour_ -minute _minute_*`

+
次のコマンドは、 `weekendcron`という名前のSnapMirrorスケジュールを作成します：

+
[listing]
----
SVM2::> job schedule cron create -name weekendcron -dayofweek "Saturday, Sunday" -hour 3 -minute 0
----
. デスティネーションSVMで、SnapMirror関係を作成します。
+
`snapmirror create -source-path _source_path_ -destination-path _destination_path_ -type XDP|DP -policy _policy_name_ -schedule _schedule_name_`

+
次のコマンドは、 `SVM1`のソース ボリューム `srcvolA`と `SVM2`のデスティネーション ボリューム `dstvolB`の間にSnapMirror関係を作成し、ポリシー `SVM1-mirror`とスケジュール `weekendcron`を割り当てます：

+
[listing]
----
SVM2::> snapmirror create -source-path SVM1:srcvolA -destination-path SVM2:dstvolB -type XDP -policy SVM1-mirror -schedule weekendcron
----
+

NOTE: XDPタイプはONTAP 9.5以降で使用できます。ONTAP 9.4以前ではDPタイプを使用する必要があります。

. デスティネーションSVMで、SnapMirror関係を初期化します。
+
`snapmirror initialize -destination-path _destination_path_`

+
初期化プロセスでは、デスティネーション ボリュームへの_ベースライン転送_が実行されます。SnapMirrorは、ソース ボリュームのSnapshotコピーを作成し、そのコピーとそれが参照するすべてのデータ ブロックをデスティネーション ボリュームに転送します。また、ソース ボリューム上の他のSnapshotコピーもデスティネーション ボリュームに転送されます。

+
次のコマンドは、 `SVM1`のソース ボリューム `srcvolA`と `SVM2`のデスティネーション ボリューム `dstvolB`間の関係を初期化します：

+
[listing]
----
SVM2::> snapmirror initialize -destination-path SVM2:dstvolB
----


--
====
.関連情報
* https://docs.netapp.com/us-en/ontap-system-manager-classic/peering/index.html["クラスタとSVMのピアリング"^]
* https://docs.netapp.com/us-en/ontap-system-manager-classic/volume-disaster-prep/index.html["ボリュームのディザスタ リカバリの準備"]
* link:../data-protection/index.html["データ保護"]
* link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-create.html["snapmirror create"^]
* link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-initialize.html["snapmirror initialize"^]
* link:https://docs.netapp.com/us-en/ontap-cli/snapmirror-policy-create.html["snapmirror policy create"^]

