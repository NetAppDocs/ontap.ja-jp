---
permalink: snaplock/snapshot-lock-concept.html 
sidebar: sidebar 
keywords: snaplock, snapshot copy, lock, tamperproof 
summary: ONTAP 9.12.1以降では、SnapLock以外のボリューム上のSnapshotコピーをロックして、ランサムウェア攻撃から保護できます。Snapshotコピーをロックすることで、誤って削除したり、悪意を持って削除したりすることがなくなります。 
---
= Snapshotコピーをロックしてランサムウェア攻撃から保護する
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
ONTAP 9.12.1以降では、SnapLock以外のボリューム上のSnapshotコピーをロックして、ランサムウェア攻撃から保護できます。Snapshotコピーをロックすることで、誤って削除したり、悪意を持って削除したりすることがなくなります。

SnapLock コンプライアンスクロック機能を使用すると、指定した期間Snapshotコピーをロックして、有効期限に達するまでSnapshotコピーを削除できないようにすることができます。Snapshotコピーをロックすると、改ざんを防止し、ランサムウェアの脅威から保護します。ロックされたSnapshotコピーを使用すると、ボリュームがランサムウェア攻撃によって危険にさらされた場合にデータをリカバリできます。

.改ざん防止機能を備えたSnapshotコピーの要件と考慮事項
* ONTAP CLIを使用している場合は、クラスタ内のすべてのノードでONTAP 9.12.1以降が実行されている必要があります。System Managerを使用している場合は、すべてのノードでONTAP 9.13.1以降が実行されている必要があります。
* クラスタにSnapLock ライセンスがインストールされている必要があります。
+
詳細については、を参照してください link:https://docs.netapp.com/us-en/ontap/snaplock/install-license-task.html["SnapLock ライセンスをインストールする"]。

* クラスタのコンプライアンスクロックを初期化する必要があります。
+
詳細については、を参照してください link:https://docs.netapp.com/us-en/ontap/snaplock/initialize-complianceclock-task.html["コンプライアンスクロックを初期化します"]。

* ボリュームでSnapshotロックが有効になっている場合、クラスタをONTAP 9.12.1以降のバージョンのONTAP にアップグレードできます。 ただし、ロックされたすべてのSnapshotコピーが有効期限に達して削除され、Snapshotコピーのロックが無効になるまで、以前のバージョンのONTAP にはリバートできません。
* Snapshotがロックされている場合、ボリューム有効期限はSnapshotコピーの有効期限に設定されます。複数のSnapshotコピーがロックされている場合、ボリューム有効期限はすべてのSnapshotコピーの最大有効期限を反映します。
* ロックされたSnapshotコピーの保持期間はSnapshotコピーの保持数よりも優先されます。つまり、ロックされたSnapshotコピーの保持期間が期限切れになっていない場合、保持数の制限は考慮されません。
* SnapMirror関係では、mirror-vaultポリシールールに保持期間を設定できます。デスティネーションボリュームでSnapshotコピーロックが有効になっている場合は、デスティネーションにレプリケートされるSnapshotコピーに保持期間が適用されます。保持期間は保持数よりも優先されます。たとえば、保持数を超えた場合でも、保持期限を過ぎていないSnapshotコピーは保持されます。
* SnapLock以外のボリューム上のSnapshotコピーの名前は変更できます。SnapMirror関係のプライマリボリュームでのSnapshotの名前変更処理は、ポリシーがMirrorAllSnapshotsの場合にのみセカンダリボリュームに反映されます。他のタイプのポリシーでは、名前を変更したSnapshotコピーは更新時に反映されません。
* ONTAP CLIを使用している場合は、を使用してロックされたSnapshotコピーをリストアできます `volume snapshot restore` ロックされたSnapshotコピーが最新のものである場合のみ、コマンドを実行できます。リストア対象のSnapshotコピーよりもあとに期限切れ前のSnapshotコピーがあると、Snapshotコピーのリストア処理は失敗します。


.タンパープルーフSnapshotコピーでサポートされる機能
* FlexGroup ボリューム
+
FlexGroup ボリュームでは、Snapshotコピーのロックがサポートされます。Snapshotロックは、ルートコンスティチュエントSnapshotコピーでのみ発生します。FlexGroup ボリュームを削除できるのは、ルートコンスティチュエントの有効期限を過ぎた場合のみです。

* FlexVol からFlexGroup への変換
+
ロックされたSnapshotコピーがあるFlexVol をFlexGroup ボリュームに変換できます。変換後もSnapshotコピーはロックされたままです。

* ボリュームクローンとファイルクローン
+
ロックされたSnapshotコピーからボリュームのクローンとファイルのクローンを作成できます。



.サポートされない機能です
現在、タンパープルーフSnapshotコピーでは、次の機能はサポートされていません。

* 整合グループ
* FabricPool
* FlexCache ボリューム
* SMTapeの場合
* SnapCenter
* SnapMirror のビジネス継続性（ SM-BC ）
* SnapMirror Synchronous
* SVM のデータ移動




== ボリュームの作成時にSnapshotコピーのロックを有効にします

ONTAP 9.12.1以降では、新しいボリュームを作成する場合、またはを使用して既存のボリュームを変更する場合に、Snapshotコピーロックを有効にできます `-snapshot-locking-enabled` オプションを指定します `volume create` および `volume modify` コマンドを使用します。ONTAP 9.13.1以降では、System Managerを使用してSnapshotコピーロックを有効にできます。

[role="tabbed-block"]
====
.System Manager の略
--
. [ストレージ]>[ボリューム]*に移動し、*[追加]*を選択します。
. [ボリュームの追加]*ウィンドウで、*[その他のオプション]*を選択します。
. ボリューム名、サイズ、エクスポートポリシー、および共有名を入力します。
. [Enable Snapshot locking]*を選択します。SnapLockライセンスがインストールされていない場合、この選択は表示されません。
. SnapLockコンプライアンスクロックがまだ有効になっていない場合は、*[Initialize Compliance Clock]*を選択します。
. 変更を保存します。
. [ボリューム]*ウィンドウで、更新したボリュームを選択し、*[概要]*を選択します。
. SnapLock Snapshotコピーのロック*が「有効」*と表示されていることを確認します。


--
.CLI の使用
--
. 新しいボリュームを作成し、Snapshotコピーロックを有効にするには、次のコマンドを入力します。
+
`volume create -vserver _vserver_name_ -volume _volume_name_ -snapshot-locking-enabled true`

+
次のコマンドは、vol1という名前の新しいボリュームでSnapshotコピーロックを有効にします。

+
[listing]
----
> volume create -volume vol1 -aggregate aggr1 -size 100m -snapshot-locking-enabled true
Warning: Snapshot copy locking is being enabled on volume “vol1” in Vserver “vs1”. It cannot be disabled until all locked Snapshot copies are past their expiry time. A volume with unexpired locked Snapshot copies cannot be deleted.
Do you want to continue: {yes|no}: y
[Job 32] Job succeeded: Successful
----


--
====


== 既存のボリュームでSnapshotコピーロックを有効にします

ONTAP 9.12.1以降では、ONTAP CLIを使用して、既存のボリュームでSnapshotコピーロックを有効にできます。ONTAP 9.13.1以降では、System Managerを使用して既存のボリュームに対してSnapshotコピーロックを有効にすることができます。

[role="tabbed-block"]
====
.System Manager の略
--
. [ストレージ]>[ボリューム]に移動します。
. 選択するオプション image:icon_kabob.gif["Alt = メニューオプション"] 編集>ボリューム*を選択します。
. [ボリュームの編集]*ウィンドウで、[Snapshotコピー（ローカル）設定]セクションを探し、*[Snapshotロックの有効化]*を選択します。
+
SnapLockライセンスがインストールされていない場合、この選択は表示されません。

. SnapLockコンプライアンスクロックがまだ有効になっていない場合は、*[Initialize Compliance Clock]*を選択します。
. 変更を保存します。
. [ボリューム]*ウィンドウで、更新したボリュームを選択し、*[概要]*を選択します。
. SnapLock Snapshotコピーのロック*が「有効」*と表示されていることを確認します。


--
.CLI の使用
--
. 既存のボリュームを変更してSnapshotコピーのロックを有効にするには、次のコマンドを入力します。
+
`volume modify -vserver _vserver_name_ -volume _volume_name_ -snapshot-locking-enabled true`



--
====


== ロックされたSnapshotコピーポリシーを作成し、保持を適用します

ONTAP 9.12.1以降では、Snapshotコピーポリシーを作成してSnapshotコピーの保持期間を適用し、そのポリシーをボリュームに適用して、指定した期間Snapshotコピーをロックできます。保持期間を手動で設定して、Snapshotコピーをロックすることもできます。ONTAP 9.13.1以降では、System Managerを使用してSnapshotコピーロックポリシーを作成し、ボリュームに適用できます。



=== Snapshotコピーのロックポリシーを作成します

[role="tabbed-block"]
====
.System Manager の略
--
. [ストレージ]>[Storage VM]*に移動し、Storage VMを選択します。
. [設定]*を選択します。
. [Snapshot Policies]*に移動し、を選択します image:icon_arrow.gif["alt =矢印"]。
. [ Snapshotポリシーの追加]*ウィンドウで、ポリシー名を入力します。
. 選択するオプション image:icon_add.gif["alt =追加"]。
. スケジュール名、保持するSnapshotコピーの最大数、SnapLock の保持期間など、Snapshotコピースケジュールの詳細を指定します。
. [Snapshot保持期間]列にSnapLock 、Snapshotコピーを保持する時間数、日数、月数、または年数を入力します。たとえば、保持期間が5日間のSnapshotコピーポリシーでは、Snapshotコピーが作成されてから5日間はロックされ、その間は削除できません。サポートされる保持期間は次のとおりです。
+
** 年：0～100
** 月：0～1200
** 日数：0～36500
** 営業時間：0～24


. 変更を保存します。


--
.CLI の使用
--
. Snapshotコピーポリシーを作成するには、次のコマンドを入力します。
+
`volume snapshot policy create -policy policy_name -enabled true -schedule1 _schedule1_name_ -count1 _maximum_Snapshot_copies -retention-period1 _retention_period_`

+
次のコマンドは、Snapshotコピーロックポリシーを作成します。

+
[listing]
----
cluster1> volume snapshot policy create -policy policy_name -enabled true -schedule1 hourly -count1 24 -retention-period1 "1 days"
----
+
アクティブな保持期間にあるSnapshotコピーは置き換えられません。つまり、期限切れになっていないロックされたSnapshotコピーがある場合、保持数は反映されません。



--
====


=== ボリュームにロックポリシーを適用します

[role="tabbed-block"]
====
.System Manager の略
--
. [ストレージ]>[ボリューム]に移動します。
. 選択するオプション image:icon_kabob.gif["Alt = メニューオプション"] 編集>ボリューム*を選択します。
. [ボリュームの編集]*ウィンドウで、*[Snapshotコピーのスケジュール設定]*を選択します。
. リストからSnapshotコピーロックポリシーを選択します。
. Snapshotコピーのロックがまだ有効になっていない場合は、*[Snapshotロックを有効にする]*を選択します。
. 変更を保存します。


--
.CLI の使用
--
. 既存のボリュームにSnapshotコピーロックポリシーを適用するには、次のコマンドを入力します。
+
`volume modify -volume volume_name -vserver vserver_name -snapshot-policy policy_name`



--
====


=== 手動でのSnapshotコピーの作成時に保持期間を適用

Snapshotコピーの保持期間は、Snapshotコピーを手動で作成するときに適用できます。ボリュームでSnapshotコピーロックが有効になっている必要があります。有効になっていない場合、保持期間の設定は無視されます。

[role="tabbed-block"]
====
.System Manager の略
--
. [ストレージ]>[ボリューム]*に移動し、ボリュームを選択します。
. ボリュームの詳細ページで、*[Snapshotコピー]*タブを選択します。
. 選択するオプション image:icon_add.gif["Alt =追加アイコン"]。
. Snapshotコピー名とSnapLockの有効期限を入力します。カレンダーを選択して、保持期限の日付と時刻を選択できます。
. 変更を保存します。
. [ボリューム]>[Snapshotコピー]ページで、*[表示/非表示]*を選択し、*[ SnapLock 有効期限]*を選択して*[ SnapLock 有効期限]*列を表示し、保持期限が設定されていることを確認します。


--
.CLI の使用
--
. Snapshotコピーを手動で作成し、ロック保持期間を適用するには、次のコマンドを入力します。
+
`volume snapshot create -volume _volume_name_ -snapshot _snapshot_copy_name_ -snaplock-expiry-time _expiration_date_time_`

+
次のコマンドでは、新しいSnapshotコピーを作成して保持期間を設定します。

+
[listing]
----
cluster1> volume snapshot create -vserver vs1 -volume vol1 -snapshot snap1 -snaplock-expiry-time "11/10/2022 09:00:00"
----


--
====


=== 既存のSnapshotコピーに保持期間を適用します

[role="tabbed-block"]
====
.System Manager の略
--
. [ストレージ]>[ボリューム]*に移動し、ボリュームを選択します。
. ボリュームの詳細ページで、*[Snapshotコピー]*タブを選択します。
. Snapshotコピーを選択し、を選択します image:icon_kabob.gif["Alt = メニューオプション"]をクリックし、*[Modify SnapLock Expiration Time]*を選択します。カレンダーを選択して、保持期限の日付と時刻を選択できます。
. 変更を保存します。
. [ボリューム]>[Snapshotコピー]ページで、*[表示/非表示]*を選択し、*[ SnapLock 有効期限]*を選択して*[ SnapLock 有効期限]*列を表示し、保持期限が設定されていることを確認します。


--
.CLI の使用
--
. 既存のSnapshotコピーに保持期間を手動で適用するには、次のコマンドを入力します。
+
`volume snapshot modify-snaplock-expiry-time -volume _volume_name_ -snapshot _snapshot_copy_name_ -expiry-time _expiration_date_time_`

+
次の例は、既存のSnapshotコピーに保持期間を適用します。

+
[listing]
----
cluster1> volume snapshot modify-snaplock-expiry-time -volume vol1 -snapshot snap2 -expiry-time "11/10/2022 09:00:00"
----


--
====