---
sidebar: sidebar 
permalink: upgrade/automated-upgrade-task.html 
keywords: netapp, ontap, automate, automatic, automated, digital advisor, upgrade, nondisruptive, nondisruptively, non-disruptive update, nondisruptive upgrade, upgrade a cluster, shift workload between clusters, hardware platform, configuration, software image, update, update ONTAP, update software, ndu 
summary: クラスタのONTAPのバージョンを無停止で更新できます。 
---
= 自動化された無停止の ONTAP アップグレードを使用して ONTAP イメージをインストールする
:hardbreaks:
:toclevels: 1
:allow-uri-read: 
:toclevels: 1
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
自動アップグレードを実行すると、ONTAP は各ノードにターゲットの ONTAP イメージを自動的にインストールし、クラスタが正常にアップグレードできることを検証してから、クラスタ内のノード数に基づいてバックグラウンドでxref:concept_upgrade_methods.html[バッチ アップグレードまたはローリング アップグレード]のいずれかを実行します。

使用している構成でサポートされている場合は、System Managerを使用して自動アップグレードを実行するようにしてください。System Managerを使用した自動アップグレードがサポートされていない構成の場合は、ONTAPのコマンドライン インターフェイス（CLI）を使用して自動アップグレードを実行できます。


NOTE: NetAppを介して ONTAP 9.15.1 以降にアップグレードする場合は、link:https://docs.netapp.com/us-en/console-software-updates/get-started/software-updates.html["NetApp Console ドキュメントのアップグレード手順"^]に従ってください。


IMPORTANT: 自動無停止アップグレード（ANDU）の開始前に `storage failover modify-auto-giveback`コマンドオプションの設定を変更しても、アップグレードプロセスには影響しません。ANDUプロセスでは、アップデートに必要なテイクオーバー/ギブバック処理中、このオプションに設定されている値は無視されます。たとえば、ANDU開始前に `-autogiveback`をfalseに設定しても、ギブバック処理前の自動アップグレードは中断されません。link:https://docs.netapp.com/us-en/ontap-cli/search.html?q=storage+failover+modify-auto-giveback["ONTAPコマンド リファレンス"^]の `storage failover modify-auto-giveback`の詳細をご覧ください。

.開始する前に
* link:prepare.html["アップグレードの準備"]する必要があります。
* ターゲットの ONTAP リリースに合わせてlink:download-software-image.html["ONTAPソフトウェアイメージをダウンロードする"]してください。
+
link:../upgrade/concept_upgrade_paths.html#types-of-upgrade-paths["直接マルチホップアップグレード"]を実行する場合は、特定のlink:../upgrade/concept_upgrade_paths.html#supported-upgrade-paths["アップグレード パス"]に必要な両方のONTAPイメージをダウンロードする必要があります。

* HAペアごとに、1つ以上のポートが各ノードの同じブロードキャスト ドメインに必要です。
+
ONTAPクラスタのノード数が8つ以上の場合は、自動無停止アップグレードでバッチ アップグレード方式が使用され、SFOのテイクオーバー前にデータLIFの移行が強制的に実行されます。バッチ アップグレード時にLIFを移行する方法は、ONTAPのバージョンによって異なります。

+
[cols="2"]
|===
| 実行しているONTAPのバージョン | LIFの移行先 


 a| 
** 9.15.1以降
** 9.14.1P5
** 9.13.1P10
** 9.12.1P13
** 9.11.1P16、P17
** 9.10.1P19

| 他のバッチ グループ内のノード。他のバッチ グループへの移行に失敗した場合、LIFは同じバッチ グループ内のノードのHAパートナーに移行されます。 


| 9.8～9.14.1 | 他のバッチ グループ内のノード。ネットワーク ブロードキャスト ドメインで他のバッチ グループへのLIFの移行が許可されていない場合は、LIFの移行に失敗し、ANDUが一時停止します。 


| 9.7以前 | アップグレードするノードのHAパートナー。同じブロードキャスト ドメインにパートナーのポートがない場合は、LIFの移行に失敗し、ANDUが一時停止します。 
|===
* MetroCluster FC構成でONTAPをアップグレードする場合は、クラスタで自動計画外スイッチオーバーを有効にしておく必要があります。
* アップグレード プロセスの進行状況を監視する予定がない場合は、link:../error-messages/configure-ems-notifications-sm-task.html["手動介入が必要となる可能性のあるエラーのEMS通知を要求する"]必要があります。
* シングルノード クラスタの場合は、次のlink:../system-admin/single-node-clusters.html["自動中断アップグレード"]プロセスに従います。
+
シングルノード クラスタのアップグレードはシステムの停止を伴います。



.手順
[role="tabbed-block"]
====
.System Manager
--
. ONTAPターゲット イメージを検証します。
+

NOTE: MetroCluster構成をアップグレードする場合は、クラスタAを検証してから、クラスタBで検証プロセスを繰り返す必要があります。

+
.. 実行しているONTAPのバージョンに応じて、次のいずれかの手順を実行します。
+
|===


| 実行中の場合... | 操作 


| ONTAP 9.8 以降  a| 
*[クラスタ] > [概要]*をクリックします。



| ONTAP 9.5、9.6、および9.7  a| 
*Configuration* > *Cluster* > *Update*をクリックします。



| ONTAP 9.4以前  a| 
*Configuration* > *Cluster Update*をクリックします。

|===
.. *概要* ペインの右隅にあるimage:icon_kabob.gif["メニューオプションアイコン"]をクリックします。
.. *[ONTAPの更新]*をクリックします。
.. *Cluster Update*タブで、新しいイメージを追加するか、使用可能なイメージを選択します。
+
|===


| 状況 | 操作 


 a| 
ローカル フォルダから新しいソフトウェア イメージを追加する

すでにローカル クライアントにlink:download-software-image.html["画像をダウンロードした"]しているはずです。
 a| 
... *Available Software Images* の下で、*Add from Local* をクリックします。
... ソフトウェア イメージを保存した場所を参照し、イメージを選択して、*開く*をクリックします。




 a| 
HTTPサーバかFTPサーバから、新しいソフトウェア イメージを追加する
 a| 
... *サーバーから追加* をクリックします。
... *新しいソフトウェア イメージの追加* ダイアログ ボックスで、NetApp Support Site から ONTAP ソフトウェア イメージをダウンロードした HTTP サーバまたは FTP サーバの URL を入力します。
+
匿名 FTP の場合は、 ftp://anonymous@ftpserver[] 形式で URL を指定する必要があります。

... *[追加]*をクリックします。




 a| 
使用可能なイメージを選択する
 a| 
表示されたイメージから1つ選択します。

|===
.. *Validate* をクリックして、アップグレード前の検証チェックを実行します。
+
検証中にエラーや警告が検出された場合は、修正措置のリストとともに表示されます。アップグレードに進む前に、すべてのエラーを解決する必要があります。警告も解決しておくことが推奨されます。



. *Next* をクリックします。
. *Update* をクリックします。
+
検証が再度実行されます。残っているエラーや警告は、修正アクションのリストとともに表示されます。アップグレードを続行するには、エラーを修正する必要があります。検証が警告付きで完了した場合は、警告を修正するか、*Update with warnings*を選択してください。

+

NOTE: デフォルトでは、ONTAPはlink:concept_upgrade_methods.html["バッチ アップグレード プロセス"]を使用して8ノード以上のクラスタをアップグレードします。ONTAP 9.10.1以降では、必要に応じて*一度に1つのHAペアを更新*を選択してデフォルトをオーバーライドし、ローリング アップグレード プロセスを使用してクラスタで一度に1つのHAペアをアップグレードできます。

+
ノードが2つ以上のMetroCluster構成では、両方のサイトのHAペアで同時にONTAPのアップグレード プロセスが開始されます。2ノードのMetroCluster構成では、アップグレードを開始した方ではないサイトから最初にアップグレードが開始されます。最初のアップグレードが完了すると、残りのサイトでアップグレードが開始されます。

. エラーのためにアップグレードが一時停止した場合は、エラー メッセージをクリックして詳細を表示し、エラーを修正してlink:resume-upgrade-after-andu-error.html["アップグレードを再開する"]。


.終了後の操作
アップグレードが完了すると、ノードがリブートし、System Managerのログイン ページが表示されます。ノードのリブートに時間がかかる場合は、ブラウザをリフレッシュしてみてください。

--
.CLI
--
. ONTAPターゲット ソフトウェア イメージを検証します。
+

NOTE: MetroCluster構成をアップグレードする場合は、次の手順を最初にクラスタAで実行してから、同じ手順をクラスタBで実行する必要があります。

+
.. 以前のONTAPソフトウェア パッケージを削除します。
+
[source, cli]
----
cluster image package delete -version <previous_ONTAP_Version>
----
.. ターゲットのONTAPソフトウェア イメージを、クラスタ パッケージ リポジトリにロードします。
+
[source, cli]
----
cluster image package get -url location
----
+
[listing]
----
cluster1::> cluster image package get -url http://www.example.com/software/9.13.1/image.tgz

Package download completed.
Package processing completed.
----
+
link:../upgrade/concept_upgrade_paths.html#types-of-upgrade-paths["直接マルチホップアップグレード"]を実行する場合は、アップグレードに必要なONTAPの中間バージョンのソフトウェアパッケージもロードする必要があります。たとえば、9.8から9.13.1にアップグレードする場合は、ONTAP 9.12.1のソフトウェアパッケージをロードし、その後、同じコマンドを使用して9.13.1のソフトウェアパッケージをロードする必要があります。

.. ソフトウェア パッケージがクラスタ パッケージ リポジトリにあることを確認します。
+
[source, cli]
----
cluster image package show-repository
----
+
[listing]
----
cluster1::> cluster image package show-repository
Package Version  Package Build Time
---------------- ------------------
9.13.1              MM/DD/YYYY 10:32:15
----
.. 自動アップグレード前チェックを実行します。
+
[source, cli]
----
cluster image validate -version <package_version_number>
----
+
link:../upgrade/concept_upgrade_paths.html#types-of-upgrade-paths["直接マルチホップアップグレード"]を実行する場合、検証には対象のONTAPパッケージのみを使用する必要があります。中間アップグレードイメージを個別に検証する必要はありません。たとえば、9.8から9.13.1にアップグレードする場合は、検証に9.13.1パッケージを使用します。9.12.1パッケージを個別に検証する必要はありません。

+
[listing]
----
cluster1::> cluster image validate -version 9.13.1

WARNING: There are additional manual upgrade validation checks that must be performed after these automated validation checks have completed...
----
.. 検証の進捗を監視します。
+
[source, cli]
----
cluster image show-update-progress
----
.. 検証で特定された必要なアクションをすべて完了します。
.. MetroCluster構成をアップグレードする場合は、クラスタBで上記の手順を繰り返します。


. ソフトウェア アップグレードの見積もりを生成します。
+
[source, cli]
----
cluster image update -version <package_version_number> -estimate-only
----
+

NOTE: MetroCluster構成をアップグレードする場合は、このコマンドをクラスタ A またはクラスタ B のいずれかで実行できます。両方のクラスタで実行する必要はありません。

+
ソフトウェア アップグレードの見積もりには、更新対象の各コンポーネントの詳細とアップグレードの推定期間が表示されます。

. ソフトウェアのアップグレードを実行します。
+
[source, cli]
----
cluster image update -version <package_version_number>
----
+
** link:../upgrade/concept_upgrade_paths.html#types-of-upgrade-paths["直接マルチホップアップグレード"]を実行する場合は、package_version_numberに対象のONTAPバージョンを指定します。たとえば、ONTAP 9.8から9.13.1にアップグレードする場合は、package_version_numberに9.13.1を指定します。
** デフォルトでは、ONTAP はlink:concept_upgrade_methods.html["バッチ アップグレード プロセス"]を使用して 8 ノード以上のクラスタをアップグレードします。必要に応じて、 `-force-rolling`パラメータを使用してデフォルトのプロセスをオーバーライドし、ローリング アップグレード プロセスを使用してクラスタを 1 ノードずつアップグレードすることもできます。
** 各テイクオーバーとギブバックの完了後、アップグレードは8分間待機し、クライアントアプリケーションがテイクオーバーとギブバック中に発生するI/Oの一時停止から回復できるようにします。環境によってクライアントの安定化に必要な時間が長くなるか短くなる場合は、 `-stabilize-minutes` パラメータを使用して異なる安定化時間を指定できます。
** ノードが4つ以上のMetroCluster構成では、両方のサイトのHAペアで同時にONTAPの自動アップグレードが開始されます。2ノードのMetroCluster構成では、アップグレードを開始した方ではないサイトでアップグレードが開始されます。最初のアップグレードが完了すると、残りのサイトでアップグレードが開始されます。


+
[listing]
----
cluster1::> cluster image update -version 9.13.1

Starting validation for this update. Please wait..

It can take several minutes to complete validation...

WARNING: There are additional manual upgrade validation checks...

Pre-update Check      Status     Error-Action
--------------------- ---------- --------------------------------------------
...
20 entries were displayed

Would you like to proceed with update ? {y|n}: y
Starting update...

cluster-1::>
----
. クラスタの更新の進捗を表示します。
+
[source, cli]
----
cluster image show-update-progress
----
+
4ノードまたは8ノードMetroCluster構成をアップグレードする場合、 `cluster image show-update-progress`コマンドはコマンドを実行したノードの進行状況のみを表示します。個々のノードの進行状況を確認するには、各ノードでコマンドを実行する必要があります。

. 各ノードでアップグレードが正常に完了したことを確認します。
+
[source, cli]
----
cluster image show-update-progress
----
+
[listing]
----
cluster1::> cluster image show-update-progress

                                             Estimated         Elapsed
Update Phase         Status                   Duration        Duration
-------------------- ----------------- --------------- ---------------
Pre-update checks    completed                00:10:00        00:02:07
Data ONTAP updates   completed                01:31:00        01:39:00
Post-update checks   completed                00:10:00        00:02:00
3 entries were displayed.

Updated nodes: node0, node1.
----
. AutoSupport通知を送信します。
+
[source, cli]
----
autosupport invoke -node * -type all -message "Finishing_NDU"
----
+
AutoSupportメッセージを送信するようにクラスタが設定されていない場合は、通知のコピーがローカルに保存されます。

. 2ノードのMetroCluster FC構成をアップグレードする場合は、クラスタで自動計画外スイッチオーバーが有効になっていることを確認します。
+

NOTE: 標準構成、MetroCluster IP構成、またはノードが2つ以上のMetroCluster FC構成の場合は、この手順を実行する必要はありません。

+
.. 自動計画外スイッチオーバーが有効かどうかを確認します。
+
[source, cli]
----
metrocluster show
----
+
自動計画外スイッチオーバーが有効な場合、コマンド出力に次のステートメントが表示されます。

+
....
AUSO Failure Domain    auso-on-cluster-disaster
....
.. このステートメントが表示されない場合は、自動計画外スイッチオーバーを有効にします。
+
[source, cli]
----
metrocluster modify -auto-switchover-failure-domain auso-on-cluster-disaster
----
.. 自動計画外スイッチオーバーが有効になっていることを確認します。
+
[source, cli]
----
metrocluster show
----




--
====


== 自動アップグレード プロセスでのエラー後のONTAPソフトウェア アップグレード再開

エラーが原因でONTAPソフトウェアの自動アップグレードが一時停止した場合は、エラーを解決してからアップグレードを続行する必要があります。エラーを解決したら、自動アップグレード プロセスを続行するか、手動でアップグレード プロセスを完了するかを選択できます。自動アップグレードを続行する場合は、アップグレード手順を手動では一切実行しないでください。

.手順
[role="tabbed-block"]
====
.System Manager
--
. 実行しているONTAPのバージョンに応じて、次のいずれかの手順を実行します。
+
|===


| 実行中の場合... | 操作 


 a| 
ONTAP 9.8 以降
 a| 
*Cluster* > *Overview*をクリックします



 a| 
ONTAP 9.7、9.6、または9.5
 a| 
*Configuration* > *Cluster* > *Update*をクリックします。



 a| 
ONTAP 9.4以前
 a| 
** *Configuration* > *Cluster Update*をクリックします。
** *概要*ペインの右隅にある3つの青い縦のドットをクリックし、*ONTAP Update*を選択します。


|===
. 自動アップグレードを続行するか、キャンセルして手動で続行します。
+
|===


| 状況 | 操作 


 a| 
自動アップグレードを再開する
 a| 
*Resume*をクリックします。



 a| 
自動アップグレードをキャンセルして手動で続行する
 a| 
*Cancel*をクリックします。

|===


--
.CLI
--
. アップグレード エラーを表示します。
+
[source, cli]
----
cluster image show-update-progress
----
. エラーを解決します。
. アップグレードを再開します。
+
|===


| 状況 | 入力するコマンド 


 a| 
自動アップグレードを再開する
 a| 
[source, cli]
----
cluster image resume-update
----


 a| 
自動アップグレードをキャンセルして手動で続行する
 a| 
[source, cli]
----
cluster image cancel-update
----
|===


--
====
.終了後の操作
link:task_what_to_do_after_upgrade.html["アップグレード後のチェックを実行する"]。



== ビデオ：アップグレードが簡単に

ONTAP 9.8のSystem Managerに搭載されたシンプルなONTAPアップグレード機能をご覧ください。

video::xwwX8vrrmIk[youtube,width=848,height=480]
.関連情報
* https://aiq.netapp.com/["Active IQ Digital Advisorの起動"]
* https://docs.netapp.com/us-en/active-iq/["Active IQ Digital Advisorのドキュメント"]
* link:https://docs.netapp.com/us-en/ontap-cli/search.html?q=cluster+image["クラスタ イメージ"^]
* link:https://docs.netapp.com/us-en/ontap-cli/search.html?q=autosupport+invoke["autosupport invoke"^]
* link:https://docs.netapp.com/us-en/ontap-cli/search.html?q=metrocluster["MetroCluster"^]

