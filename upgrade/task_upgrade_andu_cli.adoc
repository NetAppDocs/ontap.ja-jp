---
sidebar: sidebar 
permalink: upgrade/task_upgrade_andu_cli.html 
keywords: netapp, ontap, automate, automatic, automated, upgrade, nondisruptive, nondisruptively, non-disruptive update, nondisruptive upgrade, upgrade a cluster, shift workload between clusters, hardware platform, configuration, software image, update, update ONTAP, update software, ndu 
summary: クラスタの ONTAP のバージョンは無停止で更新できます。 
---
= CLI を使用した自動無停止 ONTAP アップグレード
:hardbreaks:
:toclevels: 1
:allow-uri-read: 
:toclevels: 1
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
自動アップグレードの場合、ONTAPはターゲットONTAPイメージを各ノードに自動的にインストールし、クラスタの無停止アップグレードが可能なことを確認するためにクラスタコンポーネントを検証してから、 xref:concept_upgrade_methods.html[バッチアップグレードまたはローリングアップグレード] バックグラウンドで実行されます。

コマンドラインインターフェイス（ CLI ）を使用して、クラスタを無停止でアップグレードできることを確認し、各ノードにターゲット ONTAP イメージをインストールし、その後バックグラウンドでアップグレードを実行することができます。


NOTE: アップグレードプロセスの進捗状況を監視しない場合は、を推奨します link:task_requesting_notification_of_issues_encountered_in_nondisruptive_upgrades.html["手動操作が必要なエラーに関する EMS 通知を要求します"]。

.作業を開始する前に
* お勧めします link:prepare.html["アップグレードを準備"]。
* お勧めします link:download-software-image.html["ONTAPソフトウェアイメージのダウンロード"] （ターゲットのONTAPリリース用）。
* HA ペアごとに、 1 つ以上のポートが各ノードの同じブロードキャストドメインに必要です。
+
ノードが8つ以上ある場合は、無停止自動アップグレードでバッチアップグレード方式が使用されます。  ONTAP 9.7 以前では、バッチ方式を使用する場合に、アップグレードするノードの HA パートナーに LIF が移行されます。  パートナーの同じブロードキャストドメインにポートがない場合は、 LIF の移行が失敗します。

+
ONTAP 9.8以降では、バッチ方式を使用している場合に、LIFが他のバッチグループに移行されます。

* を実行する場合 link:https://docs.netapp.com/us-en/ontap/upgrade/concept_upgrade_paths.html#types-of-upgrade-paths["直接マルチホップアップグレード"]で、特定の環境に必要な正しい両方のONTAP イメージを取得しておく必要があります link:https://docs.netapp.com/us-en/ontap/upgrade/concept_upgrade_paths.html#supported-upgrade-paths["アップグレードパス"]。
* MetroCluster FC構成でONTAPをアップグレードする場合は、クラスタで自動計画外スイッチオーバーを有効にする必要があります。



NOTE: の設定の変更 `storage failover modify-auto-giveback` 自動無停止アップグレード（ANDU）の開始前のコマンドオプションは、アップグレードプロセスに影響しません。ANDU プロセスは、更新に必要なテイクオーバー / ギブバックの実行時に、このオプションに設定されている値を無視します。たとえば、を設定します `-autogiveback` ANDUを開始する前にfalseに設定すると、ギブバックの前に自動アップグレードが中断されません。



== 手順1：ターゲットのONTAPソフトウェアイメージをクラスタパッケージリポジトリにロードする

ONTAPソフトウェアのアップグレードプロセスを開始するには、ターゲットのONTAPソフトウェアイメージをクラスタパッケージリポジトリに格納しておく必要があります。

.手順
. 以前の ONTAP ソフトウェアパッケージを削除します。
+
[source, cli]
----
cluster image package delete -version previous_ONTAP_Version
----
. ターゲットのONTAPソフトウェアイメージをクラスタパッケージリポジトリにロードします。
+
[source, cli]
----
cluster image package get -url location
----
+
[listing]
----
cluster1::> cluster image package get -url http://www.example.com/software/9.13.1/image.tgz

Package download completed.
Package processing completed.
----
+
を実行する場合 link:https://docs.netapp.com/us-en/ontap/upgrade/concept_upgrade_paths.html#types-of-upgrade-paths["直接マルチホップアップグレード"]の場合は、アップグレードに必要な中間バージョンのONTAP用のソフトウェアパッケージもロードする必要があります。たとえば、9.8から9.13.1にアップグレードする場合は、ONTAP 9.12.1のソフトウェアパッケージをロードしてから、同じコマンドを使用して9.13.1のソフトウェアパッケージをロードする必要があります。

. ソフトウェアパッケージがクラスタパッケージリポジトリにあることを確認します。
+
[source, cli]
----
cluster image package show-repository
----
+
[listing]
----
cluster1::> cluster image package show-repository
Package Version  Package Build Time
---------------- ------------------
9.13.1              MM/DD/YYYY 10:32:15
----




== ステップ2：アップグレード前チェックを自動化

必要に応じて、ONTAPソフトウェアの自動アップグレードを実行する前に、 `cluster image validate` コマンドを使用して、クラスタを正常にアップグレードできることを確認します。  。 `cluster image validate` コマンドを実行すると、クラスタコンポーネントに対して一連のチェックが実行され、実行された検証のリストと、アップグレードの続行前に実施する必要がある対処方法のリストが表示されます。

. アップグレード前の自動チェックを実行します。
+
[source, cli]
----
cluster image validate -version package_version_number
----
+
** を実行する場合 link:https://docs.netapp.com/us-en/ontap/upgrade/concept_upgrade_paths.html#types-of-upgrade-paths["直接マルチホップアップグレード"]を使用して、ターゲットのONTAPパッケージを検証します。  中間アップグレードイメージを個別に検証する必要はありません。  たとえば、9.8から9.13.1にアップグレードする場合は、9.13.1パッケージを検証に使用する必要があります。9.12.1パッケージを個別に検証する必要はありません。
** 2 ノードまたは 4 ノードの MetroCluster 構成をアップグレードする場合は、続行する前に両方のクラスタでこのコマンドを実行する必要があります。
+
[listing]
----
cluster1::> cluster image validate -version 9.13.1

WARNING: There are additional manual upgrade validation checks that must be performed after these automated validation checks have completed...
----


. 検証の進捗を監視します。
+
[source, cli]
----
cluster image show-update-progress
----
. 検証で特定された必要なアクションをすべて完了します。




== 手順3：ONTAPソフトウェアをアップグレードする

. ソフトウェアアップグレードの見積もりを生成します。
+
[source, cli]
----
cluster image update -version package_version_number -estimate-only
----
+
ソフトウェアアップグレードの見積もりには、更新対象の各コンポーネントの詳細とアップグレードの推定期間が表示されます。

. ソフトウェアのアップグレードを実行します。
+
[source, cli]
----
cluster image update -version package_version_number
----
+
** を実行する場合 link:https://docs.netapp.com/us-en/ontap/upgrade/concept_upgrade_paths.html#types-of-upgrade-paths["直接マルチホップアップグレード"]package_version_numberには、ターゲットのONTAPバージョンを使用します。たとえば、ONTAP 9.8から9.13.1にアップグレードする場合は、package_version_numberに9.13.1を使用します。
** クラスタが 2~6 つのノードで構成されている場合は、ローリングアップグレードが実行されます。クラスタが 8 つ以上のノードで構成されている場合は、バッチアップグレードがデフォルトで実行されます。必要に応じて、を使用できます `-force-rolling` 代わりにローリングアップグレードを指定するパラメータ。
** テイクオーバーとギブバックがそれぞれ完了したら、テイクオーバーとギブバックの際に発生する I/O の中断からクライアントアプリケーションが回復できるように 8 分間待機します。クライアントが安定するために必要な時間が増減する場合は、を使用します `-stabilize-minutes` 別の待機時間を指定するパラメータ。
** 2 ノード MetroCluster システムを除く MetroCluster 構成では、ユーザが開始してコマンドラインで確認を行うと、 ONTAP のアップグレードプロセスが両方のサイト（ローカルサイトとディザスタリカバリサイト）の HA ペアで同時に開始されます。2 ノード MetroCluster システムの場合は、最初にディザスタリカバリサイト、つまりアップグレードが開始されないサイトで更新が開始されます。ディザスタリカバリサイトで更新が完了すると、ローカルサイトでアップグレードが開始されます。
+
[listing]
----
cluster1::> cluster image update -version 9.13.1

Starting validation for this update. Please wait..

It can take several minutes to complete validation...

WARNING: There are additional manual upgrade validation checks...

Pre-update Check      Status     Error-Action
--------------------- ---------- --------------------------------------------
...
20 entries were displayed

Would you like to proceed with update ? {y|n}: y
Starting update...

cluster-1::>
----


. クラスタの更新の進捗を表示します。
+
[source, cli]
----
cluster image show-update-progress
----
+
4ノードまたは8ノードのMetroCluster 構成をアップグレードする場合は、を参照してください `cluster image show-update-progress` コマンドは、コマンドを実行するノードの進捗状況のみを表示します。個々のノードの進捗を確認するには、各ノードでコマンドを実行する必要があります。

. 各ノードでアップグレードが正常に完了したことを確認します。
+
[source, cli]
----
cluster image show-update-progress
----
+
[listing]
----
cluster1::> cluster image show-update-progress

                                             Estimated         Elapsed
Update Phase         Status                   Duration        Duration
-------------------- ----------------- --------------- ---------------
Pre-update checks    completed                00:10:00        00:02:07
Data ONTAP updates   completed                01:31:00        01:39:00
Post-update checks   completed                00:10:00        00:02:00
3 entries were displayed.

Updated nodes: node0, node1.
----
. AutoSupport 通知を送信します。
+
[source, cli]
----
autosupport invoke -node * -type all -message "Finishing_NDU"
----
+
AutoSupport メッセージを送信するようにクラスタが設定されていない場合は、通知のコピーがローカルに保存されます。

. クラスタで自動計画外スイッチオーバーが有効になっていることを確認します。
+

NOTE: この手順は、MetroCluster FC構成に対してのみ実行します。  MetroCluster IP設定を使用している場合は、この手順を実行する必要はありません。

+
.. 自動計画外スイッチオーバーが有効かどうかを確認します。
+
[source, cli]
----
metrocluster show
----
+
自動計画外スイッチオーバーが有効な場合、コマンド出力に次のステートメントが表示されます。

+
....
AUSO Failure Domain    auso-on-cluster-disaster
....
.. 出力にステートメントが表示されない場合は、自動計画外スイッチオーバーを有効にします。
+
[source, cli]
----
metrocluster modify -auto-switchover-failure-domain auso-on-cluster-disaster -overide-vetoes true
----
+

NOTE: 自動無停止アップグレードが完了するまで、スイッチバック処理を実行できません。

.. 自動計画外スイッチオーバーが有効になっていることを確認します。
+
[source, cli]
----
metrocluster show
----




.関連情報
* https://aiq.netapp.com/["Active IQ を起動します"]
* https://docs.netapp.com/us-en/active-iq/["Active IQ のドキュメント"]

