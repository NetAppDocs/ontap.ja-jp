---
sidebar: sidebar 
permalink: upgrade/task_upgrade_andu_cli.html 
keywords: netapp, ontap, upgrade, nondisruptive, nondisruptively, non-disruptive update, nondisruptive upgrade, upgrade a cluster, shift workload between clusters, hardware platform, configuration, software image, update, update ONTAP, update software, ndu 
summary: クラスタの ONTAP のバージョンは無停止で更新できます。 
---
= CLI を使用した自動無停止アップグレード
:toc: macro
:hardbreaks:
:toclevels: 1
:toc: 
:toclevels: 1
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/
:toc-position: content


[role="lead"]
コマンドラインインターフェイス（ CLI ）を使用して、クラスタを無停止でアップグレードできることを確認し、各ノードにターゲット ONTAP イメージをインストールし、その後バックグラウンドでアップグレードを実行することができます。

アップグレードプロセスの進捗状況を監視しない場合は、を推奨します xref:task_requesting_notification_of_issues_encountered_in_nondisruptive_upgrades.html[手動操作が必要なエラーに関する EMS 通知を要求します]。

* アップグレード前の必要な準備作業を完了しておく必要があります。
* HA ペアごとに、 1 つ以上のポートが各ノードの同じブロードキャストドメインに必要です。
+
バッチアップグレード中にノードのセットをアップグレードする場合は、 LIF が HA パートナーノードに移行されます。パートナーの同じブロードキャストドメインにポートがない場合は、 LIF の移行が失敗します。

* ONTAP 9.3 から 9.7 にアップグレードする場合は、 9.5 および 9.7 のソフトウェアイメージを取得しておく必要があります。
* ONTAP 9.5 から 9.6.1 にアップグレードする場合は、 9.7 および 9.6.1 のソフトウェアイメージを取得しておく必要があります。


cluster image validate コマンドは、クラスタコンポーネントをチェックして、アップグレードを無停止で完了できるかどうかを検証します。その後、各チェックのステータスと、ソフトウェアアップグレードの実行前に実施する必要があるアクションがある場合はそれも一緒に表示されます。


NOTE: 自動無停止アップグレード（ ANDU ）の開始前に storage failover modify -auto-giveback コマンドオプションの設定を変更しても、アップグレードプロセスには影響しません。ANDU プロセスは、更新に必要なテイクオーバー / ギブバックの実行時に、このオプションに設定されている値を無視します。たとえば、 ANDU を開始する前に -autogiveback を false に設定しても、ギブバックの前に自動アップグレードは中断されません。

. 以前の ONTAP ソフトウェア・パッケージを削除します :`cluster image package delete -version previous_ONTAP_Version`
. ターゲットの ONTAP ソフトウェアパッケージをダウンロードします。「 cluster image package get -url location 」
+

NOTE: ONTAP 9.3 から 9.7 にアップグレードする場合は、 ONTAP 9.5 のソフトウェアパッケージをダウンロードし、同じコマンドを使用して 9.7 のソフトウェアパッケージをダウンロードします。ONTAP 9.5 から 9.6.1 にアップグレードする場合は、 ONTAP 9.7 のソフトウェアパッケージをダウンロードし、同じコマンドを使用して 9.6.1 のソフトウェアパッケージをダウンロードします。

+
[listing]
----
cluster1::> cluster image package get -url http://www.example.com/software/9.7/image.tgz

Package download completed.
Package processing completed.
----
. クラスタパッケージリポジトリでソフトウェアパッケージが使用可能であることを確認します。「 cluster image package show-repository 」
+
[listing]
----
cluster1::> cluster image package show-repository
Package Version  Package Build Time
---------------- ------------------
9.7              MM/DD/YYYY 10:32:15
----
. クラスタを無停止でアップグレードする準備ができていることを確認します。 cluster image validate -version package_version_number
+
** 2 ノードまたは 4 ノードの MetroCluster 構成をアップグレードする場合は、続行する前に両方のクラスタでこのコマンドを実行する必要があります。
** ONTAP 9.3 から 9.7 にアップグレードする場合は、 9.7 のパッケージを使用して検証します。9.5 パッケージを別途検証する必要はありません。
** ONTAP 9.5 から 9.1.1 にアップグレードする場合は、検証に 9.9.1 パッケージを使用します。9.7 パッケージを別途検証する必要はありません。


+
[listing]
----
cluster1::> cluster image validate -version 9.7

WARNING: There are additional manual upgrade validation checks that must be performed after these automated validation checks have completed...
----
. 検証の進捗状況を監視します。「 cluster image show-update-progress
. 検証で特定された必要なアクションをすべて完了します。
. ソフトウェア・アップグレードの見積りを生成しますクラスタイメージ・アップデート・バージョン package_version_number -estimate-only を生成します
+
ソフトウェアアップグレードの見積もりには、更新対象の各コンポーネントの詳細とアップグレードの推定期間が表示されます。

. ソフトウェア・アップグレードを実行しますクラスタイメージ update -version package_version_number
+
** ONTAP 9.3 から 9.7 にアップグレードする場合は、上記のコマンドで 9.7 の package_version_number を使用します。
** ONTAP 9.5 から 9.1.1 にアップグレードする場合は、上記のコマンドで 9.9.1 package_version_number を使用します。
** 2 ノード MetroCluster システムを除くすべての MetroCluster 構成では、ユーザが確認を入力すると、両方のクラスタ（ディザスタリカバリクラスタと本番用クラスタ）でアップグレードプロセスが同時に開始されます。2 ノード MetroCluster システムの場合は、最初にディザスタリカバリサイト、つまりアップグレードが開始されないサイトで更新が開始されます。ディザスタリカバリサイトでの更新が完了すると、アップグレードは本番用サイトで開始されます。
** クラスタが 2~6 つのノードで構成されている場合は、ローリングアップグレードが実行されます。クラスタが 8 つ以上のノードで構成されている場合は、バッチアップグレードがデフォルトで実行されます。必要に応じて、 -force-rolling パラメータを使用して、代わりにローリングアップグレードを行うように指定できます。
** テイクオーバーとギブバックがそれぞれ完了したら、テイクオーバーとギブバックの際に発生する I/O の中断からクライアントアプリケーションが回復できるように 8 分間待機します。クライアントが安定するために必要な時間を調整する必要がある場合は、 -stabilize-minutes パラメータを使用して待機時間を変更できます。
+
[listing]
----
cluster1::> cluster image update -version 9.7

Starting validation for this update. Please wait..

It can take several minutes to complete validation...

WARNING: There are additional manual upgrade validation checks...

Pre-update Check      Status     Error-Action
--------------------- ---------- --------------------------------------------
...
20 entries were displayed

Would you like to proceed with update ? {y|n}: y
Starting update...

cluster-1::>
----


. クラスタの更新の進行状況を表示します。 cluster image show-update-progress
+

NOTE: 4 ノードまたは 8 ノードの MetroCluster 構成をアップグレードしている場合 'cluster image show-update-progress コマンドで表示されるのは ' コマンドを実行しているノードの進行状況だけです個々のノードの進捗を確認するには、各ノードでコマンドを実行する必要があります。

. 各ノードでアップグレードが正常に完了したことを確認します。
+
[listing]
----
cluster1::> cluster image show-update-progress

                                             Estimated         Elapsed
Update Phase         Status                   Duration        Duration
-------------------- ----------------- --------------- ---------------
Pre-update checks    completed                00:10:00        00:02:07
Data ONTAP updates   completed                01:31:00        01:39:00
Post-update checks   completed                00:10:00        00:02:00
3 entries were displayed.

Updated nodes: node0, node1.

cluster1::>
----
. AutoSupport 通知をトリガーします。 AutoSupport invoke -node * -type all -message "Finishing_NDU"
+
AutoSupport メッセージを送信するようにクラスタが設定されていない場合は、通知のコピーがローカルに保存されます





== 自動アップグレードプロセスでのエラー後にアップグレードを再開する（ CLI を使用）

[role="lead"]
エラーのために自動アップグレードが一時停止した場合は、エラーを解決して自動アップグレードを再開するか、または自動アップグレードをキャンセルしてプロセスを手動で完了することができます。自動アップグレードを続行する場合は、アップグレード手順を手動では実行しないでください。

アップグレードを手動で完了するには、 cluster image cancel-update コマンドを使用して自動化されたプロセスをキャンセルし、手動で続行します。自動アップグレードを続行する場合は、次の手順を実行します。

. アップグレード・エラーを表示します： cluster image show-update-progress
. エラーを解決します。
. 更新を再開します : cluster image resume-update


* 関連情報 *

https://aiq.netapp.com/["Active IQ を起動します"]

https://docs.netapp.com/us-en/active-iq/["Active IQ のドキュメント"]
